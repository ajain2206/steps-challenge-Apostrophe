<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apostrophe - Jan 2026 - Community Steps Challenge</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        /* One-time bounce animation that auto-stops */
        @keyframes bounceIn {
            0% {
                transform: scale(0.3);
                opacity: 0;
            }
            50% {
                transform: scale(1.05);
            }
            70% {
                transform: scale(0.9);
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        .bounce-once {
            animation: bounceIn 0.6s ease-out;
        }
        
        /* Badge Styles */
        .badge-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 12px;
            border-radius: 12px;
            text-align: center;
            transition: transform 0.2s;
        }
        .badge-card:hover {
            transform: scale(1.05);
        }
        .badge-icon {
            font-size: 48px;
            margin-bottom: 8px;
        }
        .badge-name {
            font-size: 11px;
            font-weight: bold;
            margin-bottom: 4px;
        }
        .badge-desc {
            font-size: 9px;
            color: #666;
        }
        .badge-gold {
            border: 2px solid #FFD700;
            background: linear-gradient(135deg, #FFF8DC, #FFE7BA);
        }
        .badge-silver {
            border: 2px solid #C0C0C0;
            background: linear-gradient(135deg, #F5F5F5, #E0E0E0);
        }
        .badge-bronze {
            border: 2px solid #CD7F32;
            background: linear-gradient(135deg, #FFE4B5, #F4A460);
        }
        .badge-green {
            border: 2px solid #32CD32;
            background: linear-gradient(135deg, #F0FFF0, #C1FFC1);
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-2 sm:p-4">
    <div class="max-w-6xl mx-auto">
        <!-- Challenge Complete Banner -->
        <div class="bg-gradient-to-r from-green-500 to-blue-600 text-white rounded-lg shadow-xl p-6 sm:p-8 mb-6 text-center">
            <h1 class="text-3xl sm:text-4xl md:text-5xl font-bold mb-2">
                üéâ CHALLENGE COMPLETE! üéâ
            </h1>
            <p class="text-lg sm:text-xl mb-1">Apostrophe Steps Challenge 2026</p>
            <p class="text-sm sm:text-base opacity-90">January 1 - 26, 2026 ‚Ä¢ Final Results</p>
        </div>

        <!-- Setup Notice -->
        <div id="setupNotice" class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 sm:p-4 mb-4 sm:mb-6">
            <p class="text-xs sm:text-sm text-yellow-800">
                ‚ö†Ô∏è <strong>Setup Required:</strong> Please update the SCRIPT_URL variable in this file with your Google Apps Script Web App URL.
            </p>
        </div>


        <!-- Stats Cards -->
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4 mb-4 sm:mb-6">
            <div class="bg-white rounded-lg shadow-lg p-4 sm:p-6 border-l-4 border-blue-500">
                <h3 class="text-gray-600 text-xs sm:text-sm font-medium">Total Community Steps</h3>
                <p id="totalSteps" class="text-2xl sm:text-3xl md:text-4xl font-bold text-blue-600 mt-1 sm:mt-2">0</p>
            </div>
            <div class="bg-white rounded-lg shadow-lg p-4 sm:p-6 border-l-4 border-green-500">
                <h3 class="text-gray-600 text-xs sm:text-sm font-medium">Registered Participants</h3>
                <p id="totalParticipants" class="text-2xl sm:text-3xl md:text-4xl font-bold text-green-600 mt-1 sm:mt-2">0</p>
            </div>
        </div>

        <!-- 20 Million Goal Progress -->
        <div class="bg-white rounded-lg shadow-lg p-4 sm:p-6 mb-4 sm:mb-6">
            <div class="flex items-center justify-between mb-2">
                <h3 class="text-sm sm:text-base md:text-lg font-bold text-gray-800">üéØ Goal: 20M Steps</h3>
                <span id="goalPercentage" class="text-lg sm:text-xl md:text-2xl font-bold text-indigo-600">0%</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-4 sm:h-6 mb-2">
                <div id="goalProgress" class="bg-gradient-to-r from-blue-500 to-indigo-600 h-4 sm:h-6 rounded-full transition-all duration-500" style="width: 0%"></div>
            </div>
            <div class="flex items-center justify-between text-xs sm:text-sm text-gray-600">
                <span id="goalCurrent">0 steps</span>
                <span id="goalRemaining">20,000,000 to go!</span>
            </div>
        </div>

        <!-- Fun Stats Section -->
        <div class="bg-white rounded-lg shadow-lg p-4 sm:p-6 mb-4 sm:mb-6">
            <h3 class="text-base sm:text-lg font-bold text-gray-800 mb-3 sm:mb-4">üéØ We've Walked:</h3>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-3 sm:gap-4">
                <!-- Distance -->
                <div class="bg-blue-50 rounded-lg p-3 sm:p-4 border border-blue-100">
                    <div class="text-xl sm:text-2xl mb-1">üåç</div>
                    <div id="statDistance" class="text-lg sm:text-2xl font-bold text-blue-600 mb-1">0 km</div>
                    <div class="text-xs sm:text-sm text-gray-600">Distance Covered</div>
                </div>
                
                <!-- Society Loops -->
                <div class="bg-purple-50 rounded-lg p-3 sm:p-4 border border-purple-100">
                    <div class="text-xl sm:text-2xl mb-1">üèòÔ∏è</div>
                    <div id="statLoops" class="text-lg sm:text-2xl font-bold text-purple-600 mb-1">0</div>
                    <div class="text-xs sm:text-sm text-gray-600">Loops of Apostrophe</div>
                </div>
                
                <!-- India Journey -->
                <div class="bg-orange-50 rounded-lg p-3 sm:p-4 border border-orange-100">
                    <div class="text-xl sm:text-2xl mb-1">üáÆüá≥</div>
                    <div id="statIndia" class="text-lg sm:text-2xl font-bold text-orange-600 mb-1">0%</div>
                    <div class="text-xs sm:text-sm text-gray-600">Mumbai ‚Üí Delhi</div>
                </div>
                
                <!-- Calories -->
                <div class="bg-red-50 rounded-lg p-3 sm:p-4 border border-red-100">
                    <div class="text-xl sm:text-2xl mb-1">üî•</div>
                    <div id="statCalories" class="text-lg sm:text-2xl font-bold text-red-600 mb-1">0</div>
                    <div class="text-xs sm:text-sm text-gray-600">Calories Burned</div>
                </div>
                
                <!-- Trees Planted -->
                <div class="bg-green-50 rounded-lg p-3 sm:p-4 border border-green-100">
                    <div class="text-xl sm:text-2xl mb-1">üå≥</div>
                    <div id="statTrees" class="text-lg sm:text-2xl font-bold text-green-600 mb-1">0</div>
                    <div class="text-xs sm:text-sm text-gray-600">Trees Equivalent</div>
                </div>
                
                <!-- To Space -->
                <div class="bg-indigo-50 rounded-lg p-3 sm:p-4 border border-indigo-100">
                    <div class="text-xl sm:text-2xl mb-1">üöÄ</div>
                    <div id="statSpace" class="text-lg sm:text-2xl font-bold text-indigo-600 mb-1">0√ó</div>
                    <div class="text-xs sm:text-sm text-gray-600">To Space (100km)</div>
                </div>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div id="loadingIndicator" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-4 sm:p-6 flex items-center gap-3 mx-4">
                <div class="animate-spin rounded-full h-6 w-6 sm:h-8 sm:w-8 border-b-2 border-blue-600"></div>
                <span class="text-gray-700 text-sm sm:text-base">Processing...</span>
            </div>
        </div>

        <!-- Milestone Celebration Modal -->
        <div id="milestoneModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div id="milestoneCard" class="bg-white rounded-lg shadow-2xl p-6 sm:p-8 max-w-md mx-4 text-center">
                <div id="milestoneIcon" class="text-6xl sm:text-8xl mb-4">üéâ</div>
                <h2 id="milestoneTitle" class="text-2xl sm:text-3xl font-bold text-gray-800 mb-2">Milestone Reached!</h2>
                <p id="milestoneMessage" class="text-base sm:text-lg text-gray-600 mb-4"></p>
                <div id="milestoneStats" class="bg-blue-50 rounded-lg p-4 mb-6 text-left">
                    <!-- Stats will be inserted here -->
                </div>
                <button
                    onclick="closeMilestone()"
                    class="w-full bg-gradient-to-r from-blue-500 to-indigo-600 text-white py-3 px-6 rounded-lg hover:from-blue-600 hover:to-indigo-700 transition-all font-semibold text-lg"
                >
                    üéä Awesome! Keep Walking!
                </button>
            </div>
        </div>

        <!-- Registration Form -->
        <!-- Dashboard Section -->
        <div id="dashboard" class="hidden space-y-4 sm:space-y-6">
                <!-- Daily Steps Trend -->
                <div class="bg-white rounded-lg shadow-lg p-4 sm:p-6">
                    <h2 class="text-lg sm:text-xl md:text-2xl font-bold text-gray-800 mb-3 sm:mb-4">üìà Daily Community Steps</h2>
                    <div class="h-64 sm:h-80">
                        <canvas id="dailyStepsChart"></canvas>
                    </div>
                    
                    <!-- Daily Stats Summary -->
                    <div id="dailyStatsPanel" class="mt-4 p-3 sm:p-4 bg-gray-50 rounded-lg border border-gray-200">
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                            <div class="text-center">
                                <p class="text-xs text-gray-600">Today's Steps</p>
                                <p id="todaySteps" class="text-lg sm:text-xl font-bold text-blue-600">-</p>
                            </div>
                            <div class="text-center">
                                <p class="text-xs text-gray-600">Running Average</p>
                                <p id="runningAvg" class="text-lg sm:text-xl font-bold text-green-600">-</p>
                            </div>
                            <div class="text-center">
                                <p class="text-xs text-gray-600">Daily Target</p>
                                <p id="dailyTarget" class="text-lg sm:text-xl font-bold text-red-600">-</p>
                            </div>
                        </div>
                        <div id="dailyStatus" class="mt-3 text-center text-sm font-medium">
                            <!-- Status message will be inserted here -->
                        </div>
                    </div>
                </div>

                <!-- Daily Participation Chart -->
                <div class="bg-white rounded-lg shadow-lg p-4 sm:p-6">
                    <h2 class="text-lg sm:text-xl md:text-2xl font-bold text-gray-800 mb-3 sm:mb-4">üë• Daily Participation - Who's Logging Steps?</h2>
                    <div class="h-64 sm:h-80">
                        <canvas id="dailyParticipationChart"></canvas>
                    </div>
                    
                    <!-- Participation Stats Summary -->
                    <div id="participationStatsPanel" class="mt-4 p-3 sm:p-4 bg-blue-50 rounded-lg border border-blue-200">
                        <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
                            <div class="text-center">
                                <p class="text-xs text-gray-600">Average Daily</p>
                                <p id="avgParticipants" class="text-base sm:text-lg font-bold text-blue-600">-</p>
                                <p id="avgPercentage" class="text-xs text-gray-500">-</p>
                            </div>
                            <div class="text-center">
                                <p class="text-xs text-gray-600">Best Day</p>
                                <p id="bestDay" class="text-base sm:text-lg font-bold text-green-600">-</p>
                                <p id="bestDayCount" class="text-xs text-gray-500">-</p>
                            </div>
                            <div class="text-center">
                                <p class="text-xs text-gray-600">Lowest Day</p>
                                <p id="lowestDay" class="text-base sm:text-lg font-bold text-orange-600">-</p>
                                <p id="lowestDayCount" class="text-xs text-gray-500">-</p>
                            </div>
                            <div class="text-center">
                                <p class="text-xs text-gray-600">Yesterday</p>
                                <p id="yesterdayParticipants" class="text-base sm:text-lg font-bold text-purple-600">-</p>
                                <p id="yesterdayPercentage" class="text-xs text-gray-500">-</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Participant Leaderboard with Tabs -->
                <div class="bg-white rounded-lg shadow-lg p-4 sm:p-6">
                    <h2 class="text-lg sm:text-xl md:text-2xl font-bold text-gray-800 mb-3 sm:mb-4">üèÜ Participant Leaderboard</h2>
                    
                    <!-- Tabs -->
                    <div class="flex border-b border-gray-200 mb-4">
                        <button
                            id="cumulativeTab"
                            onclick="switchLeaderboardTab('cumulative')"
                            class="px-4 sm:px-6 py-2 sm:py-3 text-sm sm:text-base font-medium border-b-2 border-blue-600 text-blue-600"
                        >
                            Cumulative
                        </button>
                        <button
                            id="daywiseTab"
                            onclick="switchLeaderboardTab('daywise')"
                            class="px-4 sm:px-6 py-2 sm:py-3 text-sm sm:text-base font-medium border-b-2 border-transparent text-gray-600 hover:text-gray-800"
                        >
                            Day-wise
                        </button>
                    </div>

                    <!-- Cumulative View -->
                    <div id="cumulativeView">
                        <!-- Sort and Filter Options -->
                        <div class="flex flex-col sm:flex-row gap-2 sm:gap-4 mb-4">
                            <div class="flex-1">
                                <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1">Sort by:</label>
                                <select
                                    id="sortBy"
                                    onchange="loadLeaderboard()"
                                    class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                >
                                    <option value="steps">Total Steps (High to Low)</option>
                                    <option value="avgDaily">Avg Daily Steps (High to Low)</option>
                                    <option value="name">Name (A-Z)</option>
                                    <option value="flat">Flat Number</option>
                                </select>
                            </div>
                            <div class="flex-1">
                                <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1">Search:</label>
                                <input
                                    type="text"
                                    id="searchParticipant"
                                    onkeyup="loadLeaderboard()"
                                    placeholder="Search by name or flat..."
                                    class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                />
                            </div>
                        </div>

                        <!-- All Participants List -->
                        <div id="allParticipants" class="space-y-2 max-h-96 overflow-y-auto">
                            <p class="text-gray-500 text-center py-4 text-sm sm:text-base">Loading...</p>
                        </div>
                        
                        <p id="participantCount" class="text-xs sm:text-sm text-gray-600 mt-3 text-center"></p>
                    </div>

                    <!-- Day-wise View -->
                    <div id="daywiseView" class="hidden">
                        <!-- Participant Selector -->
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Select Participant:</label>
                            <select
                                id="daywiseParticipantSelect"
                                onchange="loadDaywiseData()"
                                class="w-full px-3 sm:px-4 py-2 sm:py-3 text-sm sm:text-base border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            >
                                <option value="">-- Select a participant --</option>
                            </select>
                        </div>

                        <!-- Day-wise Data Display -->
                        <div id="daywiseData">
                            <p class="text-gray-500 text-center py-8 text-sm sm:text-base">Select a participant to see their daily breakdown</p>
                        </div>

                        <!-- Navigation -->
                        <div class="flex justify-between mt-4">
                            <button
                                id="prevParticipant"
                                onclick="navigateParticipant(-1)"
                                class="px-4 py-2 text-sm bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed"
                                disabled
                            >
                                ‚¨ÖÔ∏è Previous
                            </button>
                            <button
                                id="nextParticipant"
                                onclick="navigateParticipant(1)"
                                class="px-4 py-2 text-sm bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed"
                                disabled
                            >
                                Next ‚û°Ô∏è
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Building Chart (Full Width) -->
                <!-- Building Statistics Table with Infographics -->
                <div class="bg-white rounded-lg shadow-lg p-4 sm:p-6 mb-4 sm:mb-6">
                    <h2 class="text-base sm:text-lg md:text-xl font-bold text-gray-800 mb-3 sm:mb-4">üè¢ Building Statistics</h2>
                    <div id="buildingStatsTable" class="overflow-x-auto">
                        <!-- Table will be generated dynamically -->
                    </div>
                </div>

                <!-- Age and Gender Charts (Side by Side) -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6">
                    <div class="bg-white rounded-lg shadow-lg p-4 sm:p-6">
                        <h2 class="text-base sm:text-lg md:text-xl font-bold text-gray-800 mb-3 sm:mb-4">üìä Steps by Age Group & Gender</h2>
                        
                        <!-- Desktop: Grouped Bar Chart -->
                        <div class="hidden md:block h-64">
                            <canvas id="ageChart"></canvas>
                        </div>
                        
                        <!-- Mobile: Table with Progress Bars -->
                        <div id="ageGenderTable" class="block md:hidden">
                            <!-- Table will be generated dynamically -->
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow-lg p-4 sm:p-6">
                        <h2 class="text-base sm:text-lg md:text-xl font-bold text-gray-800 mb-3 sm:mb-4">Steps by Gender</h2>
                        <div class="h-64">
                            <canvas id="genderChart"></canvas>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- User Selector Section -->
        <div id="userSelectorSection" class="hidden mt-8">
            <div class="bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg shadow-xl p-8 text-center">
                <h2 class="text-2xl sm:text-3xl font-bold mb-3">üéØ GET YOUR PERSONAL SUMMARY üéØ</h2>
                <p class="text-sm sm:text-base opacity-90 mb-6">Select your name to view your personal stats and achievements!</p>
                
                <div class="bg-white rounded-lg p-6 max-w-2xl mx-auto">
                    <label class="block text-left text-gray-700 font-semibold mb-2">Select Participant:</label>
                    <select id="userSelector" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-gray-800 text-base">
                        <option value="">-- Choose your name --</option>
                    </select>
                    
                    <button
                        onclick="generatePersonalSummary()"
                        class="mt-6 w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white px-8 py-4 rounded-lg shadow-lg hover:shadow-xl transition-all text-lg font-bold disabled:opacity-50 disabled:cursor-not-allowed"
                        id="generateBtn"
                        disabled
                    >
                        üéä GENERATE MY SUMMARY üéä
                    </button>
                </div>
            </div>
        </div>

        <!-- Individual Summary Section (Hidden Initially) -->
        <div id="individualSummary" class="hidden mt-8 space-y-6">
            <!-- Content will be populated dynamically -->
        </div>

    </div>

    <script>
        // ‚ö†Ô∏è IMPORTANT: Replace this URL with your Google Apps Script Web App URL
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwdAp6QU0QXqnf2h3C6EikTf5NMOBBt73q9RJKmhLK9gHufKjevrzHHjkHvqy2Mtrvg/exec';

        let ageChart = null;
        let genderChart = null;
        let buildingChart = null;
        let dailyStepsChart = null;
        let cachedData = null;

        const GOAL_STEPS = 20000000; // 20 million steps goal

        // Helper function to create unique key from name and flat number
        function createUniqueKey(name, flatNo) {
            return (name.toUpperCase().trim() + '_' + flatNo).replace(/\s+/g, '_');
        }

        // Show/hide loading indicator
        function showLoading(show) {
            document.getElementById('loadingIndicator').classList.toggle('hidden', !show);
        }

        // Show view

        // Fetch data from Google Sheets
        async function fetchData() {
            console.log('Fetching data from:', SCRIPT_URL);
            try {
                const response = await fetch(SCRIPT_URL);
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Data received:', data);
                
                if (data.success) {
                    cachedData = data;
                    console.log('Profiles loaded:', data.profiles.length);
                    console.log('Step entries loaded:', data.steps.length);
                    return data;
                } else {
                    throw new Error(data.message || 'Failed to fetch data - success=false');
                }
            } catch (error) {
                console.error('Error fetching data:', error);
                alert(`Error loading data:\n${error.message}\n\nPlease check:\n1. SCRIPT_URL is correct\n2. Google Apps Script is deployed\n3. Script has proper permissions\n\nCheck browser console for details.`);
                return null;
            }
        }

        // Send data to Google Sheets
        async function sendData(action, payload) {
            try {
                showLoading(true);
                
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain',
                    },
                    body: JSON.stringify({
                        action: action,
                        ...payload
                    })
                });
                
                const data = await response.json();
                showLoading(false);
                
                return data;
            } catch (error) {
                showLoading(false);
                console.error('Error sending data:', error);
                return {
                    success: false,
                    message: 'Error connecting to server. Please try again.'
                };
            }
        }

        // Show status message (kept for compatibility)
        function showStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = message;
                element.className = `text-sm mt-4 text-center ${type === 'success' ? 'text-green-600' : 'text-red-600'}`;
            }
        }

        // Get age group
        function getAgeGroup(age) {
            if (age < 18) return 'Under 18';
            if (age <= 30) return '18-30';
            if (age <= 45) return '31-45';
            if (age <= 60) return '46-60';
            return 'Over 60';
        }

        // Load all data
        async function loadData() {
            const data = await fetchData();
            if (data) {
                updateStats(data);
            }
        }

        // Update stats
        function updateStats(data) {
            const totalSteps = data.steps.reduce((sum, entry) => sum + entry.steps, 0);
            
            document.getElementById('totalSteps').textContent = totalSteps.toLocaleString();
            document.getElementById('totalParticipants').textContent = data.profiles.length;
            
            // Update goal progress - show actual percentage (not capped at 100%)
            const percentage = (totalSteps / GOAL_STEPS) * 100;
            const remaining = GOAL_STEPS - totalSteps;
            
            document.getElementById('goalPercentage').textContent = percentage.toFixed(1) + '%';
            // Progress bar visual is capped at 100% for display, but percentage shows actual
            document.getElementById('goalProgress').style.width = Math.min(100, percentage) + '%';
            document.getElementById('goalCurrent').textContent = totalSteps.toLocaleString() + ' steps';
            
            if (remaining > 0) {
                document.getElementById('goalRemaining').textContent = remaining.toLocaleString() + ' to go!';
                document.getElementById('goalRemaining').className = 'text-gray-600';
            } else {
                // Goal exceeded - show how much over
                const exceeded = totalSteps - GOAL_STEPS;
                const exceededPercent = ((exceeded / GOAL_STEPS) * 100).toFixed(1);
                document.getElementById('goalRemaining').textContent = `üéâ Goal Exceeded by ${exceeded.toLocaleString()} steps (+${exceededPercent}%)!`;
                document.getElementById('goalRemaining').className = 'text-green-600 font-bold';
            }
            
            // Update fun stats
            updateFunStats(totalSteps);
            
            // Check for milestone celebrations
            checkMilestones(totalSteps);
            
            // Note: No longer calling populateParticipantDropdown - that was for the old submit form
        }

        // Load leaderboard (all participants with sort and filter)
        function loadLeaderboard() {
            if (!window.dashboardData) return;
            
            const { participantSteps, profileMap, steps } = window.dashboardData;
            
            // Get all participants
            let allParticipants = Object.entries(participantSteps)
                .map(([uniqueKey, totalSteps]) => {
                    const completion = calculateCompletion(uniqueKey, steps);
                    return {
                        uniqueKey: uniqueKey,
                        flatNo: profileMap[uniqueKey]?.flatNo || 'Unknown',
                        name: profileMap[uniqueKey]?.name || 'Unknown',
                        steps: totalSteps,
                        ...completion
                    };
                });
            
            // Apply search filter
            const searchTerm = document.getElementById('searchParticipant')?.value.toLowerCase() || '';
            if (searchTerm) {
                allParticipants = allParticipants.filter(p => 
                    p.name.toLowerCase().includes(searchTerm) || 
                    p.flatNo.toLowerCase().includes(searchTerm)
                );
            }
            
            // Calculate average daily for each participant
            allParticipants = allParticipants.map(entry => ({
                ...entry,
                avgDaily: entry.daysSubmitted > 0 ? Math.round(entry.steps / entry.daysSubmitted) : 0
            }));
            
            // Apply sorting
            const sortBy = document.getElementById('sortBy')?.value || 'steps';
            if (sortBy === 'steps') {
                allParticipants.sort((a, b) => b.steps - a.steps);
            } else if (sortBy === 'avgDaily') {
                allParticipants.sort((a, b) => b.avgDaily - a.avgDaily);
            } else if (sortBy === 'name') {
                allParticipants.sort((a, b) => a.name.localeCompare(b.name));
            } else if (sortBy === 'flat') {
                allParticipants.sort((a, b) => a.flatNo.localeCompare(b.flatNo));
            }
            
            // Generate Desktop Table HTML
            const desktopTableHtml = allParticipants.length > 0
                ? `
                <div class="hidden md:block overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b-2 border-gray-300">
                                <th class="text-left py-3 px-2 text-sm font-bold text-gray-700">#</th>
                                <th class="text-left py-3 px-2 text-sm font-bold text-gray-700">Name</th>
                                <th class="text-left py-3 px-2 text-sm font-bold text-gray-700">Flat</th>
                                <th class="text-right py-3 px-2 text-sm font-bold text-gray-700">Total Steps</th>
                                <th class="text-center py-3 px-2 text-sm font-bold text-gray-700">Days</th>
                                <th class="text-right py-3 px-2 text-sm font-bold text-gray-700">Avg/Day</th>
                                <th class="text-left py-3 px-2 text-sm font-bold text-gray-700">Completion</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${allParticipants.map((entry, idx) => `
                                <tr class="border-b border-gray-200 hover:bg-gray-50 transition-colors">
                                    <td class="py-3 px-2 text-sm font-bold text-gray-400">${idx + 1}</td>
                                    <td class="py-3 px-2 text-sm font-semibold text-gray-800">${entry.name}</td>
                                    <td class="py-3 px-2 text-sm text-gray-600">${entry.flatNo}</td>
                                    <td class="py-3 px-2 text-sm font-bold text-blue-600 text-right">${entry.steps.toLocaleString()}</td>
                                    <td class="py-3 px-2 text-sm text-gray-700 text-center">${entry.daysSubmitted}</td>
                                    <td class="py-3 px-2 text-sm font-semibold text-gray-700 text-right">${entry.avgDaily.toLocaleString()}</td>
                                    <td class="py-3 px-2 text-xs">
                                        <span class="inline-flex items-center gap-1">
                                            <span>${entry.statusIcon}</span>
                                            <span class="${entry.statusColor} font-medium">${entry.daysSubmitted}/${entry.totalDays}</span>
                                            <span class="text-gray-500">(${entry.percentage}%)</span>
                                        </span>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                `
                : '<div class="hidden md:block"><p class="text-gray-500 text-center py-4 text-sm sm:text-base">No participants found</p></div>';
            
            // Generate Mobile Cards HTML
            const mobileCardsHtml = allParticipants.length > 0
                ? `
                <div class="block md:hidden space-y-2">
                    ${allParticipants.map((entry, idx) => `
                        <div class="bg-gray-50 rounded-lg p-3 hover:bg-gray-100 transition-colors">
                            <div class="flex items-start justify-between mb-2">
                                <div class="flex items-center gap-2">
                                    <span class="text-sm font-bold text-gray-400">#${idx + 1}</span>
                                    <div>
                                        <p class="font-semibold text-gray-800 text-sm">${entry.name}</p>
                                        <p class="text-xs text-gray-600">Flat ${entry.flatNo}</p>
                                    </div>
                                </div>
                                <p class="text-base font-bold text-blue-600">${entry.steps.toLocaleString()}</p>
                            </div>
                            <div class="flex items-center justify-between text-xs">
                                <div class="flex items-center gap-1 text-gray-700">
                                    <span class="font-medium">${entry.daysSubmitted} days</span>
                                    <span class="text-gray-400">‚Ä¢</span>
                                    <span class="font-semibold">${entry.avgDaily.toLocaleString()} avg/day</span>
                                </div>
                            </div>
                            <div class="mt-1 flex items-center gap-1">
                                <span class="text-base">${entry.statusIcon}</span>
                                <span class="text-xs ${entry.statusColor} font-medium">
                                    ${entry.daysSubmitted}/${entry.totalDays} days
                                </span>
                                <span class="text-xs text-gray-500">(${entry.percentage}%)</span>
                            </div>
                        </div>
                    `).join('')}
                </div>
                `
                : '<div class="block md:hidden"><p class="text-gray-500 text-center py-4 text-sm">No participants found</p></div>';
            
            document.getElementById('allParticipants').innerHTML = desktopTableHtml + mobileCardsHtml;
            document.getElementById('participantCount').textContent = 
                `Showing ${allParticipants.length} participant${allParticipants.length !== 1 ? 's' : ''}`;
            
            // Populate day-wise dropdown
            populateDaywiseDropdown(allParticipants);
        }

        // Calculate completion percentage and missing days
        function calculateCompletion(uniqueKey, allSteps) {
            // Get date range (Jan 1 to today)
            const startDate = new Date('2026-01-01');
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Generate all dates from start to today
            const allDates = [];
            let currentDate = new Date(startDate);
            while (currentDate <= today) {
                allDates.push(currentDate.toISOString().split('T')[0]);
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            // Get dates when user submitted steps
            const userSteps = allSteps.filter(s => {
                const stepKey = s.uniqueKey || createUniqueKey(s.name, s.flatNo);
                return stepKey === uniqueKey;
            });
            
            const submittedDates = new Set(
                userSteps.map(s => {
                    // Handle both Date objects and string dates
                    const dateStr = s.date instanceof Date 
                        ? s.date.toISOString().split('T')[0]
                        : (typeof s.date === 'string' ? s.date.split('T')[0] : s.date);
                    return dateStr;
                })
            );
            
            const totalDays = allDates.length;
            const daysSubmitted = submittedDates.size;
            const daysMissing = totalDays - daysSubmitted;
            const percentage = totalDays > 0 ? Math.round((daysSubmitted / totalDays) * 100) : 0;
            
            // Determine status
            let statusIcon, statusColor, statusText;
            if (percentage >= 90) {
                statusIcon = '‚úÖ';
                statusColor = 'text-green-600';
                statusText = 'Perfect!';
            } else if (percentage >= 70) {
                statusIcon = '‚úÖ';
                statusColor = 'text-green-600';
                statusText = 'Great!';
            } else if (percentage >= 50) {
                statusIcon = '‚ö†Ô∏è';
                statusColor = 'text-yellow-600';
                statusText = 'Good';
            } else if (percentage >= 30) {
                statusIcon = '‚ö†Ô∏è';
                statusColor = 'text-orange-600';
                statusText = 'Need push!';
            } else {
                statusIcon = '‚ùå';
                statusColor = 'text-red-600';
                statusText = 'Come back!';
            }
            
            return {
                totalDays,
                daysSubmitted,
                daysMissing,
                percentage,
                statusIcon,
                statusColor,
                statusText
            };
        }

        // Switch between cumulative and day-wise tabs
        function switchLeaderboardTab(tab) {
            const cumulativeTab = document.getElementById('cumulativeTab');
            const daywiseTab = document.getElementById('daywiseTab');
            const cumulativeView = document.getElementById('cumulativeView');
            const daywiseView = document.getElementById('daywiseView');
            
            if (tab === 'cumulative') {
                cumulativeTab.className = 'px-4 sm:px-6 py-2 sm:py-3 text-sm sm:text-base font-medium border-b-2 border-blue-600 text-blue-600';
                daywiseTab.className = 'px-4 sm:px-6 py-2 sm:py-3 text-sm sm:text-base font-medium border-b-2 border-transparent text-gray-600 hover:text-gray-800';
                cumulativeView.classList.remove('hidden');
                daywiseView.classList.add('hidden');
            } else {
                cumulativeTab.className = 'px-4 sm:px-6 py-2 sm:py-3 text-sm sm:text-base font-medium border-b-2 border-transparent text-gray-600 hover:text-gray-800';
                daywiseTab.className = 'px-4 sm:px-6 py-2 sm:py-3 text-sm sm:text-base font-medium border-b-2 border-blue-600 text-blue-600';
                cumulativeView.classList.add('hidden');
                daywiseView.classList.remove('hidden');
            }
        }

        // Populate day-wise participant dropdown
        function populateDaywiseDropdown(allParticipants) {
            const select = document.getElementById('daywiseParticipantSelect');
            if (!select) return;
            
            // Sort by name for dropdown
            const sorted = [...allParticipants].sort((a, b) => a.name.localeCompare(b.name));
            
            select.innerHTML = '<option value="">-- Select a participant --</option>' +
                sorted.map(p => 
                    `<option value="${p.uniqueKey}">${p.name} (${p.flatNo})</option>`
                ).join('');
        }

        // Load day-wise data for selected participant
        function loadDaywiseData() {
            const select = document.getElementById('daywiseParticipantSelect');
            const uniqueKey = select.value;
            
            if (!uniqueKey || !window.dashboardData) {
                document.getElementById('daywiseData').innerHTML = 
                    '<p class="text-gray-500 text-center py-8 text-sm sm:text-base">Select a participant to see their daily breakdown</p>';
                document.getElementById('prevParticipant').disabled = true;
                document.getElementById('nextParticipant').disabled = true;
                return;
            }
            
            const { profileMap, steps } = window.dashboardData;
            const profile = profileMap[uniqueKey];
            
            // Get all steps for this participant
            const participantSteps = steps.filter(entry => {
                const entryKey = entry.uniqueKey || createUniqueKey(entry.name, entry.flatNo);
                return entryKey === uniqueKey;
            });
            
            if (participantSteps.length === 0) {
                document.getElementById('daywiseData').innerHTML = 
                    '<p class="text-gray-500 text-center py-8 text-sm sm:text-base">No steps recorded yet</p>';
                return;
            }
            
            // Sort by date
            participantSteps.sort((a, b) => {
                const dateA = typeof a.date === 'string' ? a.date : a.date.toISOString();
                const dateB = typeof b.date === 'string' ? b.date : b.date.toISOString();
                return dateA.localeCompare(dateB);
            });
            
            // Calculate total and average
            const totalSteps = participantSteps.reduce((sum, entry) => sum + entry.steps, 0);
            const avgSteps = Math.round(totalSteps / participantSteps.length);
            
            // Generate table HTML
            const tableHtml = `
                <div class="mb-4">
                    <h3 class="text-base sm:text-lg font-bold text-gray-800 mb-2">
                        üìÖ Daily Steps for ${profile.name}
                    </h3>
                    <p class="text-xs sm:text-sm text-gray-600">Flat ${profile.flatNo}</p>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-100 border-b-2 border-gray-200">
                            <tr>
                                <th class="px-2 sm:px-4 py-2 text-left font-semibold text-gray-700">Date</th>
                                <th class="px-2 sm:px-4 py-2 text-right font-semibold text-gray-700">Steps</th>
                                <th class="px-2 sm:px-4 py-2 text-left font-semibold text-gray-700">vs Average</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            ${participantSteps.map(entry => {
                                // Parse date string properly
                                let formattedDate = '';
                                try {
                                    const dateStr = typeof entry.date === 'string' ? entry.date : entry.date.toISOString().split('T')[0];
                                    const parts = dateStr.split('-');
                                    
                                    if (parts.length === 3) {
                                        const year = parseInt(parts[0], 10);
                                        const month = parseInt(parts[1], 10);
                                        const day = parseInt(parts[2], 10);
                                        
                                        // Create date object with explicit numbers
                                        const d = new Date(year, month - 1, day);
                                        
                                        // Verify the date is valid
                                        if (!isNaN(d.getTime())) {
                                            formattedDate = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                                        } else {
                                            formattedDate = dateStr; // Fallback to original string
                                        }
                                    } else {
                                        formattedDate = dateStr; // Fallback to original string
                                    }
                                } catch (e) {
                                    formattedDate = 'Date Error';
                                }
                                
                                const percentage = Math.round((entry.steps / avgSteps) * 100);
                                const barWidth = Math.min(percentage, 100);
                                const barColor = percentage >= 100 ? 'bg-green-500' : percentage >= 75 ? 'bg-blue-500' : 'bg-yellow-500';
                                
                                return `
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-2 sm:px-4 py-2 text-gray-800">${formattedDate}</td>
                                        <td class="px-2 sm:px-4 py-2 text-right font-semibold text-gray-800">${entry.steps.toLocaleString()}</td>
                                        <td class="px-2 sm:px-4 py-2">
                                            <div class="flex items-center gap-2">
                                                <div class="flex-1 bg-gray-200 rounded-full h-2 max-w-[100px]">
                                                    <div class="${barColor} h-2 rounded-full" style="width: ${barWidth}%"></div>
                                                </div>
                                                <span class="text-xs text-gray-600">${percentage}%</span>
                                            </div>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                        <tfoot class="bg-gray-50 border-t-2 border-gray-200">
                            <tr>
                                <td class="px-2 sm:px-4 py-3 font-bold text-gray-800">Total</td>
                                <td class="px-2 sm:px-4 py-3 text-right font-bold text-blue-600">${totalSteps.toLocaleString()}</td>
                                <td class="px-2 sm:px-4 py-3 text-xs sm:text-sm text-gray-600">Avg: ${avgSteps.toLocaleString()}/day</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            `;
            
            document.getElementById('daywiseData').innerHTML = tableHtml;
            
            // Enable/disable navigation buttons
            updateNavigationButtons();
        }

        // Navigate to previous/next participant
        function navigateParticipant(direction) {
            const select = document.getElementById('daywiseParticipantSelect');
            const currentIndex = select.selectedIndex;
            const newIndex = currentIndex + direction;
            
            if (newIndex >= 0 && newIndex < select.options.length) {
                select.selectedIndex = newIndex;
                loadDaywiseData();
            }
        }

        // Update navigation button states
        function updateNavigationButtons() {
            const select = document.getElementById('daywiseParticipantSelect');
            const prevBtn = document.getElementById('prevParticipant');
            const nextBtn = document.getElementById('nextParticipant');
            
            if (!select.value) {
                prevBtn.disabled = true;
                nextBtn.disabled = true;
                return;
            }
            
            prevBtn.disabled = select.selectedIndex <= 1; // 0 is "Select a participant"
            nextBtn.disabled = select.selectedIndex >= select.options.length - 1;
        }

        // Load registered list

        // Load dashboard
        function loadDashboard() {
            if (!cachedData) return;
            
            const profiles = cachedData.profiles;
            const steps = cachedData.steps;

            let byAge = { 'Under 18': 0, '18-30': 0, '31-45': 0, '46-60': 0, 'Over 60': 0 };
            let byGender = { 'Male': 0, 'Female': 0, 'Other': 0 };
            let byAgeGender = {
                'Under 18': { 'Male': 0, 'Female': 0, 'Other': 0 },
                '18-30': { 'Male': 0, 'Female': 0, 'Other': 0 },
                '31-45': { 'Male': 0, 'Female': 0, 'Other': 0 },
                '46-60': { 'Male': 0, 'Female': 0, 'Other': 0 },
                'Over 60': { 'Male': 0, 'Female': 0, 'Other': 0 }
            };
            let byBuilding = {}; // Track by building
            let buildingParticipants = {}; // Track unique participants per building
            let participantSteps = {}; // Track by unique key (name + flat)
            let dailySteps = {}; // Track daily aggregate

            // Create a map of profiles by unique key
            const profileMap = {};
            profiles.forEach(profile => {
                const uniqueKey = profile.uniqueKey || createUniqueKey(profile.name, profile.flatNo);
                profileMap[uniqueKey] = profile;
            });

            // Calculate stats
            steps.forEach(entry => {
                const uniqueKey = entry.uniqueKey || createUniqueKey(entry.name, entry.flatNo);
                const profile = profileMap[uniqueKey];
                
                if (profile) {
                    participantSteps[uniqueKey] = (participantSteps[uniqueKey] || 0) + entry.steps;

                    const ageGroup = getAgeGroup(profile.age);
                    byAge[ageGroup] += entry.steps;
                    byGender[profile.gender] += entry.steps;
                    byAgeGender[ageGroup][profile.gender] += entry.steps;
                    
                    // Extract building from flat number (first character)
                    const building = profile.flatNo.charAt(0).toUpperCase();
                    byBuilding[building] = (byBuilding[building] || 0) + entry.steps;
                    
                    // Track unique participants per building
                    if (!buildingParticipants[building]) {
                        buildingParticipants[building] = new Set();
                    }
                    buildingParticipants[building].add(uniqueKey);
                    
                    // Aggregate by date
                    const dateKey = entry.date instanceof Date 
                        ? entry.date.toISOString().split('T')[0]
                        : (typeof entry.date === 'string' ? entry.date.split('T')[0] : entry.date);
                    
                    // DEBUG: Log first date processing
                    if (Object.keys(dailySteps).length === 0) {
                        console.log('DEBUG LoadDashboard - First entry date:', entry.date);
                        console.log('DEBUG LoadDashboard - Date type:', typeof entry.date);
                        console.log('DEBUG LoadDashboard - Date key:', dateKey);
                    }
                    
                    dailySteps[dateKey] = (dailySteps[dateKey] || 0) + entry.steps;
                }
            });

            // Store for use in leaderboard
            window.dashboardData = {
                participantSteps,
                profileMap,
                steps
            };

            // Load leaderboard (all participants)
            loadLeaderboard();

            // Update charts
            updateCharts(byAge, byGender, byAgeGender, byBuilding, buildingParticipants, dailySteps);
            
            // Update fun stats
            const totalSteps = Object.values(participantSteps).reduce((sum, steps) => sum + steps, 0);
            updateFunStats(totalSteps);
        }

        // Update charts
        function updateCharts(byAge, byGender, byAgeGender, byBuilding, buildingParticipants, dailySteps) {
            console.log('=== UPDATE CHARTS CALLED ===');
            console.log('Screen width:', window.innerWidth);
            console.log('Is mobile:', window.innerWidth < 768);
            
            // On mobile, add small delay to ensure DOM is ready
            const isMobile = window.innerWidth < 768;
            const renderDelay = isMobile ? 300 : 0;
            
            setTimeout(() => {
                console.log('Starting chart rendering (after', renderDelay, 'ms delay)');
                
                const ageData = Object.entries(byAge).filter(([_, steps]) => steps > 0);
                const genderData = Object.entries(byGender).filter(([_, steps]) => steps > 0);
                const buildingData = Object.entries(byBuilding).filter(([_, steps]) => steps > 0);
                
                console.log('Chart data:', {
                    ageData: ageData.length,
                    genderData: genderData.length,
                    buildingData: buildingData.length
                });

            // Sort building data alphabetically for consistent display
            buildingData.sort((a, b) => a[0].localeCompare(b[0]));
            
            // Calculate total days from start to today
            const startDate = new Date('2026-01-01');
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const totalDays = Math.ceil((today - startDate) / (1000 * 60 * 60 * 24)) + 1; // +1 to include start day
            
            console.log(`Total days in challenge: ${totalDays} (Jan 1 to ${today.toISOString().split('T')[0]})`);
            
            // Calculate building stats - all 5 metrics
            const buildingStats = {};
            buildingData.forEach(([building, totalSteps]) => {
                const participantCount = buildingParticipants[building] ? buildingParticipants[building].size : 0;
                
                // Metric 3: Daily Average Steps (building total per day)
                const dailyAvgSteps = totalDays > 0 ? Math.round(totalSteps / totalDays) : 0;
                
                // Metric 4: Participant Average Steps (total per person)
                const participantAvgSteps = participantCount > 0 ? Math.round(totalSteps / participantCount) : 0;
                
                // Metric 5: Daily Per Participant Average
                const dailyPerParticipantAvg = (participantCount > 0 && totalDays > 0) 
                    ? Math.round(totalSteps / (participantCount * totalDays)) 
                    : 0;
                
                buildingStats[building] = {
                    totalSteps: totalSteps,                       // Metric 1
                    participants: participantCount,                // Metric 2
                    dailyAvgSteps: dailyAvgSteps,                 // Metric 3
                    participantAvgSteps: participantAvgSteps,     // Metric 4
                    dailyPerParticipantAvg: dailyPerParticipantAvg // Metric 5
                };
                
                console.log(`Building ${building}: Total: ${totalSteps}, Participants: ${participantCount}, Daily avg: ${dailyAvgSteps}, Per participant: ${participantAvgSteps}, Daily per participant: ${dailyPerParticipantAvg}`);
            });

            // Daily steps chart with average and target
            const dailyCtx = document.getElementById('dailyStepsChart').getContext('2d');
            if (dailyStepsChart) dailyStepsChart.destroy();
            
            if (dailySteps && Object.keys(dailySteps).length > 0) {
                // Sort by date
                const sortedDaily = Object.entries(dailySteps).sort((a, b) => {
                    return new Date(a[0]) - new Date(b[0]);
                });
                
                // Get last 30 days or all available data
                const recentDaily = sortedDaily.slice(-30);
                
                // Calculate running average for each day
                const runningAverages = [];
                let cumulativeSteps = 0;
                recentDaily.forEach(([date, steps], index) => {
                    cumulativeSteps += steps;
                    const avg = Math.round(cumulativeSteps / (index + 1));
                    runningAverages.push(avg);
                });
                
                // Calculate DYNAMIC daily target based on remaining steps and days
                // Challenge runs from Jan 1 to Jan 26, 2026 (26 days)
                const CHALLENGE_START = new Date('2026-01-01');
                const CHALLENGE_END = new Date('2026-01-26');
                const TOTAL_CHALLENGE_DAYS = 26;
                
                const dynamicTargets = [];
                let cumulativeForTarget = 0;
                
                recentDaily.forEach(([dateStr, steps], index) => {
                    // Calculate cumulative steps up to (but not including) this day
                    // This represents what we had accomplished before this day started
                    
                    // Calculate which day of challenge this is (1-26)
                    const currentDate = new Date(dateStr);
                    const dayNumber = Math.floor((currentDate - CHALLENGE_START) / (1000 * 60 * 60 * 24)) + 1;
                    
                    // Calculate remaining steps and days BEFORE this day's steps were logged
                    const remainingSteps = GOAL_STEPS - cumulativeForTarget;
                    const remainingDays = TOTAL_CHALLENGE_DAYS - dayNumber + 1; // +1 because this day is included
                    
                    // Calculate what the target should be for this day
                    const targetForDay = remainingDays > 0 ? Math.round(remainingSteps / remainingDays) : 0;
                    dynamicTargets.push(targetForDay);
                    
                    // Add this day's steps to cumulative for next iteration
                    cumulativeForTarget += steps;
                });
                
                // Get the CURRENT daily target (today's target)
                const currentDailyTarget = dynamicTargets[dynamicTargets.length - 1];
                
                // Update stats panel
                const todaySteps = recentDaily[recentDaily.length - 1][1];
                const currentAvg = runningAverages[runningAverages.length - 1];
                
                document.getElementById('todaySteps').textContent = todaySteps.toLocaleString();
                document.getElementById('runningAvg').textContent = currentAvg.toLocaleString() + '/day';
                document.getElementById('dailyTarget').textContent = currentDailyTarget.toLocaleString() + '/day';
                
                // Calculate status message
                const vsAvg = todaySteps - currentAvg;
                const vsTarget = todaySteps - currentDailyTarget;
                let statusMsg = '';
                let statusClass = '';
                
                if (vsTarget >= 0 && vsAvg >= 0) {
                    statusMsg = `üü¢ Excellent! Today is +${vsAvg.toLocaleString()} vs average and +${vsTarget.toLocaleString()} vs target`;
                    statusClass = 'text-green-600';
                } else if (vsTarget >= 0) {
                    statusMsg = `‚úÖ Good! Above target by ${vsTarget.toLocaleString()} steps`;
                    statusClass = 'text-green-600';
                } else if (vsAvg >= 0) {
                    statusMsg = `üìä Above average by ${vsAvg.toLocaleString()}, but ${Math.abs(vsTarget).toLocaleString()} below target`;
                    statusClass = 'text-yellow-600';
                } else {
                    statusMsg = `‚ö†Ô∏è Below both average (${Math.abs(vsAvg).toLocaleString()}) and target (${Math.abs(vsTarget).toLocaleString()})`;
                    statusClass = 'text-red-600';
                }
                
                document.getElementById('dailyStatus').innerHTML = `<span class="${statusClass}">${statusMsg}</span>`;
                
                dailyStepsChart = new Chart(dailyCtx, {
                    type: 'bar',
                    data: {
                        labels: recentDaily.map(([date]) => {
                            // Parse date as local date to avoid timezone issues
                            const [year, month, day] = date.split('-').map(Number);
                            const d = new Date(year, month - 1, day);
                            const label = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                            
                            // DEBUG: Log first date to console
                            if (date === recentDaily[0][0]) {
                                console.log('DEBUG Chart - Raw date:', date);
                                console.log('DEBUG Chart - Parsed:', year, month, day);
                                console.log('DEBUG Chart - Date object:', d);
                                console.log('DEBUG Chart - Label:', label);
                            }
                            
                            return label;
                        }),
                        datasets: [
                            {
                                label: 'Daily Steps',
                                data: recentDaily.map(([_, steps]) => steps),
                                type: 'bar',
                                backgroundColor: 'rgba(59, 130, 246, 0.7)',
                                borderColor: 'rgb(59, 130, 246)',
                                borderWidth: 1,
                                order: 3
                            },
                            {
                                label: 'Running Average',
                                data: runningAverages,
                                type: 'line',
                                borderColor: 'rgb(34, 197, 94)',
                                backgroundColor: 'transparent',
                                borderWidth: 2,
                                pointRadius: 3,
                                pointBackgroundColor: 'rgb(34, 197, 94)',
                                tension: 0.4,
                                order: 2
                            },
                            {
                                label: 'Daily Target',
                                data: dynamicTargets,
                                type: 'line',
                                borderColor: 'rgb(239, 68, 68)',
                                backgroundColor: 'transparent',
                                borderWidth: 2,
                                borderDash: [5, 5],
                                pointRadius: 0,
                                tension: 0.2,  // Slight curve since target changes over time
                                order: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'bottom',
                                labels: {
                                    usePointStyle: true,
                                    padding: 15,
                                    font: {
                                        size: 11
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.dataset.label || '';
                                        const value = context.parsed.y.toLocaleString();
                                        
                                        if (label === 'Daily Steps') {
                                            const avg = runningAverages[context.dataIndex];
                                            const target = dynamicTargets[context.dataIndex];
                                            const vsAvg = context.parsed.y - avg;
                                            const vsTarget = context.parsed.y - target;
                                            return [
                                                `${label}: ${value}`,
                                                `vs Average: ${vsAvg >= 0 ? '+' : ''}${vsAvg.toLocaleString()}`,
                                                `vs Target: ${vsTarget >= 0 ? '+' : ''}${vsTarget.toLocaleString()}`
                                            ];
                                        }
                                        
                                        return `${label}: ${value}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return value >= 1000 ? (value / 1000) + 'K' : value;
                                    }
                                }
                            },
                            x: {
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 45
                                }
                            }
                        }
                    }
                });
            }

            // Daily Participation Chart (Simplified Safe Version)
            try {
                const participationCtx = document.getElementById('dailyParticipationChart');
                if (participationCtx && cachedData && cachedData.profiles && cachedData.steps) {
                    console.log('[Participation] Starting chart creation...');
                    console.log('[Participation] Profiles:', cachedData.profiles.length);
                    console.log('[Participation] Steps:', cachedData.steps.length);
                    
                    const allProfiles = cachedData.profiles;
                    const allSteps = cachedData.steps;
                    
                    // Count participants per day
                    const dailyParticipantCounts = {};
                    
                    allSteps.forEach(entry => {
                        try {
                            const dateKey = entry.date instanceof Date 
                                ? entry.date.toISOString().split('T')[0]
                                : String(entry.date).split('T')[0];
                            const uniqueKey = entry.uniqueKey || createUniqueKey(entry.name, entry.flatNo);
                            
                            if (!dailyParticipantCounts[dateKey]) {
                                dailyParticipantCounts[dateKey] = new Set();
                            }
                            dailyParticipantCounts[dateKey].add(uniqueKey);
                        } catch (err) {
                            // Skip problematic entries
                        }
                    });
                    
                    console.log('[Participation] Days with data:', Object.keys(dailyParticipantCounts).length);
                    
                    // Build chart data for all 26 days
                    const chartLabels = [];
                    const chartCounts = [];
                    
                    for (let day = 1; day <= 26; day++) {
                        const dateStr = `2026-01-${String(day).padStart(2, '0')}`;
                        const count = dailyParticipantCounts[dateStr] ? dailyParticipantCounts[dateStr].size : 0;
                        
                        chartLabels.push(`Jan ${day}`);
                        chartCounts.push(count);
                    }
                    
                    // Calculate average
                    const nonZeroCounts = chartCounts.filter(c => c > 0);
                    const avgCount = nonZeroCounts.length > 0 
                        ? Math.round(nonZeroCounts.reduce((a, b) => a + b, 0) / nonZeroCounts.length)
                        : 0;
                    
                    const avgLine = new Array(26).fill(avgCount);
                    
                    console.log('[Participation] Average:', avgCount);
                    console.log('[Participation] Max:', Math.max(...nonZeroCounts, 0));
                    
                    // Update stats
                    try {
                        const totalProfiles = allProfiles.length;
                        
                        const el1 = document.getElementById('avgParticipants');
                        if (el1) el1.textContent = avgCount;
                        
                        const el2 = document.getElementById('avgPercentage');
                        if (el2) el2.textContent = `(${((avgCount/totalProfiles)*100).toFixed(1)}%)`;
                        
                        if (nonZeroCounts.length > 0) {
                            const maxCount = Math.max(...nonZeroCounts);
                            const maxDay = chartCounts.indexOf(maxCount) + 1;
                            const el3 = document.getElementById('bestDay');
                            if (el3) el3.textContent = `Jan ${maxDay}`;
                            const el4 = document.getElementById('bestDayCount');
                            if (el4) el4.textContent = `${maxCount} (${((maxCount/totalProfiles)*100).toFixed(1)}%)`;
                            
                            const minCount = Math.min(...nonZeroCounts);
                            const minDay = chartCounts.indexOf(minCount) + 1;
                            const el5 = document.getElementById('lowestDay');
                            if (el5) el5.textContent = `Jan ${minDay}`;
                            const el6 = document.getElementById('lowestDayCount');
                            if (el6) el6.textContent = `${minCount} (${((minCount/totalProfiles)*100).toFixed(1)}%)`;
                        }
                        
                        // Yesterday (day 19 for today being day 20)
                        const yesterday = new Date();
                        yesterday.setDate(yesterday.getDate() - 1);
                        const yesterdayDay = yesterday.getDate();
                        if (yesterdayDay >= 1 && yesterdayDay <= 26) {
                            const el7 = document.getElementById('yesterdayParticipants');
                            if (el7) el7.textContent = chartCounts[yesterdayDay - 1] || 0;
                            const el8 = document.getElementById('yesterdayPercentage');
                            if (el8) el8.textContent = `(${((chartCounts[yesterdayDay-1]/totalProfiles)*100).toFixed(1)}%)`;
                        }
                    } catch (statsErr) {
                        console.log('[Participation] Stats update error:', statsErr.message);
                    }
                    
                    // Create chart
                    new Chart(participationCtx, {
                        type: 'bar',
                        data: {
                            labels: chartLabels,
                            datasets: [{
                                label: 'Participants',
                                data: chartCounts,
                                backgroundColor: 'rgba(59, 130, 246, 0.7)',
                                borderColor: 'rgb(59, 130, 246)',
                                borderWidth: 1
                            }, {
                                label: 'Average',
                                type: 'line',
                                data: avgLine,
                                borderColor: 'rgb(249, 115, 22)',
                                borderWidth: 2,
                                borderDash: [5, 5],
                                pointRadius: 0,
                                fill: false
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'bottom'
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'Participants'
                                    }
                                },
                                x: {
                                    ticks: {
                                        maxRotation: 45,
                                        minRotation: 45
                                    }
                                }
                            }
                        }
                    });
                    
                    console.log('[Participation] Chart created successfully!');
                }
            } catch (error) {
                console.error('[Participation] ERROR:', error);
                console.error('[Participation] Stack:', error.stack);
            }

            // Building Statistics Table with Infographics
            
            // Generate distinct colors for each building
            const buildingColors = [
                '#3b82f6', // Blue
                '#ef4444', // Red
                '#10b981', // Green
                '#f59e0b', // Amber
                '#8b5cf6', // Violet
                '#ec4899', // Pink
                '#14b8a6', // Teal
                '#f97316', // Orange
            ];
            
            const buildingStatsTableDiv = document.getElementById('buildingStatsTable');
            
            if (!buildingStatsTableDiv) {
                console.error('ERROR: buildingStatsTable element not found!');
            } else if (buildingData.length > 0) {
                console.log('Creating building statistics table...');
                console.log('Building data:', buildingData);
                console.log('Building stats:', buildingStats);
                
                // Calculate max values for progress bars
                const maxSteps = Math.max(...buildingData.map(([_, steps]) => steps));
                const maxParticipants = Math.max(...buildingData.map(([building]) => buildingStats[building].participants));
                const maxDailyAvg = Math.max(...buildingData.map(([building]) => buildingStats[building].dailyPerParticipantAvg));
                
                // Find winners
                const stepsWinner = buildingData.reduce((max, curr) => curr[1] > max[1] ? curr : max, buildingData[0])[0];
                const participantsWinner = buildingData.reduce((max, curr) => 
                    buildingStats[curr[0]].participants > buildingStats[max[0]].participants ? curr : max, buildingData[0])[0];
                const dailyAvgWinner = buildingData.reduce((max, curr) => 
                    buildingStats[curr[0]].dailyPerParticipantAvg > buildingStats[max[0]].dailyPerParticipantAvg ? curr : max, buildingData[0])[0];
                
                // Create mobile card view
                let mobileCardsHTML = '<div class="block md:hidden space-y-3">';
                
                buildingData.forEach(([building, totalSteps], idx) => {
                    const stats = buildingStats[building];
                    const color = buildingColors[idx % buildingColors.length];
                    const stepsPercent = (totalSteps / maxSteps) * 100;
                    const participantsPercent = (stats.participants / maxParticipants) * 100;
                    const dailyAvgPercent = (stats.dailyPerParticipantAvg / maxDailyAvg) * 100;
                    
                    // Badges for winners
                    const stepsWinnerBadge = building === stepsWinner ? '<span class="ml-1 inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-yellow-100 text-yellow-800">üèÜ</span>' : '';
                    const participantsWinnerBadge = building === participantsWinner ? '<span class="ml-1 inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800">üë•</span>' : '';
                    const dailyAvgWinnerBadge = building === dailyAvgWinner ? '<span class="ml-1 inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800">‚≠ê</span>' : '';
                    
                    mobileCardsHTML += `
                        <div class="bg-white border rounded-lg p-3 shadow-sm" style="border-left-color: ${color}; border-left-width: 3px;">
                            <!-- Header -->
                            <div class="flex items-center justify-between mb-2">
                                <div class="flex items-center">
                                    <div class="w-3 h-3 rounded-full mr-1.5" style="background-color: ${color}"></div>
                                    <h3 class="text-base font-bold text-gray-900">Building ${building}</h3>
                                </div>
                            </div>
                            
                            <!-- All metrics in compact rows -->
                            <div class="space-y-2 text-sm">
                                <!-- Total Steps -->
                                <div>
                                    <div class="flex items-center justify-between mb-0.5">
                                        <span class="text-xs font-medium text-gray-500">Steps</span>
                                        <div class="flex items-center">
                                            <span class="font-bold text-gray-900">${totalSteps.toLocaleString()}</span>
                                            ${stepsWinnerBadge}
                                        </div>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-1.5">
                                        <div class="h-1.5 rounded-full transition-all duration-500" style="width: ${stepsPercent}%; background-color: ${color}"></div>
                                    </div>
                                </div>
                                
                                <!-- Participants -->
                                <div>
                                    <div class="flex items-center justify-between mb-0.5">
                                        <span class="text-xs font-medium text-gray-500">Participants</span>
                                        <div class="flex items-center">
                                            <span class="font-bold text-gray-900">üë• ${stats.participants}</span>
                                            ${participantsWinnerBadge}
                                        </div>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-1.5">
                                        <div class="h-1.5 rounded-full transition-all duration-500" style="width: ${participantsPercent}%; background-color: ${color}"></div>
                                    </div>
                                </div>
                                
                                <!-- Daily Avg -->
                                <div>
                                    <div class="flex items-center justify-between mb-0.5">
                                        <span class="text-xs font-medium text-gray-500">Daily Avg</span>
                                        <div class="flex items-center">
                                            <span class="font-bold text-gray-900">${stats.dailyPerParticipantAvg.toLocaleString()}</span>
                                            ${dailyAvgWinnerBadge}
                                        </div>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-1.5">
                                        <div class="h-1.5 rounded-full transition-all duration-500" style="width: ${dailyAvgPercent}%; background-color: ${color}"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                mobileCardsHTML += '</div>';
                
                // Create desktop table view
                let tableHTML = `
                    <div class="hidden md:block">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Building
                                    </th>
                                    <th scope="col" class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Total Steps
                                    </th>
                                    <th scope="col" class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Participants
                                    </th>
                                    <th scope="col" class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Daily Avg/Person
                                    </th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                `;
                
                // Add rows for each building
                buildingData.forEach(([building, totalSteps], idx) => {
                    const stats = buildingStats[building];
                    const color = buildingColors[idx % buildingColors.length];
                    const stepsPercent = (totalSteps / maxSteps) * 100;
                    const participantsPercent = (stats.participants / maxParticipants) * 100;
                    const dailyAvgPercent = (stats.dailyPerParticipantAvg / maxDailyAvg) * 100;
                    
                    // Badges for winners
                    const stepsWinnerBadge = building === stepsWinner ? ' <span class="ml-2 inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-yellow-100 text-yellow-800">üèÜ Highest</span>' : '';
                    const participantsWinnerBadge = building === participantsWinner ? ' <span class="ml-1 sm:ml-2 inline-flex items-center px-1.5 sm:px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800">üë• Most</span>' : '';
                    const dailyAvgWinnerBadge = building === dailyAvgWinner ? ' <span class="ml-1 sm:ml-2 inline-flex items-center px-1.5 sm:px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800">‚≠ê Most Active</span>' : '';
                    
                    tableHTML += `
                        <tr class="hover:bg-gray-50 transition-colors">
                            <td class="px-3 sm:px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center">
                                    <div class="w-3 h-10 sm:w-4 sm:h-12 rounded-full mr-3" style="background-color: ${color}"></div>
                                    <div class="text-sm font-medium text-gray-900">Building ${building}</div>
                                </div>
                            </td>
                            <td class="px-3 sm:px-6 py-4">
                                <div class="flex flex-col">
                                    <div class="flex items-center justify-between mb-1">
                                        <span class="text-sm font-semibold text-gray-900">${totalSteps.toLocaleString()}</span>
                                        ${stepsWinnerBadge}
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-2">
                                        <div class="h-2 rounded-full transition-all duration-500" style="width: ${stepsPercent}%; background-color: ${color}"></div>
                                    </div>
                                </div>
                            </td>
                            <td class="px-3 sm:px-6 py-4">
                                <div class="flex flex-col">
                                    <div class="flex items-center justify-between mb-1">
                                        <span class="text-sm font-semibold text-gray-900">
                                            <span class="text-base sm:text-lg">üë•</span> ${stats.participants}
                                        </span>
                                        ${participantsWinnerBadge}
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-2">
                                        <div class="h-2 rounded-full transition-all duration-500" style="width: ${participantsPercent}%; background-color: ${color}"></div>
                                    </div>
                                </div>
                            </td>
                            <td class="px-3 sm:px-6 py-4">
                                <div class="flex flex-col">
                                    <div class="flex items-center justify-between mb-1">
                                        <span class="text-sm font-semibold text-gray-900">${stats.dailyPerParticipantAvg.toLocaleString()} <span class="text-xs text-gray-500">steps/day</span></span>
                                        ${dailyAvgWinnerBadge}
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-2">
                                        <div class="h-2 rounded-full transition-all duration-500" style="width: ${dailyAvgPercent}%; background-color: ${color}"></div>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                tableHTML += `
                            </tbody>
                        </table>
                    </div>
                `;
                
                // Combine mobile cards and desktop table with shared legend
                const combinedHTML = `
                    ${mobileCardsHTML}
                    ${tableHTML}
                    
                    <!-- Legend (shared between mobile and desktop) -->
                    <div class="mt-4 flex flex-wrap gap-3 sm:gap-4 text-xs sm:text-sm text-gray-600 justify-center sm:justify-start">
                        <div class="flex items-center">
                            <span class="w-3 h-3 rounded-full mr-2" style="background-color: #fef3c7"></span>
                            <span>üèÜ = Highest Total Steps</span>
                        </div>
                        <div class="flex items-center">
                            <span class="w-3 h-3 rounded-full mr-2" style="background-color: #dbeafe"></span>
                            <span>üë• = Most Participants</span>
                        </div>
                        <div class="flex items-center">
                            <span class="w-3 h-3 rounded-full mr-2" style="background-color: #d1fae5"></span>
                            <span>‚≠ê = Most Active per Person</span>
                        </div>
                    </div>
                `;
                
                buildingStatsTableDiv.innerHTML = combinedHTML;
                
                console.log('Building statistics created successfully (cards for mobile, table for desktop)');
                console.log('Winners: Steps:', stepsWinner, 'Participants:', participantsWinner, 'Daily Avg:', dailyAvgWinner);
            } else {
                buildingStatsTableDiv.innerHTML = '<p class="text-gray-500 text-center py-8">No building data to display</p>';
                console.log('No building data to display');
            }


            // Age chart with gender split
            const ageCtxElement = document.getElementById('ageChart');
            const ageGenderTableDiv = document.getElementById('ageGenderTable');
            console.log('Age chart element:', ageCtxElement);
            console.log('Age gender table element:', ageGenderTableDiv);
            
            if (ageData.length > 0) {
                // Prepare datasets for grouped bar chart (Male/Female side-by-side)
                const ageGroups = ageData.map(([age]) => age);
                const maleData = ageGroups.map(ageGroup => byAgeGender[ageGroup]['Male'] || 0);
                const femaleData = ageGroups.map(ageGroup => byAgeGender[ageGroup]['Female'] || 0);
                const otherData = ageGroups.map(ageGroup => byAgeGender[ageGroup]['Other'] || 0);
                
                console.log('Age groups:', ageGroups);
                console.log('Male data:', maleData);
                console.log('Female data:', femaleData);
                
                // Desktop: Create grouped bar chart
                if (ageCtxElement) {
                    const ageCtx = ageCtxElement.getContext('2d');
                    if (ageChart) ageChart.destroy();
                    
                    const datasets = [
                        {
                            label: '‚ôÇ Male',
                            data: maleData,
                            backgroundColor: '#3b82f6',
                            borderWidth: 0
                        },
                        {
                            label: '‚ôÄ Female',
                            data: femaleData,
                            backgroundColor: '#ec4899',
                            borderWidth: 0
                        }
                    ];
                    
                    // Only add Other if there's data
                    if (otherData.some(val => val > 0)) {
                        datasets.push({
                            label: 'Other',
                            data: otherData,
                            backgroundColor: '#8b5cf6',
                            borderWidth: 0
                        });
                    }
                    
                    ageChart = new Chart(ageCtx, {
                        type: 'bar',
                        data: {
                            labels: ageGroups,
                            datasets: datasets
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'bottom'
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const label = context.dataset.label;
                                            const value = context.parsed.y.toLocaleString();
                                            const ageGroup = context.label;
                                            const total = maleData[context.dataIndex] + femaleData[context.dataIndex] + otherData[context.dataIndex];
                                            const percentage = total > 0 ? ((context.parsed.y / total) * 100).toFixed(0) : 0;
                                            return `${label}: ${value} steps (${percentage}%)`;
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: function(value) {
                                            return value >= 1000 ? (value / 1000) + 'K' : value;
                                        }
                                    }
                                },
                                x: {
                                    ticks: {
                                        maxRotation: 45,
                                        minRotation: 45
                                    }
                                }
                            }
                        }
                    });
                    console.log('Age chart with gender created successfully (grouped bars)');
                }
                
                // Mobile: Create table with progress bars
                if (ageGenderTableDiv) {
                    let tableHTML = '<div class="space-y-3">';
                    
                    ageGroups.forEach((ageGroup, idx) => {
                        const male = maleData[idx];
                        const female = femaleData[idx];
                        const other = otherData[idx];
                        const total = male + female + other;
                        
                        if (total === 0) return; // Skip empty age groups
                        
                        const malePercent = total > 0 ? Math.round((male / total) * 100) : 0;
                        const femalePercent = total > 0 ? Math.round((female / total) * 100) : 0;
                        const otherPercent = total > 0 ? Math.round((other / total) * 100) : 0;
                        
                        tableHTML += `
                            <div class="bg-white border rounded-lg p-3 shadow-sm">
                                <div class="flex items-center justify-between mb-2">
                                    <h3 class="text-sm font-bold text-gray-900">${ageGroup}</h3>
                                    <span class="text-xs text-gray-500">${total.toLocaleString()}</span>
                                </div>
                                
                                <!-- Male -->
                                <div class="mb-2">
                                    <div class="flex justify-between text-xs mb-1">
                                        <span class="text-gray-600">‚ôÇ Male</span>
                                        <span class="font-bold text-gray-900">${male.toLocaleString()} (${malePercent}%)</span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-1.5">
                                        <div class="h-1.5 rounded-full bg-blue-500 transition-all duration-500" style="width: ${malePercent}%"></div>
                                    </div>
                                </div>
                                
                                <!-- Female -->
                                <div${other > 0 ? ' class="mb-2"' : ''}>
                                    <div class="flex justify-between text-xs mb-1">
                                        <span class="text-gray-600">‚ôÄ Female</span>
                                        <span class="font-bold text-gray-900">${female.toLocaleString()} (${femalePercent}%)</span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-1.5">
                                        <div class="h-1.5 rounded-full bg-pink-500 transition-all duration-500" style="width: ${femalePercent}%"></div>
                                    </div>
                                </div>
                                ${other > 0 ? `
                                <!-- Other -->
                                <div>
                                    <div class="flex justify-between text-xs mb-1">
                                        <span class="text-gray-600">Other</span>
                                        <span class="font-bold text-gray-900">${other.toLocaleString()} (${otherPercent}%)</span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-1.5">
                                        <div class="h-1.5 rounded-full bg-purple-500 transition-all duration-500" style="width: ${otherPercent}%"></div>
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                        `;
                    });
                    
                    tableHTML += '</div>';
                    ageGenderTableDiv.innerHTML = tableHTML;
                    console.log('Age gender table created successfully (mobile)');
                }
            } else {
                if (ageCtxElement) {
                    console.log('No age data to display');
                }
                if (ageGenderTableDiv) {
                    ageGenderTableDiv.innerHTML = '<p class="text-gray-500 text-center py-8 text-sm">No age data to display</p>';
                }
            }

            // Gender chart
            const genderCtxElement = document.getElementById('genderChart');
            console.log('Gender chart element:', genderCtxElement);
            
            if (!genderCtxElement) {
                console.error('ERROR: genderChart canvas element not found!');
            } else {
                const genderCtx = genderCtxElement.getContext('2d');
                if (genderChart) genderChart.destroy();
                
                if (genderData.length > 0) {
                    console.log('Creating gender chart with data:', genderData);
                    genderChart = new Chart(genderCtx, {
                    type: 'pie',
                    data: {
                        labels: genderData.map(([gender]) => gender),
                        datasets: [{
                            data: genderData.map(([_, steps]) => steps),
                            backgroundColor: ['#3b82f6', '#ef4444', '#10b981']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
                console.log('Gender chart created successfully');
            } else {
                console.log('No gender data to display');
            }
        }
        
        console.log('=== ALL CHARTS RENDERED ===');
        }, renderDelay);
    }

        // Update fun stats
        function updateFunStats(totalSteps) {
            // Constants
            const AVG_STRIDE_M = 0.762;  // Average stride length in meters
            const SOCIETY_PERIMETER_M = 440;  // Apostrophe society perimeter
            const MUMBAI_DELHI_KM = 1411;  // Mumbai to Delhi distance
            const SPACE_BOUNDARY_KM = 100;  // K√°rm√°n line (space boundary)
            const CALORIES_PER_STEP = 0.05;  // Average calories per step
            const CO2_PER_KM = 0.2;  // CO2 saved per km (vs driving) in kg
            const TREE_CO2_PER_YEAR = 21.8;  // CO2 absorbed by one tree per year in kg
            
            // Calculate distance
            const totalDistanceM = totalSteps * AVG_STRIDE_M;
            const totalDistanceKm = totalDistanceM / 1000;
            
            // Calculate each stat
            const distanceKm = totalDistanceKm.toFixed(0);
            const societyLoops = Math.floor(totalDistanceM / SOCIETY_PERIMETER_M).toLocaleString();
            const mumbaiDelhiPercent = (totalDistanceKm / MUMBAI_DELHI_KM * 100).toFixed(1);
            const calories = Math.floor(totalSteps * CALORIES_PER_STEP).toLocaleString();
            const co2Saved = totalDistanceKm * CO2_PER_KM;
            const treesEquivalent = Math.floor(co2Saved / TREE_CO2_PER_YEAR);
            const spaceTrips = (totalDistanceKm / SPACE_BOUNDARY_KM).toFixed(1);
            
            // Update DOM
            document.getElementById('statDistance').textContent = distanceKm + ' km';
            document.getElementById('statLoops').textContent = societyLoops;
            document.getElementById('statIndia').textContent = mumbaiDelhiPercent + '%';
            document.getElementById('statCalories').textContent = calories;
            document.getElementById('statTrees').textContent = treesEquivalent;
            document.getElementById('statSpace').textContent = spaceTrips + '√ó';
        }

        // Toggle dashboard
        async function toggleDashboard() {
            const dashboard = document.getElementById('dashboard');
            const userSelector = document.getElementById('userSelectorSection');
            
            if (dashboard.classList.contains('hidden')) {
                dashboard.classList.remove('hidden');
                userSelector.classList.remove('hidden');
                await loadData();
                loadDashboard();
                populateUserSelector();
            } else {
                dashboard.classList.add('hidden');
                userSelector.classList.add('hidden');
            }
        }

        // Milestone celebrations
        const MILESTONES = [
            {
                steps: 500000,
                icon: 'üéØ',
                title: '500K Steps Reached!',
                message: 'Half a million steps! We\'re just getting started!',
                stats: ['381 km covered', '866 loops of Apostrophe', '27% to Mumbai']
            },
            {
                steps: 1000000,
                icon: 'üéä',
                title: '1 MILLION STEPS!',
                message: 'One million steps achieved! We\'ve walked to Mumbai!',
                stats: ['762 km covered', '1,732 loops of Apostrophe', '54% to Mumbai', '50,000 calories burned']
            },
            {
                steps: 2500000,
                icon: 'üèÜ',
                title: '2.5 Million Steps!',
                message: 'Quarter way to our goal! We\'ve crossed Mumbai-Delhi!',
                stats: ['1,905 km covered', '4,330 loops of Apostrophe', '135% to Mumbai', '125,000 calories burned']
            },
            {
                steps: 5000000,
                icon: 'ü•á',
                title: 'HALFWAY THERE!',
                message: '5 MILLION STEPS! We\'ve walked from Mumbai to Delhi and back!',
                stats: ['3,810 km covered', '8,659 loops of Apostrophe', '270% to Mumbai', '250,000 calories burned', '349 trees equivalent']
            },
            {
                steps: 7500000,
                icon: 'üåü',
                title: '7.5 Million Steps!',
                message: 'Three-quarters complete! The finish line is in sight!',
                stats: ['5,715 km covered', '12,989 loops of Apostrophe', '405% to Mumbai', '375,000 calories burned', '524 trees equivalent']
            },
            {
                steps: 10000000,
                icon: 'üåü',
                title: '10 Million Steps!',
                message: 'Halfway to our goal! Momentum is building! üöÄ',
                stats: ['7,620 km covered', '17,318 loops of Apostrophe', '540% to Mumbai', '500,000 calories burned', '698 trees equivalent']
            },
            {
                steps: 12500000,
                icon: 'üí™',
                title: '12.5 Million Steps!',
                message: '62.5% complete! Keep the energy high!',
                stats: ['9,525 km covered', '21,648 loops of Apostrophe', '675% to Mumbai', '625,000 calories burned', '873 trees equivalent']
            },
            {
                steps: 15000000,
                icon: 'üî•',
                title: '15 Million Steps!',
                message: 'Three-quarters done! The finish line is approaching! üéØ',
                stats: ['11,430 km covered', '25,977 loops of Apostrophe', '810% to Mumbai', '750,000 calories burned', '1,047 trees equivalent']
            },
            {
                steps: 17500000,
                icon: '‚≠ê',
                title: '17.5 Million Steps!',
                message: '87.5% complete! Final push to the goal!',
                stats: ['13,335 km covered', '30,307 loops of Apostrophe', '945% to Mumbai', '875,000 calories burned', '1,222 trees equivalent']
            },
            {
                steps: 20000000,
                icon: 'ü•≥',
                title: 'GOAL ACHIEVED!!!',
                message: '20 MILLION STEPS! WE DID IT TOGETHER! üéâüéâüéâ',
                stats: ['15,240 km covered', '34,636 loops of Apostrophe', '1,080% to Mumbai', '1,000,000 calories burned', '1,396 trees equivalent', '152 trips to space!']
            }
        ];

        function checkMilestones(totalSteps) {
            // Get previously shown milestones from localStorage
            const shownMilestones = JSON.parse(localStorage.getItem('shownMilestones') || '[]');
            
            // Find the highest milestone we've reached but haven't shown yet
            let milestoneToShow = null;
            for (let i = MILESTONES.length - 1; i >= 0; i--) {
                const milestone = MILESTONES[i];
                if (totalSteps >= milestone.steps && !shownMilestones.includes(milestone.steps)) {
                    milestoneToShow = milestone;
                    break;
                }
            }
            
            // Show milestone if found
            if (milestoneToShow) {
                showMilestone(milestoneToShow);
                // Mark as shown
                shownMilestones.push(milestoneToShow.steps);
                localStorage.setItem('shownMilestones', JSON.stringify(shownMilestones));
            }
        }

        function showMilestone(milestone) {
            // Update modal content
            document.getElementById('milestoneIcon').textContent = milestone.icon;
            document.getElementById('milestoneTitle').textContent = milestone.title;
            document.getElementById('milestoneMessage').textContent = milestone.message;
            
            // Build stats HTML
            const statsHTML = milestone.stats.map(stat => 
                `<div class="flex items-center gap-2 mb-2">
                    <span class="text-blue-600 text-xl">‚úì</span>
                    <span class="text-gray-700">${stat}</span>
                </div>`
            ).join('');
            document.getElementById('milestoneStats').innerHTML = statsHTML;
            
            // Show modal
            document.getElementById('milestoneModal').classList.remove('hidden');
            
            // Apply bounce animation to card
            const card = document.getElementById('milestoneCard');
            card.classList.add('bounce-once');
            
            // Remove animation class after it completes (0.6s)
            setTimeout(() => {
                card.classList.remove('bounce-once');
            }, 600);
            
            // Play celebration sound (optional - browser support varies)
            try {
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBTGH0fPTgjMGHm7A7+OZSA8PVKXi8bVjHQU2jdXzzn0pBSt+zPLaizsIGGS57OihUBELTqPh8bllHgU0itTz0H8rBSx+zPLajTsIF2W57OmgUREKTqPh8bllHgU0idTz0H8rBSx+zPLajTsIF2W57OmgURIJTqPh8bllHgU0idTz0H8rBSx+zPLajTsIF2W57OmgURIJTqPh8bllHgU0idTz0H8rBSx+zPLajTsIF2W57OmgURIJTqPh8bllHgU0idTz0H8rBSx+zPLajTsIF2W57OmgURIJTqPh8bllHgU0idTz0H8rBSx+zPLajTsIF2W57OmgURIJTqPh8bllHgU0idTz0H8rBSx+zPLajTsIF2W57OmgURIJTqPh8bllHgU0idTz0H8rBSx+zPLajTsIF2W57OmgURIJTqPh8bllHgU0idTz0H8rBSx+zPLajTsIF2W57OmgURIJTqPh8bllHgU0idTz0H8rBSx+zPLajTsIF2W57OmgURIJTqPh8bllHgU0idTz0H8rBSx+zPLajTsIF2W57OmgURIJTqPh8bllHgU0idTz0H8rBSx+zPLajTsIF2W57OmgURIJTqPh8bllHgU0idTz0H8rBSx+zPLajTsIF2W57OmgURIJTqPh8bllHgU0idTz0H8rBSx+zPLajTsIF2W57OmgURIJTqPh8bllHgU0idTz0H8rBSx+zPLajTsIF2W57OmgURIJTqPh8bllHgU0idTz0H8rBSx+zPLajTsIF2W57OmgURIJTqPh8bllHgU0idTz0H8rBSx+zPLajTsIF2W57OmgURIJTqPh8bllHgU0idTz0H8rBSx+zPLajTsIF2W57OmgURIJTqPh8bllHgU0idTz0H8rBSx+zPLajTsIF2W57OmgURIJTqPh8bllHgU0idTz0H8rBSx+zPLajTsIF2W57OmgURIJTqPh8bllHgU0idTz0H8rBSx+zPLajTsIF2W57OmgURIJTqPh8bllHgU0idTz0H8rBSx+zPLajTsIF2W57OmgURIJTqPh8bllHgU0idTz0H8rBSx+zPLajTsIF2W57OmgURIJTqPh8bllHgU0idTz0H8rBSx+zPLajTsIF2W57OmgURIJTqPh8bllHgU0idTz0H8rBQ==');
                audio.play().catch(() => {}); // Ignore if audio fails
            } catch (e) {
                // Audio not supported, ignore
            }
        }

        function closeMilestone() {
            document.getElementById('milestoneModal').classList.add('hidden');
        }

        // Initialize on page load
        window.onload = async function() {
            // Check if SCRIPT_URL is set
            if (SCRIPT_URL === 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE' || SCRIPT_URL === '') {
                document.getElementById('setupNotice').classList.remove('hidden');
                console.error('SCRIPT_URL not configured!');
                return;
            } else {
                document.getElementById('setupNotice').classList.add('hidden');
            }
            
            // Enable generate button when user selects someone
            const userSelector = document.getElementById('userSelector');
            const generateBtn = document.getElementById('generateBtn');
            
            if (userSelector && generateBtn) {
                userSelector.addEventListener('change', function() {
                    generateBtn.disabled = !this.value;
                });
            }
            
            // AUTO-LOAD DASHBOARD ON PAGE LOAD
            console.log('Auto-loading dashboard...');
            try {
                const dashboard = document.getElementById('dashboard');
                const userSelector = document.getElementById('userSelectorSection');
                
                // Show dashboard and user selector
                dashboard.classList.remove('hidden');
                userSelector.classList.remove('hidden');
                
                // Load data
                await loadData();
                
                // Load all dashboard components
                loadDashboard();
                populateUserSelector();
                
                console.log('Dashboard loaded successfully!');
            } catch (error) {
                console.error('Error loading dashboard:', error);
                alert('Error loading data. Please check:\n1. SCRIPT_URL is correct\n2. Google Apps Script is deployed\n3. Check browser console for errors');
            }
        };
        
        // ============================================
        // NEW FUNCTIONS FOR PERSONAL SUMMARY
        // ============================================
        
        function populateUserSelector() {
            if (!cachedData || !cachedData.profiles) return;
            
            const selector = document.getElementById('userSelector');
            if (!selector) return;
            
            // Clear existing options except the first one
            selector.innerHTML = '<option value="">-- Choose your name --</option>';
            
            // Sort profiles alphabetically
            const sortedProfiles = [...cachedData.profiles].sort((a, b) => 
                a.name.localeCompare(b.name)
            );
            
            // Add all participants
            sortedProfiles.forEach(profile => {
                const option = document.createElement('option');
                const uniqueKey = createUniqueKey(profile.name, profile.flatNo);
                option.value = uniqueKey;
                option.textContent = `${profile.name} (${profile.flatNo})`;
                selector.appendChild(option);
            });
        }
        
        function generatePersonalSummary() {
            const selector = document.getElementById('userSelector');
            if (!selector || !selector.value || !cachedData) return;
            
            const uniqueKey = selector.value;
            
            // Find the selected profile
            const profile = cachedData.profiles.find(p => 
                createUniqueKey(p.name, p.flatNo) === uniqueKey
            );
            
            if (!profile) {
                alert('Profile not found!');
                return;
            }
            
            // Calculate user stats
            const userData = calculateUserStats(profile);
            
            // Calculate badges
            const badges = calculateBadges(userData);
            
            // Generate personalized message
            const message = generateMessage(userData);
            
            // Render the summary
            renderPersonalSummary(userData, badges, message);
            
            // Scroll to summary
            setTimeout(() => {
                document.getElementById('individualSummary').scrollIntoView({ 
                    behavior: 'smooth',
                    block: 'start'
                });
            }, 100);
        }
        
        function calculateUserStats(profile) {
            const uniqueKey = createUniqueKey(profile.name, profile.flatNo);
            
            // Get all steps for this user
            const userSteps = cachedData.steps.filter(entry => {
                const entryKey = entry.uniqueKey || createUniqueKey(entry.name, entry.flatNo);
                return entryKey === uniqueKey;
            });
            
            // Calculate total and average
            const totalSteps = userSteps.reduce((sum, entry) => sum + (parseInt(entry.steps) || 0), 0);
            const daysLogged = userSteps.length;
            const avgDaily = daysLogged > 0 ? Math.round(totalSteps / daysLogged) : 0;
            
            // Find best day
            let bestDay = { steps: 0, date: '' };
            userSteps.forEach(entry => {
                if (entry.steps > bestDay.steps) {
                    bestDay = { steps: entry.steps, date: entry.date };
                }
            });
            
            // Calculate overall rank
            const allTotals = cachedData.profiles.map(p => {
                const pKey = createUniqueKey(p.name, p.flatNo);
                const pSteps = cachedData.steps.filter(e => {
                    const eKey = e.uniqueKey || createUniqueKey(e.name, e.flatNo);
                    return eKey === pKey;
                });
                return {
                    uniqueKey: pKey,
                    name: p.name,
                    profile: p,
                    total: pSteps.reduce((sum, e) => sum + (parseInt(e.steps) || 0), 0)
                };
            }).sort((a, b) => b.total - a.total);
            
            const rank = allTotals.findIndex(p => p.uniqueKey === uniqueKey) + 1;
            
            // Calculate BUILDING RANK
            const building = profile.flatNo.charAt(0);
            const buildingParticipants = allTotals.filter(p => p.profile.flatNo.charAt(0) === building);
            const buildingRank = buildingParticipants.findIndex(p => p.uniqueKey === uniqueKey) + 1;
            
            // Calculate AGE GROUP RANK
            const userAgeGroup = getAgeGroup(profile.age);
            const ageGroupParticipants = allTotals.filter(p => getAgeGroup(p.profile.age) === userAgeGroup);
            const ageGroupRank = ageGroupParticipants.findIndex(p => p.uniqueKey === uniqueKey) + 1;
            
            // Calculate WEEKLY BREAKDOWN
            const weeklyData = [];
            const weeks = [
                { name: 'Week 1', start: '2026-01-01', end: '2026-01-07', days: 7 },
                { name: 'Week 2', start: '2026-01-08', end: '2026-01-14', days: 7 },
                { name: 'Week 3', start: '2026-01-15', end: '2026-01-21', days: 7 },
                { name: 'Week 4', start: '2026-01-22', end: '2026-01-26', days: 5 }
            ];
            
            weeks.forEach(week => {
                const weekSteps = userSteps.filter(entry => {
                    const entryDate = typeof entry.date === 'string' ? entry.date.split('T')[0] : entry.date;
                    return entryDate >= week.start && entryDate <= week.end;
                });
                
                const weekTotal = weekSteps.reduce((sum, e) => sum + (parseInt(e.steps) || 0), 0);
                const weekDays = weekSteps.length;
                const weekAvg = weekDays > 0 ? Math.round(weekTotal / weekDays) : 0;
                
                weeklyData.push({
                    name: week.name,
                    total: weekTotal,
                    daysLogged: weekDays,
                    avgDaily: weekAvg,
                    maxDays: week.days
                });
            });
            
            // Calculate CONSISTENCY (variance in daily steps)
            if (userSteps.length >= 10) {
                const stepCounts = userSteps.map(e => e.steps);
                const mean = stepCounts.reduce((a, b) => a + b, 0) / stepCounts.length;
                const variance = stepCounts.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / stepCounts.length;
                const stdDev = Math.sqrt(variance);
                const coefficientOfVariation = (stdDev / mean) * 100;
                
                // Lower CV = higher consistency
                let consistency = 'medium';
                if (coefficientOfVariation < 20) consistency = 'high';
                else if (coefficientOfVariation > 40) consistency = 'low';
                
                var consistencyValue = consistency;
                var consistencyScore = coefficientOfVariation;
            } else {
                var consistencyValue = 'medium';
                var consistencyScore = null;
            }
            
            // Calculate community average
            const communityTotal = cachedData.steps.reduce((sum, entry) => sum + (parseInt(entry.steps) || 0), 0);
            const communityAvg = Math.round(communityTotal / cachedData.profiles.length);
            
            // Calculate distance and calories
            const distance = (totalSteps * 0.762 / 1000).toFixed(1); // km
            const calories = Math.round(totalSteps * 0.05);
            
            return {
                profile,
                uniqueKey,
                totalSteps,
                daysLogged,
                avgDaily,
                bestDay,
                rank,
                totalParticipants: cachedData.profiles.length,
                communityAvg,
                distance,
                calories,
                userSteps,
                buildingRank,
                ageGroupRank,
                weeklyData,
                consistency: consistencyValue,
                consistencyScore
            };
        }
        
        function calculateBadges(userData) {
            const badges = [];
            const { rank, totalSteps, daysLogged, avgDaily, totalParticipants, profile } = userData;
            
            // Performance badges
            if (rank === 1) badges.push({ icon: 'ü•á', name: 'Challenge Champion', desc: '#1 Overall', tier: 'gold' });
            else if (rank === 2) badges.push({ icon: 'ü•à', name: 'Silver Medalist', desc: '#2 Overall', tier: 'silver' });
            else if (rank === 3) badges.push({ icon: 'ü•â', name: 'Bronze Medalist', desc: '#3 Overall', tier: 'bronze' });
            else if (rank <= 10) badges.push({ icon: '‚≠ê', name: 'Top 10 Elite', desc: `Rank #${rank}`, tier: 'silver' });
            else if (rank <= Math.ceil(totalParticipants * 0.25)) badges.push({ icon: 'üí™', name: 'Top 25% Achiever', desc: `Top Quarter`, tier: 'bronze' });
            else if (rank <= Math.ceil(totalParticipants * 0.5)) badges.push({ icon: 'üéØ', name: 'Top 50%', desc: `Upper Half`, tier: 'green' });
            
            // Consistency badges
            if (daysLogged === 26) badges.push({ icon: 'üíé', name: 'Perfect Attendance', desc: '26/26 Days', tier: 'gold' });
            else if (daysLogged >= 24) badges.push({ icon: '‚ú®', name: 'Near Perfect', desc: `${daysLogged}/26 Days`, tier: 'silver' });
            else if (daysLogged >= 20) badges.push({ icon: 'üéØ', name: 'Strong Commitment', desc: `${daysLogged} Days`, tier: 'bronze' });
            else if (daysLogged >= 15) badges.push({ icon: 'üìÖ', name: 'Good Participation', desc: `${daysLogged} Days`, tier: 'green' });
            
            // Milestone badges
            if (totalSteps >= 500000) badges.push({ icon: 'üåü', name: 'Half Million Club', desc: '500K+ Steps', tier: 'gold' });
            else if (totalSteps >= 400000) badges.push({ icon: 'üíé', name: '400K Achiever', desc: '400K Steps', tier: 'silver' });
            else if (totalSteps >= 300000) badges.push({ icon: '‚ú®', name: '300K Milestone', desc: '300K Steps', tier: 'bronze' });
            else if (totalSteps >= 200000) badges.push({ icon: '‚≠ê', name: '200K Club', desc: '200K Steps', tier: 'bronze' });
            else if (totalSteps >= 100000) badges.push({ icon: 'üéØ', name: '100K Starter', desc: '100K Steps', tier: 'green' });
            
            // Daily average badges
            if (avgDaily >= 20000) badges.push({ icon: 'üöÄ', name: '20K+ Daily', desc: `${avgDaily.toLocaleString()}/day`, tier: 'gold' });
            else if (avgDaily >= 15000) badges.push({ icon: 'üî•', name: '15K+ Daily', desc: `${avgDaily.toLocaleString()}/day`, tier: 'silver' });
            else if (avgDaily >= 10000) badges.push({ icon: 'üí™', name: '10K+ Daily', desc: `${avgDaily.toLocaleString()}/day`, tier: 'bronze' });
            else if (avgDaily >= 5000) badges.push({ icon: 'üèÉ', name: '5K+ Daily', desc: `${avgDaily.toLocaleString()}/day`, tier: 'green' });
            
            // Distance badges
            if (parseFloat(userData.distance) >= 350) badges.push({ icon: 'üåç', name: 'World Traveler', desc: `${userData.distance} km`, tier: 'gold' });
            else if (parseFloat(userData.distance) >= 300) badges.push({ icon: 'üó∫Ô∏è', name: 'Distance Champion', desc: `${userData.distance} km`, tier: 'silver' });
            else if (parseFloat(userData.distance) >= 250) badges.push({ icon: 'üëü', name: 'Shoe Destroyer', desc: 'Need new shoes!', tier: 'bronze' });
            
            // BUILDING CHAMPION BADGE
            if (userData.buildingRank === 1) {
                const building = profile.flatNo.charAt(0);
                badges.push({ icon: 'üè¢', name: 'Building Champion', desc: `Building ${building} #1`, tier: 'gold' });
            } else if (userData.buildingRank && userData.buildingRank <= 3) {
                const building = profile.flatNo.charAt(0);
                badges.push({ icon: 'üèÖ', name: 'Building Top 3', desc: `Building ${building}`, tier: 'silver' });
            }
            
            // AGE GROUP CHAMPION BADGE
            if (userData.ageGroupRank === 1) {
                const ageGroup = getAgeGroup(profile.age);
                badges.push({ icon: 'üëë', name: 'Age Group Champion', desc: `${ageGroup} #1`, tier: 'gold' });
            } else if (userData.ageGroupRank && userData.ageGroupRank <= 3) {
                const ageGroup = getAgeGroup(profile.age);
                badges.push({ icon: 'üèÜ', name: 'Age Group Top 3', desc: ageGroup, tier: 'silver' });
            }
            
            // IMPROVEMENT BADGES (based on weekly breakdown)
            if (userData.weeklyData && userData.weeklyData.length >= 2) {
                const week1Avg = userData.weeklyData[0].avgDaily;
                const lastWeekAvg = userData.weeklyData[userData.weeklyData.length - 1].avgDaily;
                const improvement = ((lastWeekAvg - week1Avg) / week1Avg) * 100;
                
                if (improvement >= 50) {
                    badges.push({ icon: 'üìà', name: 'Most Improved', desc: `+${Math.round(improvement)}%`, tier: 'gold' });
                } else if (improvement >= 25) {
                    badges.push({ icon: '‚¨ÜÔ∏è', name: 'Getting Stronger', desc: `+${Math.round(improvement)}%`, tier: 'silver' });
                }
                
                // Comeback Warrior - struggled then finished strong
                if (improvement >= 30 && lastWeekAvg >= 15000) {
                    badges.push({ icon: 'üí™', name: 'Comeback Warrior', desc: 'Strong Finish', tier: 'silver' });
                }
            }
            
            // CONSISTENCY BADGE
            if (userData.consistency && userData.consistency === 'high') {
                badges.push({ icon: 'üéØ', name: 'Mr./Ms. Consistency', desc: 'Rock Solid', tier: 'silver' });
            }
            
            // Calories Badge
            if (userData.calories >= 25000) badges.push({ icon: 'üî•', name: 'Calorie Crusher', desc: `${userData.calories.toLocaleString()} kcal`, tier: 'bronze' });
            
            // Team player (everyone gets this)
            badges.push({ icon: 'ü§ù', name: 'Team Player', desc: 'Community Spirit', tier: 'green' });
            
            return badges.slice(0, 15); // Max 15 badges now
        }
        
        function generateMessage(userData) {
            const { rank, totalSteps, daysLogged, avgDaily, profile, totalParticipants } = userData;
            
            let message = '';
            
            // Opening based on rank
            if (rank === 1) {
                message = `${profile.name}, you absolutely CRUSHED this challenge! üéâ\n\n`;
                message += `Not only did you finish #1 overall with ${totalSteps.toLocaleString()} steps, but you `;
                if (daysLogged === 26) {
                    message += `showed incredible consistency by logging every single day without fail! `;
                } else {
                    message += `maintained an impressive ${avgDaily.toLocaleString()} steps per active day! `;
                }
                message += `Your dedication inspired many others to keep going.\n\n`;
                message += `As our Challenge Champion, you've set a new standard for what's possible. Thank you for leading Apostrophe by example! üèÜüí™`;
            }
            else if (rank <= 3) {
                message = `${profile.name}, outstanding performance! ${rank === 2 ? 'ü•à' : 'ü•â'}\n\n`;
                message += `Finishing #${rank} out of ${totalParticipants} participants with ${totalSteps.toLocaleString()} steps is incredible! `;
                if (daysLogged === 26) {
                    message += `Your perfect attendance shows exceptional commitment. `;
                }
                message += `\n\nYou proved that dedication and consistency pay off. Thank you for inspiring our community! üí™`;
            }
            else if (rank <= 10) {
                message = `${profile.name}, excellent work! ‚≠ê\n\n`;
                message += `Finishing in the top 10 (#${rank} of ${totalParticipants}) puts you among the elite performers. `;
                message += `Your ${totalSteps.toLocaleString()} steps over ${daysLogged} days demonstrate serious commitment.\n\n`;
                message += `You're a driving force in our community's success! üåü`;
            }
            else if (rank <= Math.ceil(totalParticipants * 0.25)) {
                message = `${profile.name}, great job! üí™\n\n`;
                message += `Ranking in the top 25% is a significant achievement! Your ${totalSteps.toLocaleString()} steps show real dedication. `;
                if (daysLogged >= 20) {
                    message += `Your consistency over ${daysLogged} days is impressive. `;
                }
                message += `\n\nThank you for being a strong contributor to our community! ‚ú®`;
            }
            else {
                message = `${profile.name}, thank you for participating! üåü\n\n`;
                message += `Your ${totalSteps.toLocaleString()} steps over ${daysLogged} days made a real contribution to our community's success. `;
                message += `Every step counts, and you added yours!\n\n`;
                message += `This challenge was about community and health, and you showed up. Thank you! üíö`;
            }
            
            // Add special recognition for perfect attendance
            if (daysLogged === 26 && rank > 3) {
                message += `\n\n‚ú® SPECIAL RECOGNITION: Perfect Attendance! ‚ú®\n`;
                message += `You logged steps every single day without fail. This demonstrates exceptional discipline!`;
            }
            
            return message;
        }
        
        function renderPersonalSummary(userData, badges, message) {
            const summaryDiv = document.getElementById('individualSummary');
            if (!summaryDiv) return;
            
            const { profile, rank, totalSteps, daysLogged, avgDaily, distance, calories, bestDay, communityAvg } = userData;
            
            // Determine medal emoji
            let medalEmoji = '';
            if (rank === 1) medalEmoji = 'ü•á';
            else if (rank === 2) medalEmoji = 'ü•à';
            else if (rank === 3) medalEmoji = 'ü•â';
            
            const html = `
                <!-- Personal Header -->
                <div class="bg-gradient-to-r from-indigo-500 to-purple-600 text-white rounded-lg shadow-xl p-8 text-center">
                    <h2 class="text-3xl sm:text-4xl font-bold mb-2">${medalEmoji} ${profile.name} ${medalEmoji}</h2>
                    <p class="text-xl mb-1">Flat ${profile.flatNo} ‚Ä¢ Building ${profile.flatNo.charAt(0)}</p>
                    <p class="text-2xl font-bold">Rank: #${rank} of ${userData.totalParticipants}</p>
                </div>
                
                <!-- Personal Stats Cards -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="bg-white rounded-lg shadow-lg p-6 text-center border-l-4 border-blue-500">
                        <div class="text-3xl mb-2">üìä</div>
                        <p class="text-gray-600 text-sm">Total Steps</p>
                        <p class="text-2xl font-bold text-blue-600">${totalSteps.toLocaleString()}</p>
                    </div>
                    <div class="bg-white rounded-lg shadow-lg p-6 text-center border-l-4 border-green-500">
                        <div class="text-3xl mb-2">üìÖ</div>
                        <p class="text-gray-600 text-sm">Days Logged</p>
                        <p class="text-2xl font-bold text-green-600">${daysLogged}/26</p>
                    </div>
                    <div class="bg-white rounded-lg shadow-lg p-6 text-center border-l-4 border-purple-500">
                        <div class="text-3xl mb-2">üí™</div>
                        <p class="text-gray-600 text-sm">Daily Average</p>
                        <p class="text-2xl font-bold text-purple-600">${avgDaily.toLocaleString()}</p>
                    </div>
                    <div class="bg-white rounded-lg shadow-lg p-6 text-center border-l-4 border-orange-500">
                        <div class="text-3xl mb-2">üî•</div>
                        <p class="text-gray-600 text-sm">Best Day</p>
                        <p class="text-2xl font-bold text-orange-600">${bestDay.steps.toLocaleString()}</p>
                    </div>
                </div>
                
                <!-- Your Journey -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">üåç Your Personal Journey</h3>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                        <div class="text-center p-4 bg-blue-50 rounded-lg">
                            <div class="text-3xl mb-2">üåè</div>
                            <p class="text-xl font-bold text-blue-600">${distance} km</p>
                            <p class="text-sm text-gray-600">Distance Walked</p>
                        </div>
                        <div class="text-center p-4 bg-green-50 rounded-lg">
                            <div class="text-3xl mb-2">üî•</div>
                            <p class="text-xl font-bold text-green-600">${calories.toLocaleString()}</p>
                            <p class="text-sm text-gray-600">Calories Burned</p>
                        </div>
                        <div class="text-center p-4 bg-purple-50 rounded-lg">
                            <div class="text-3xl mb-2">‚è±Ô∏è</div>
                            <p class="text-xl font-bold text-purple-600">${Math.round(totalSteps / 1000 * 10)} hrs</p>
                            <p class="text-sm text-gray-600">Walking Time</p>
                        </div>
                    </div>
                </div>
                
                <!-- Badges -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">üèÖ Your Achievement Badges (${badges.length})</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        ${badges.map(badge => `
                            <div class="badge-card badge-${badge.tier}">
                                <div class="badge-icon">${badge.icon}</div>
                                <div class="badge-name">${badge.name}</div>
                                <div class="badge-desc">${badge.desc}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <!-- Weekly Breakdown -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">üìÖ Weekly Breakdown</h3>
                    ${userData.weeklyData ? `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                            ${userData.weeklyData.map((week, index) => {
                                const percentage = (week.total / totalSteps) * 100;
                                const isoBest = week.avgDaily === Math.max(...userData.weeklyData.map(w => w.avgDaily));
                                return `
                                    <div class="border-2 ${isoBest ? 'border-green-500 bg-green-50' : 'border-gray-200'} rounded-lg p-4">
                                        <div class="flex justify-between items-center mb-2">
                                            <h4 class="font-bold text-lg">${week.name} ${isoBest ? 'üèÜ' : ''}</h4>
                                            <span class="text-sm text-gray-600">${week.daysLogged}/${week.maxDays} days</span>
                                        </div>
                                        <div class="space-y-2">
                                            <div class="flex justify-between">
                                                <span class="text-sm text-gray-600">Total:</span>
                                                <span class="font-semibold">${week.total.toLocaleString()} steps</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="text-sm text-gray-600">Daily Avg:</span>
                                                <span class="font-semibold">${week.avgDaily.toLocaleString()} steps</span>
                                            </div>
                                            <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                                                <div class="bg-blue-600 h-2 rounded-full" style="width: ${percentage}%"></div>
                                            </div>
                                            <p class="text-xs text-gray-500 text-center">${percentage.toFixed(1)}% of total</p>
                                        </div>
                                        ${isoBest ? '<p class="text-xs text-green-600 font-semibold text-center mt-2">‚ú® Your Best Week!</p>' : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        
                        <!-- Weekly Chart -->
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h4 class="font-semibold text-gray-700 mb-3 text-center">Weekly Progress Chart</h4>
                            <div class="flex items-end justify-around h-48 gap-2">
                                ${userData.weeklyData.map(week => {
                                    const maxWeekly = Math.max(...userData.weeklyData.map(w => w.avgDaily));
                                    const height = (week.avgDaily / maxWeekly) * 100;
                                    return `
                                        <div class="flex-1 flex flex-col items-center">
                                            <div class="text-xs font-semibold mb-1">${week.avgDaily.toLocaleString()}</div>
                                            <div class="w-full bg-gradient-to-t from-blue-600 to-blue-400 rounded-t-lg" 
                                                 style="height: ${height}%; min-height: 20px;"
                                                 title="${week.name}: ${week.avgDaily.toLocaleString()} avg">
                                            </div>
                                            <div class="text-xs mt-2 text-gray-600">${week.name.replace('Week ', 'W')}</div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                        
                        <!-- Improvement Analysis -->
                        ${userData.weeklyData.length >= 2 ? (() => {
                            const week1Avg = userData.weeklyData[0].avgDaily;
                            const lastWeekAvg = userData.weeklyData[userData.weeklyData.length - 1].avgDaily;
                            const improvement = ((lastWeekAvg - week1Avg) / week1Avg) * 100;
                            return `
                                <div class="mt-4 p-4 ${improvement >= 0 ? 'bg-green-50 border-green-200' : 'bg-blue-50 border-blue-200'} border-2 rounded-lg">
                                    <p class="text-center font-semibold ${improvement >= 0 ? 'text-green-700' : 'text-blue-700'}">
                                        ${improvement >= 0 ? 'üìà ' : 'üìä '}
                                        ${improvement >= 0 ? 'Improved' : 'Changed'} by ${Math.abs(improvement).toFixed(1)}% from Week 1 to Week 4!
                                    </p>
                                    <p class="text-xs text-center text-gray-600 mt-1">
                                        Week 1 avg: ${week1Avg.toLocaleString()} ‚Üí Week 4 avg: ${lastWeekAvg.toLocaleString()}
                                    </p>
                                </div>
                            `;
                        })() : ''}
                    ` : '<p class="text-gray-500 text-center">Weekly data not available</p>'}
                </div>
                
                <!-- Comparison -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">üìä How You Compare</h3>
                    <div class="space-y-4">
                        <div>
                            <div class="flex justify-between mb-2">
                                <span class="font-semibold">You</span>
                                <span class="text-blue-600 font-bold">${totalSteps.toLocaleString()}</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-6">
                                <div class="bg-blue-600 h-6 rounded-full" style="width: 100%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between mb-2">
                                <span class="font-semibold">Community Average</span>
                                <span class="text-gray-600">${communityAvg.toLocaleString()}</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-6">
                                <div class="bg-gray-400 h-6 rounded-full" style="width: ${Math.min((communityAvg/totalSteps)*100, 100)}%"></div>
                            </div>
                        </div>
                        <p class="text-center text-lg font-semibold text-blue-600">
                            You walked ${Math.round((totalSteps/communityAvg - 1) * 100)}% ${totalSteps > communityAvg ? 'more' : 'less'} than average!
                        </p>
                    </div>
                </div>
                
                <!-- Personalized Message -->
                <div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg shadow-lg p-8 border-2 border-blue-300">
                    <h3 class="text-2xl font-bold text-gray-800 mb-4 text-center">üí¨ Your Personal Message</h3>
                    <div class="text-gray-700 text-lg whitespace-pre-line">${message}</div>
                </div>
                
                <!-- Action Buttons -->
                <div class="flex flex-col sm:flex-row gap-4 justify-center">
                    <button 
                        onclick="downloadCertificate()"
                        class="bg-gradient-to-r from-green-600 to-blue-600 text-white px-8 py-4 rounded-lg shadow-lg hover:shadow-xl transition-all text-lg font-bold"
                    >
                        üì• Download Certificate
                    </button>
                    <button 
                        onclick="shareOnWhatsApp()"
                        class="bg-gradient-to-r from-green-500 to-green-600 text-white px-8 py-4 rounded-lg shadow-lg hover:shadow-xl transition-all text-lg font-bold"
                    >
                        üì± Share on WhatsApp
                    </button>
                </div>
            `;
            
            summaryDiv.innerHTML = html;
            summaryDiv.classList.remove('hidden');
        }
        
        function shareOnWhatsApp() {
            const selector = document.getElementById('userSelector');
            if (!selector || !selector.value) return;
            
            const uniqueKey = selector.value;
            const profile = cachedData.profiles.find(p => 
                createUniqueKey(p.name, p.flatNo) === uniqueKey
            );
            
            if (!profile) return;
            
            const userData = calculateUserStats(profile);
            
            const text = `üéâ I completed the Apostrophe Steps Challenge 2026!\n\n` +
                        `üìä My Stats:\n` +
                        `‚Ä¢ Rank: #${userData.rank} of ${userData.totalParticipants}\n` +
                        `‚Ä¢ Total Steps: ${userData.totalSteps.toLocaleString()}\n` +
                        `‚Ä¢ Days Logged: ${userData.daysLogged}/26\n` +
                        `‚Ä¢ Distance: ${userData.distance} km\n\n` +
                        `üí™ What an incredible journey with our Apostrophe family!\n\n` +
                        `#ApostropheStepsChallenge #HealthyLiving`;
            
            const url = `https://wa.me/?text=${encodeURIComponent(text)}`;
            window.open(url, '_blank');
        }
        
        function downloadCertificate() {
            const selector = document.getElementById('userSelector');
            if (!selector || !selector.value) return;
            
            const uniqueKey = selector.value;
            const profile = cachedData.profiles.find(p => 
                createUniqueKey(p.name, p.flatNo) === uniqueKey
            );
            
            if (!profile) return;
            
            const userData = calculateUserStats(profile);
            const badges = calculateBadges(userData);
            
            // Determine certificate tier and colors
            let tier, borderColor, bgColor, title, medalEmoji;
            if (userData.rank === 1) {
                tier = 'Champion';
                borderColor = '#FFD700';
                bgColor = '#FFF8DC';
                title = 'CERTIFICATE OF OUTSTANDING ACHIEVEMENT';
                medalEmoji = 'ü•á';
            } else if (userData.rank === 2) {
                tier = 'Silver';
                borderColor = '#C0C0C0';
                bgColor = '#F5F5F5';
                title = 'CERTIFICATE OF OUTSTANDING ACHIEVEMENT';
                medalEmoji = 'ü•à';
            } else if (userData.rank === 3) {
                tier = 'Bronze';
                borderColor = '#CD7F32';
                bgColor = '#FFE4B5';
                title = 'CERTIFICATE OF OUTSTANDING ACHIEVEMENT';
                medalEmoji = 'ü•â';
            } else if (userData.rank <= 10) {
                tier = 'Elite';
                borderColor = '#4A90E2';
                bgColor = '#E3F2FD';
                title = 'CERTIFICATE OF EXCELLENCE';
                medalEmoji = '‚≠ê';
            } else {
                tier = 'Participant';
                borderColor = '#32CD32';
                bgColor = '#F0FFF0';
                title = 'CERTIFICATE OF PARTICIPATION';
                medalEmoji = '‚ú®';
            }
            
            // Create certificate HTML
            const certificateHTML = `
                <div id="certificate" style="width: 210mm; padding: 20mm; background: white; font-family: Arial, sans-serif;">
                    <div style="border: 8px double ${borderColor}; padding: 30px; background: ${bgColor};">
                        <!-- Header -->
                        <div style="text-align: center; margin-bottom: 20px;">
                            <h1 style="font-size: 28px; color: #333; margin: 0;">üèÉ APOSTROPHE SOCIETY üèÉ</h1>
                            <div style="border-bottom: 3px solid ${borderColor}; margin: 15px auto; width: 300px;"></div>
                        </div>
                        
                        <!-- Title -->
                        <h2 style="text-align: center; font-size: 18px; color: #555; margin: 20px 0;">${title}</h2>
                        <h3 style="text-align: center; font-size: 16px; color: #666; margin: 10px 0;">STEPS CHALLENGE 2026</h3>
                        <p style="text-align: center; font-size: 12px; color: #888; margin: 5px 0;">January 1 - 26, 2026</p>
                        
                        <div style="border-bottom: 2px solid ${borderColor}; margin: 20px auto; width: 400px;"></div>
                        
                        <!-- Name Section -->
                        <p style="text-align: center; font-size: 14px; color: #555; margin: 20px 0;">THIS CERTIFIES THAT</p>
                        <h1 style="text-align: center; font-size: 32px; color: #333; margin: 15px 0;">${medalEmoji} ${profile.name.toUpperCase()} ${medalEmoji}</h1>
                        <p style="text-align: center; font-size: 14px; color: #666; margin: 10px 0;">Building ${profile.flatNo.charAt(0)} ‚Ä¢ Flat ${profile.flatNo}</p>
                        
                        <!-- Achievement Summary -->
                        <div style="border: 2px solid ${borderColor}; border-radius: 10px; padding: 20px; margin: 25px 0; background: white;">
                            <h3 style="text-align: center; font-size: 16px; color: #333; margin-bottom: 15px;">ACHIEVEMENT SUMMARY</h3>
                            <table style="width: 100%; font-size: 13px; color: #555;">
                                <tr>
                                    <td style="padding: 8px;"><strong>üèÜ Overall Rank:</strong></td>
                                    <td style="padding: 8px; text-align: right;">#${userData.rank} of ${userData.totalParticipants} Participants</td>
                                </tr>
                                <tr>
                                    <td style="padding: 8px;"><strong>üìä Total Steps:</strong></td>
                                    <td style="padding: 8px; text-align: right;">${userData.totalSteps.toLocaleString()} steps</td>
                                </tr>
                                <tr>
                                    <td style="padding: 8px;"><strong>üí™ Daily Average:</strong></td>
                                    <td style="padding: 8px; text-align: right;">${userData.avgDaily.toLocaleString()} steps/day</td>
                                </tr>
                                <tr>
                                    <td style="padding: 8px;"><strong>üìÖ Participation:</strong></td>
                                    <td style="padding: 8px; text-align: right;">${userData.daysLogged}/26 days (${Math.round(userData.daysLogged/26*100)}%)</td>
                                </tr>
                                <tr>
                                    <td style="padding: 8px;"><strong>üåç Distance Walked:</strong></td>
                                    <td style="padding: 8px; text-align: right;">${userData.distance} kilometers</td>
                                </tr>
                                <tr>
                                    <td style="padding: 8px;"><strong>üî• Calories Burned:</strong></td>
                                    <td style="padding: 8px; text-align: right;">${userData.calories.toLocaleString()} kcal</td>
                                </tr>
                                <tr>
                                    <td style="padding: 8px;"><strong>üèÖ Achievement Level:</strong></td>
                                    <td style="padding: 8px; text-align: right;">${tier}</td>
                                </tr>
                            </table>
                        </div>
                        
                        <!-- Badges -->
                        <div style="border: 2px solid ${borderColor}; border-radius: 10px; padding: 15px; margin: 20px 0; background: white;">
                            <h3 style="text-align: center; font-size: 14px; color: #333; margin-bottom: 10px;">BADGES & ACHIEVEMENTS EARNED</h3>
                            <div style="font-size: 11px; color: #555; line-height: 1.8;">
                                ${badges.slice(0, 12).map((badge, i) => {
                                    if (i % 2 === 0) {
                                        const nextBadge = badges[i + 1];
                                        return `<div style="display: flex; justify-content: space-between; margin: 4px 0;">
                                            <div style="flex: 1;">${badge.icon} ${badge.name} - ${badge.desc}</div>
                                            ${nextBadge ? `<div style="flex: 1;">${nextBadge.icon} ${nextBadge.name} - ${nextBadge.desc}</div>` : ''}
                                        </div>`;
                                    }
                                    return '';
                                }).join('')}
                                <p style="text-align: center; margin-top: 10px; font-weight: bold;">Total: ${badges.length} Badges Earned</p>
                            </div>
                        </div>
                        
                        <!-- Recognition Text -->
                        <p style="text-align: center; font-size: 12px; color: #555; margin: 20px 0; line-height: 1.6;">
                            In recognition of ${userData.rank <= 3 ? 'outstanding dedication, exceptional performance,' : 'dedication,'} 
                            consistency, and commitment to health and wellness within our community.
                            ${userData.daysLogged === 26 ? '<br><strong>Perfect attendance - logged all 26 days!</strong>' : ''}
                        </p>
                        
                        ${userData.rank <= 3 ? `<p style="text-align: center; font-size: 13px; color: #333; font-weight: bold; margin: 15px 0;">
                            Your achievement inspires the entire community!
                        </p>` : ''}
                        
                        <!-- Footer -->
                        <div style="margin-top: 30px; display: flex; justify-content: space-between; font-size: 11px; color: #666;">
                            <div>Certificate No: AC2026-${String(userData.rank).padStart(3, '0')}</div>
                            <div>Date: January 26, 2026</div>
                        </div>
                        
                        <div style="margin-top: 30px; display: flex; justify-content: space-around;">
                            <div style="text-align: center; border-top: 1px solid #999; padding-top: 5px; width: 200px;">
                                <p style="font-size: 11px; color: #666;">Challenge Organizers</p>
                            </div>
                            <div style="text-align: center; border-top: 1px solid #999; padding-top: 5px; width: 200px;">
                                <p style="font-size: 11px; color: #666;">Community President</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Create temporary container
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = certificateHTML;
            tempDiv.style.position = 'absolute';
            tempDiv.style.left = '-9999px';
            document.body.appendChild(tempDiv);
            
            // Generate PDF
            const element = tempDiv.querySelector('#certificate');
            const opt = {
                margin: 0,
                filename: `Apostrophe_Steps_Challenge_2026_${profile.name.replace(/\s+/g, '_')}_Certificate.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            
            html2pdf().set(opt).from(element).save().then(() => {
                document.body.removeChild(tempDiv);
            });
        }
        
    </script>
</body>
</html>
