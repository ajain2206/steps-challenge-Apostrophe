<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apostrophe - Jan 2026 - Community Steps Challenge</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @keyframes bounceIn {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.05); }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); opacity: 1; }
        }
        .bounce-once { animation: bounceIn 0.6s ease-out; }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-2 sm:p-4">
    <div class="max-w-6xl mx-auto">
        <h1 class="text-2xl sm:text-3xl md:text-4xl font-bold text-center text-indigo-900 mb-2 mt-4">
            üö∂ Apostrophe - Jan 2026 - Community Steps Challenge
        </h1>
        <p class="text-center text-gray-600 mb-4 text-sm sm:text-base">Track your daily steps with your community</p>

        <div id="setupNotice" class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 sm:p-4 mb-4 sm:mb-6">
            <p class="text-xs sm:text-sm text-yellow-800">
                ‚ö†Ô∏è <strong>Setup Required:</strong> Please update the SCRIPT_URL variable in this file with your Google Apps Script Web App URL.
            </p>
        </div>

        <div class="flex justify-center mb-6">
            <div class="bg-white rounded-lg shadow-md p-1 inline-flex w-full max-w-md">
                <button id="btnSubmit" onclick="showView('submit')" class="flex-1 px-4 sm:px-6 py-3 rounded-md font-medium transition-colors bg-blue-600 text-white text-sm sm:text-base">Submit Steps</button>
                <button id="btnRegister" onclick="showView('register')" class="flex-1 px-4 sm:px-6 py-3 rounded-md font-medium transition-colors text-gray-600 hover:bg-gray-100 text-sm sm:text-base">Register</button>
            </div>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4 mb-4 sm:mb-6">
            <div class="bg-white rounded-lg shadow-lg p-4 sm:p-6 border-l-4 border-blue-500">
                <h3 class="text-gray-600 text-xs sm:text-sm font-medium">Total Community Steps</h3>
                <p id="totalSteps" class="text-2xl sm:text-3xl md:text-4xl font-bold text-blue-600 mt-1 sm:mt-2">0</p>
            </div>
            <div class="bg-white rounded-lg shadow-lg p-4 sm:p-6 border-l-4 border-green-500">
                <h3 class="text-gray-600 text-xs sm:text-sm font-medium">Registered Participants</h3>
                <p id="totalParticipants" class="text-2xl sm:text-3xl md:text-4xl font-bold text-green-600 mt-1 sm:mt-2">0</p>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-lg p-4 sm:p-6 mb-4 sm:mb-6">
            <div class="flex items-center justify-between mb-2">
                <h3 class="text-sm sm:text-base md:text-lg font-bold text-gray-800">üéØ Goal: 10M Steps</h3>
                <span id="goalPercentage" class="text-lg sm:text-xl md:text-2xl font-bold text-indigo-600">0%</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-4 sm:h-6 mb-2">
                <div id="goalProgress" class="bg-gradient-to-r from-blue-500 to-indigo-600 h-4 sm:h-6 rounded-full transition-all duration-500" style="width: 0%"></div>
            </div>
            <div class="flex items-center justify-between text-xs sm:text-sm text-gray-600">
                <span id="goalCurrent">0 steps</span>
                <span id="goalRemaining">10,000,000 to go!</span>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-lg p-4 sm:p-6 mb-4 sm:mb-6">
            <h3 class="text-base sm:text-lg font-bold text-gray-800 mb-3 sm:mb-4">üéØ We've Walked:</h3>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-3 sm:gap-4">
                <div class="bg-blue-50 rounded-lg p-3 sm:p-4 border border-blue-100">
                    <div class="text-xl sm:text-2xl mb-1">üåç</div>
                    <div id="statDistance" class="text-lg sm:text-2xl font-bold text-blue-600 mb-1">0 km</div>
                    <div class="text-xs sm:text-sm text-gray-600">Distance Covered</div>
                </div>
                <div class="bg-purple-50 rounded-lg p-3 sm:p-4 border border-purple-100">
                    <div class="text-xl sm:text-2xl mb-1">üèòÔ∏è</div>
                    <div id="statLoops" class="text-lg sm:text-2xl font-bold text-purple-600 mb-1">0</div>
                    <div class="text-xs sm:text-sm text-gray-600">Loops of Apostrophe</div>
                </div>
                <div class="bg-orange-50 rounded-lg p-3 sm:p-4 border border-orange-100">
                    <div class="text-xl sm:text-2xl mb-1">üáÆüá≥</div>
                    <div id="statIndia" class="text-lg sm:text-2xl font-bold text-orange-600 mb-1">0%</div>
                    <div class="text-xs sm:text-sm text-gray-600">Mumbai ‚Üí Delhi</div>
                </div>
                <div class="bg-red-50 rounded-lg p-3 sm:p-4 border border-red-100">
                    <div class="text-xl sm:text-2xl mb-1">üî•</div>
                    <div id="statCalories" class="text-lg sm:text-2xl font-bold text-red-600 mb-1">0</div>
                    <div class="text-xs sm:text-sm text-gray-600">Calories Burned</div>
                </div>
                <div class="bg-green-50 rounded-lg p-3 sm:p-4 border border-green-100">
                    <div class="text-xl sm:text-2xl mb-1">üå≥</div>
                    <div id="statTrees" class="text-lg sm:text-2xl font-bold text-green-600 mb-1">0</div>
                    <div class="text-xs sm:text-sm text-gray-600">Trees Equivalent</div>
                </div>
                <div class="bg-indigo-50 rounded-lg p-3 sm:p-4 border border-indigo-100">
                    <div class="text-xl sm:text-2xl mb-1">üöÄ</div>
                    <div id="statSpace" class="text-lg sm:text-2xl font-bold text-indigo-600 mb-1">0√ó</div>
                    <div class="text-xs sm:text-sm text-gray-600">To Space (100km)</div>
                </div>
            </div>
        </div>

        <div id="loadingIndicator" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-4 sm:p-6 flex items-center gap-3 mx-4">
                <div class="animate-spin rounded-full h-6 w-6 sm:h-8 sm:w-8 border-b-2 border-blue-600"></div>
                <span class="text-gray-700 text-sm sm:text-base">Processing...</span>
            </div>
        </div>

        <div id="milestoneModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div id="milestoneCard" class="bg-white rounded-lg shadow-2xl p-6 sm:p-8 max-w-md mx-4 text-center">
                <div id="milestoneIcon" class="text-6xl sm:text-8xl mb-4">üéâ</div>
                <h2 id="milestoneTitle" class="text-2xl sm:text-3xl font-bold text-gray-800 mb-2">Milestone Reached!</h2>
                <p id="milestoneMessage" class="text-base sm:text-lg text-gray-600 mb-4"></p>
                <div id="milestoneStats" class="bg-blue-50 rounded-lg p-4 mb-6 text-left"></div>
                <button onclick="closeMilestone()" class="w-full bg-gradient-to-r from-blue-500 to-indigo-600 text-white py-3 px-6 rounded-lg hover:from-blue-600 hover:to-indigo-700 transition-all font-semibold text-lg">
                    üéä Awesome! Keep Walking!
                </button>
            </div>
        </div>

        <div id="registerView" class="hidden">
            <div class="bg-white rounded-lg shadow-xl p-4 sm:p-6 mb-4 sm:mb-6">
                <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-3 sm:mb-4">New User Registration</h2>
                <p class="text-sm sm:text-base text-gray-600 mb-4">Register once to start tracking your steps</p>
                <form id="registerForm" class="space-y-3 sm:space-y-4" onsubmit="handleRegister(event)">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Full Name *</label>
                            <input type="text" id="regName" class="w-full px-3 sm:px-4 py-2 sm:py-3 text-sm sm:text-base border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., Ajay Kumar" required/>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Flat Number *</label>
                            <input type="text" id="regFlatNo" class="w-full px-3 sm:px-4 py-2 sm:py-3 text-sm sm:text-base border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., A-101" required/>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Age *</label>
                            <input type="number" id="regAge" class="w-full px-3 sm:px-4 py-2 sm:py-3 text-sm sm:text-base border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., 35" min="1" max="120" required/>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Gender *</label>
                            <select id="regGender" class="w-full px-3 sm:px-4 py-2 sm:py-3 text-sm sm:text-base border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                                <option value="">Select gender</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white py-3 sm:py-4 px-4 sm:px-6 rounded-lg hover:bg-blue-700 transition-colors font-semibold text-base sm:text-lg">Register</button>
                </form>
                <p id="registerStatus" class="text-sm mt-4 text-center"></p>
            </div>

            <div class="bg-white rounded-lg shadow-xl p-4 sm:p-6">
                <h2 class="text-lg sm:text-xl font-bold text-gray-800 mb-3 sm:mb-4">Registered Participants</h2>
                <div id="registeredList" class="space-y-2 max-h-96 overflow-y-auto">
                    <p class="text-gray-500 text-center py-4 text-sm sm:text-base">Loading...</p>
                </div>
            </div>
        </div>

        <div id="submitView">
            <div class="bg-white rounded-lg shadow-xl p-4 sm:p-6 mb-4 sm:mb-6">
                <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-3 sm:mb-4">Submit Your Steps</h2>
                
                <div class="bg-blue-50 border-l-4 border-blue-500 p-3 sm:p-4 mb-4 rounded">
                    <p class="text-sm sm:text-base text-blue-800">
                        <strong>üí° Important:</strong> Submit only your <strong>FINAL step count</strong> for the day. You can only submit <strong>once per day</strong>.
                    </p>
                </div>
                
                <form id="submitForm" class="space-y-3 sm:space-y-4" onsubmit="handleSubmitSteps(event)">
                    <div class="grid grid-cols-1 gap-3 sm:gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Date *</label>
                            <input type="date" id="submitDate" class="w-full px-3 sm:px-4 py-2 sm:py-3 text-sm sm:text-base border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required onchange="checkExistingEntry()"/>
                            <p class="text-xs text-gray-500 mt-1">üí° Select from Jan 1, 2026 onwards</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Select Your Name & Flat *</label>
                            <select id="participantSelect" class="w-full px-3 sm:px-4 py-2 sm:py-3 text-sm sm:text-base border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required onchange="checkExistingEntry()">
                                <option value="">-- Select from registered participants --</option>
                            </select>
                            <p class="text-xs text-gray-500 mt-1">üí° Don't see your name? <a href="#" onclick="showView('register'); return false;" class="text-blue-600 hover:underline font-medium">Register here</a></p>
                        </div>
                        
                        <div id="existingEntryWarning" class="hidden">
                            <div class="bg-yellow-50 border-l-4 border-yellow-500 p-3 sm:p-4 rounded">
                                <div class="flex items-start">
                                    <div class="flex-shrink-0"><span class="text-2xl">‚ö†Ô∏è</span></div>
                                    <div class="ml-3 flex-1">
                                        <h3 class="text-sm sm:text-base font-bold text-yellow-800 mb-2">ALREADY SUBMITTED</h3>
                                        <div id="existingEntryDetails" class="text-xs sm:text-sm text-yellow-700 mb-2"></div>
                                        <p class="text-xs sm:text-sm text-yellow-800">‚úÖ This entry is locked. Please select a different date or verify you selected the correct name.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Steps *</label>
                            <input type="number" id="submitSteps" class="w-full px-3 sm:px-4 py-2 sm:py-3 text-sm sm:text-base border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., 10000" min="0" required/>
                        </div>
                    </div>
                    <button type="submit" id="submitButton" class="w-full bg-blue-600 text-white py-3 sm:py-4 px-4 sm:px-6 rounded-lg hover:bg-blue-700 transition-colors font-semibold text-base sm:text-lg">Submit Steps</button>
                </form>
                <p id="submitStatus" class="text-sm mt-4 text-center"></p>
            </div>

            <button onclick="toggleDashboard()" id="toggleBtn" class="w-full bg-indigo-600 text-white py-3 sm:py-4 px-4 sm:px-6 rounded-lg hover:bg-indigo-700 transition-colors font-semibold mb-4 sm:mb-6 text-base sm:text-lg">
                ‚ñº View Community Dashboard
            </button>

            <div id="dashboard" class="hidden space-y-4 sm:space-y-6">
                <div class="bg-white rounded-lg shadow-lg p-4 sm:p-6">
                    <h2 class="text-lg sm:text-xl md:text-2xl font-bold text-gray-800 mb-3 sm:mb-4">üìà Daily Community Steps</h2>
                    <div class="h-64 sm:h-80"><canvas id="dailyStepsChart"></canvas></div>
                </div>

                <div class="bg-white rounded-lg shadow-lg p-4 sm:p-6">
                    <h2 class="text-lg sm:text-xl md:text-2xl font-bold text-gray-800 mb-3 sm:mb-4">üèÜ Participant Leaderboard</h2>
                    
                    <div class="flex border-b border-gray-200 mb-4">
                        <button id="cumulativeTab" onclick="switchLeaderboardTab('cumulative')" class="px-4 sm:px-6 py-2 sm:py-3 text-sm sm:text-base font-medium border-b-2 border-blue-600 text-blue-600">Cumulative</button>
                        <button id="daywiseTab" onclick="switchLeaderboardTab('daywise')" class="px-4 sm:px-6 py-2 sm:py-3 text-sm sm:text-base font-medium border-b-2 border-transparent text-gray-600 hover:text-gray-800">Day-wise</button>
                    </div>

                    <div id="cumulativeView">
                        <div class="flex flex-col sm:flex-row gap-2 sm:gap-4 mb-4">
                            <div class="flex-1">
                                <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1">Sort by:</label>
                                <select id="sortBy" onchange="loadLeaderboard()" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="steps">Total Steps (High to Low)</option>
                                    <option value="name">Name (A-Z)</option>
                                    <option value="flat">Flat Number</option>
                                </select>
                            </div>
                            <div class="flex-1">
                                <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1">Search:</label>
                                <input type="text" id="searchParticipant" onkeyup="loadLeaderboard()" placeholder="Search by name or flat..." class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"/>
                            </div>
                        </div>

                        <div id="allParticipants" class="space-y-2 max-h-96 overflow-y-auto">
                            <p class="text-gray-500 text-center py-4 text-sm sm:text-base">Loading...</p>
                        </div>
                        <p id="participantCount" class="text-xs sm:text-sm text-gray-600 mt-3 text-center"></p>
                    </div>

                    <div id="daywiseView" class="hidden">
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Select Participant:</label>
                            <select id="daywiseParticipantSelect" onchange="loadDaywiseData()" class="w-full px-3 sm:px-4 py-2 sm:py-3 text-sm sm:text-base border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">-- Select a participant --</option>
                            </select>
                        </div>

                        <div id="daywiseData">
                            <p class="text-gray-500 text-center py-8 text-sm sm:text-base">Select a participant to see their daily breakdown</p>
                        </div>

                        <div class="flex justify-between mt-4">
                            <button id="prevParticipant" onclick="navigateParticipant(-1)" class="px-4 py-2 text-sm bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed" disabled>‚¨ÖÔ∏è Previous</button>
                            <button id="nextParticipant" onclick="navigateParticipant(1)" class="px-4 py-2 text-sm bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed" disabled>Next ‚û°Ô∏è</button>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-lg p-4 sm:p-6 mb-4 sm:mb-6">
                    <h2 class="text-base sm:text-lg md:text-xl font-bold text-gray-800 mb-3 sm:mb-4">üè¢ Building Statistics</h2>
                    <div id="buildingStatsTable" class="overflow-x-auto"></div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6">
                    <div class="bg-white rounded-lg shadow-lg p-4 sm:p-6">
                        <h2 class="text-base sm:text-lg md:text-xl font-bold text-gray-800 mb-3 sm:mb-4">üìä Steps by Age Group & Gender</h2>
                        <div class="hidden md:block h-64"><canvas id="ageChart"></canvas></div>
                        <div id="ageGenderTable" class="block md:hidden"></div>
                    </div>

                    <div class="bg-white rounded-lg shadow-lg p-4 sm:p-6">
                        <h2 class="text-base sm:text-lg md:text-xl font-bold text-gray-800 mb-3 sm:mb-4">Steps by Gender</h2>
                        <div class="h-64"><canvas id="genderChart"></canvas></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwdAp6QU0QXqnf2h3C6EikTf5NMOBBt73q9RJKmhLK9gHufKjevrzHHjkHvqy2Mtrvg/exec';
        let ageChart = null, genderChart = null, buildingChart = null, dailyStepsChart = null, cachedData = null;
        const GOAL_STEPS = 10000000;

        function createUniqueKey(name, flatNo) {
            return (name.toUpperCase().trim() + '_' + flatNo).replace(/\s+/g, '_');
        }

        function showLoading(show) {
            document.getElementById('loadingIndicator').classList.toggle('hidden', !show);
        }

        function showView(view) {
            if (view === 'register') {
                document.getElementById('registerView').classList.remove('hidden');
                document.getElementById('submitView').classList.add('hidden');
                document.getElementById('btnRegister').className = 'flex-1 px-4 sm:px-6 py-3 rounded-md font-medium transition-colors bg-blue-600 text-white text-sm sm:text-base';
                document.getElementById('btnSubmit').className = 'flex-1 px-4 sm:px-6 py-3 rounded-md font-medium transition-colors text-gray-600 hover:bg-gray-100 text-sm sm:text-base';
                loadRegisteredList();
            } else {
                document.getElementById('registerView').classList.add('hidden');
                document.getElementById('submitView').classList.remove('hidden');
                document.getElementById('btnSubmit').className = 'flex-1 px-4 sm:px-6 py-3 rounded-md font-medium transition-colors bg-blue-600 text-white text-sm sm:text-base';
                document.getElementById('btnRegister').className = 'flex-1 px-4 sm:px-6 py-3 rounded-md font-medium transition-colors text-gray-600 hover:bg-gray-100 text-sm sm:text-base';
            }
        }

        async function fetchData() {
            try {
                const response = await fetch(SCRIPT_URL);
                const data = await response.json();
                if (data.success) {
                    cachedData = data;
                    return data;
                } else {
                    throw new Error(data.message || 'Failed to fetch data');
                }
            } catch (error) {
                console.error('Error fetching data:', error);
                showStatus('submitStatus', 'Error loading data. Please refresh the page.', 'error');
                return null;
            }
        }

        async function sendData(action, payload) {
            try {
                showLoading(true);
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({ action: action, ...payload })
                });
                const data = await response.json();
                showLoading(false);
                return data;
            } catch (error) {
                showLoading(false);
                console.error('Error sending data:', error);
                return { success: false, message: 'Error connecting to server. Please try again.' };
            }
        }

        async function handleRegister(event) {
            event.preventDefault();
            const name = document.getElementById('regName').value.trim();
            const flatNo = document.getElementById('regFlatNo').value.trim().toUpperCase();
            const age = parseInt(document.getElementById('regAge').value);
            const gender = document.getElementById('regGender').value;
            
            const result = await sendData('register', { name, flatNo, age, gender });
            
            if (result.success) {
                showStatus('registerStatus', result.message + ' üéâ', 'success');
                document.getElementById('registerForm').reset();
                setTimeout(async () => {
                    await loadData();
                    showView('submit');
                    document.getElementById('registerStatus').textContent = '';
                }, 2000);
            } else {
                showStatus('registerStatus', result.message, 'error');
            }
        }

        function checkExistingEntry() {
            const dateInput = document.getElementById('submitDate');
            const participantSelect = document.getElementById('participantSelect');
            const stepsInput = document.getElementById('submitSteps');
            const submitButton = document.getElementById('submitButton');
            const warningDiv = document.getElementById('existingEntryWarning');
            const detailsDiv = document.getElementById('existingEntryDetails');
            
            const selectedDate = dateInput.value;
            const selectedValue = participantSelect.value;
            
            if (!selectedDate || !selectedValue) {
                warningDiv.classList.add('hidden');
                stepsInput.disabled = false;
                stepsInput.classList.remove('bg-gray-100', 'cursor-not-allowed');
                submitButton.disabled = false;
                submitButton.classList.remove('bg-gray-400', 'cursor-not-allowed');
                submitButton.classList.add('bg
