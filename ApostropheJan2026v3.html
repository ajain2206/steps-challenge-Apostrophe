<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apostrophe - Jan 2026 - Community Steps Challenge</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* One-time bounce animation that auto-stops */
        @keyframes bounceIn {
            0% {
                transform: scale(0.3);
                opacity: 0;
            }
            50% {
                transform: scale(1.05);
            }
            70% {
                transform: scale(0.9);
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        .bounce-once {
            animation: bounceIn 0.6s ease-out;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-2 sm:p-4">
    <div class="max-w-6xl mx-auto">
        <h1 class="text-2xl sm:text-3xl md:text-4xl font-bold text-center text-indigo-900 mb-2 mt-4">
            üö∂ Apostrophe - Jan 2026 - Community Steps Challenge
        </h1>
        <p class="text-center text-gray-600 mb-4 text-sm sm:text-base">Track your daily steps with your community</p>

        <!-- Setup Notice -->
        <div id="setupNotice" class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 sm:p-4 mb-4 sm:mb-6">
            <p class="text-xs sm:text-sm text-yellow-800">
                ‚ö†Ô∏è <strong>Setup Required:</strong> Please update the SCRIPT_URL variable in this file with your Google Apps Script Web App URL.
            </p>
        </div>

        <!-- Toggle between Register and Submit -->
        <div class="flex justify-center mb-6">
            <div class="bg-white rounded-lg shadow-md p-1 inline-flex w-full max-w-md">
                <button
                    id="btnSubmit"
                    onclick="showView('submit')"
                    class="flex-1 px-4 sm:px-6 py-3 rounded-md font-medium transition-colors bg-blue-600 text-white text-sm sm:text-base"
                >
                    Submit Steps
                </button>
                <button
                    id="btnRegister"
                    onclick="showView('register')"
                    class="flex-1 px-4 sm:px-6 py-3 rounded-md font-medium transition-colors text-gray-600 hover:bg-gray-100 text-sm sm:text-base"
                >
                    Register
                </button>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4 mb-4 sm:mb-6">
            <div class="bg-white rounded-lg shadow-lg p-4 sm:p-6 border-l-4 border-blue-500">
                <h3 class="text-gray-600 text-xs sm:text-sm font-medium">Total Community Steps</h3>
                <p id="totalSteps" class="text-2xl sm:text-3xl md:text-4xl font-bold text-blue-600 mt-1 sm:mt-2">0</p>
            </div>
            <div class="bg-white rounded-lg shadow-lg p-4 sm:p-6 border-l-4 border-green-500">
                <h3 class="text-gray-600 text-xs sm:text-sm font-medium">Registered Participants</h3>
                <p id="totalParticipants" class="text-2xl sm:text-3xl md:text-4xl font-bold text-green-600 mt-1 sm:mt-2">0</p>
            </div>
        </div>

        <!-- 20 Million Goal Progress -->
        <div class="bg-white rounded-lg shadow-lg p-4 sm:p-6 mb-4 sm:mb-6">
            <div class="flex items-center justify-between mb-2">
                <h3 class="text-sm sm:text-base md:text-lg font-bold text-gray-800">üéØ Goal: 20M Steps</h3>
                <span id="goalPercentage" class="text-lg sm:text-xl md:text-2xl font-bold text-indigo-600">0%</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-4 sm:h-6 mb-2">
                <div id="goalProgress" class="bg-gradient-to-r from-blue-500 to-indigo-600 h-4 sm:h-6 rounded-full transition-all duration-500" style="width: 0%"></div>
            </div>
            <div class="flex items-center justify-between text-xs sm:text-sm text-gray-600">
                <span id="goalCurrent">0 steps</span>
                <span id="goalRemaining">20,000,000 to go!</span>
            </div>
        </div>

        <!-- Fun Stats Section -->
        <div class="bg-white rounded-lg shadow-lg p-4 sm:p-6 mb-4 sm:mb-6">
            <h3 class="text-base sm:text-lg font-bold text-gray-800 mb-3 sm:mb-4">üéØ We've Walked:</h3>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-3 sm:gap-4">
                <!-- Distance -->
                <div class="bg-blue-50 rounded-lg p-3 sm:p-4 border border-blue-100">
                    <div class="text-xl sm:text-2xl mb-1">üåç</div>
                    <div id="statDistance" class="text-lg sm:text-2xl font-bold text-blue-600 mb-1">0 km</div>
                    <div class="text-xs sm:text-sm text-gray-600">Distance Covered</div>
                </div>
                
                <!-- Society Loops -->
                <div class="bg-purple-50 rounded-lg p-3 sm:p-4 border border-purple-100">
                    <div class="text-xl sm:text-2xl mb-1">üèòÔ∏è</div>
                    <div id="statLoops" class="text-lg sm:text-2xl font-bold text-purple-600 mb-1">0</div>
                    <div class="text-xs sm:text-sm text-gray-600">Loops of Apostrophe</div>
                </div>
                
                <!-- India Journey -->
                <div class="bg-orange-50 rounded-lg p-3 sm:p-4 border border-orange-100">
                    <div class="text-xl sm:text-2xl mb-1">üáÆüá≥</div>
                    <div id="statIndia" class="text-lg sm:text-2xl font-bold text-orange-600 mb-1">0%</div>
                    <div class="text-xs sm:text-sm text-gray-600">Mumbai ‚Üí Delhi</div>
                </div>
                
                <!-- Calories -->
                <div class="bg-red-50 rounded-lg p-3 sm:p-4 border border-red-100">
                    <div class="text-xl sm:text-2xl mb-1">üî•</div>
                    <div id="statCalories" class="text-lg sm:text-2xl font-bold text-red-600 mb-1">0</div>
                    <div class="text-xs sm:text-sm text-gray-600">Calories Burned</div>
                </div>
                
                <!-- Trees Planted -->
                <div class="bg-green-50 rounded-lg p-3 sm:p-4 border border-green-100">
                    <div class="text-xl sm:text-2xl mb-1">üå≥</div>
                    <div id="statTrees" class="text-lg sm:text-2xl font-bold text-green-600 mb-1">0</div>
                    <div class="text-xs sm:text-sm text-gray-600">Trees Equivalent</div>
                </div>
                
                <!-- To Space -->
                <div class="bg-indigo-50 rounded-lg p-3 sm:p-4 border border-indigo-100">
                    <div class="text-xl sm:text-2xl mb-1">üöÄ</div>
                    <div id="statSpace" class="text-lg sm:text-2xl font-bold text-indigo-600 mb-1">0√ó</div>
                    <div class="text-xs sm:text-sm text-gray-600">To Space (100km)</div>
                </div>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div id="loadingIndicator" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-4 sm:p-6 flex items-center gap-3 mx-4">
                <div class="animate-spin rounded-full h-6 w-6 sm:h-8 sm:w-8 border-b-2 border-blue-600"></div>
                <span class="text-gray-700 text-sm sm:text-base">Processing...</span>
            </div>
        </div>

        <!-- Milestone Celebration Modal -->
        <div id="milestoneModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div id="milestoneCard" class="bg-white rounded-lg shadow-2xl p-6 sm:p-8 max-w-md mx-4 text-center">
                <div id="milestoneIcon" class="text-6xl sm:text-8xl mb-4">üéâ</div>
                <h2 id="milestoneTitle" class="text-2xl sm:text-3xl font-bold text-gray-800 mb-2">Milestone Reached!</h2>
                <p id="milestoneMessage" class="text-base sm:text-lg text-gray-600 mb-4"></p>
                <div id="milestoneStats" class="bg-blue-50 rounded-lg p-4 mb-6 text-left">
                    <!-- Stats will be inserted here -->
                </div>
                <button
                    onclick="closeMilestone()"
                    class="w-full bg-gradient-to-r from-blue-500 to-indigo-600 text-white py-3 px-6 rounded-lg hover:from-blue-600 hover:to-indigo-700 transition-all font-semibold text-lg"
                >
                    üéä Awesome! Keep Walking!
                </button>
            </div>
        </div>

        <!-- Registration Form -->
        <div id="registerView" class="hidden">
            <div class="bg-white rounded-lg shadow-xl p-4 sm:p-6 mb-4 sm:mb-6">
                <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-3 sm:mb-4">New User Registration</h2>
                <p class="text-sm sm:text-base text-gray-600 mb-4">Register once to start tracking your steps</p>
                <form id="registerForm" class="space-y-3 sm:space-y-4" onsubmit="handleRegister(event)">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                Full Name *
                            </label>
                            <input
                                type="text"
                                id="regName"
                                class="w-full px-3 sm:px-4 py-2 sm:py-3 text-sm sm:text-base border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                placeholder="e.g., Ajay Kumar"
                                required
                            />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                Flat Number *
                            </label>
                            <input
                                type="text"
                                id="regFlatNo"
                                class="w-full px-3 sm:px-4 py-2 sm:py-3 text-sm sm:text-base border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                placeholder="e.g., A-101"
                                required
                            />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                Age *
                            </label>
                            <input
                                type="number"
                                id="regAge"
                                class="w-full px-3 sm:px-4 py-2 sm:py-3 text-sm sm:text-base border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                placeholder="e.g., 35"
                                min="1"
                                max="120"
                                required
                            />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                Gender *
                            </label>
                            <select
                                id="regGender"
                                class="w-full px-3 sm:px-4 py-2 sm:py-3 text-sm sm:text-base border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                required
                            >
                                <option value="">Select gender</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                    </div>
                    <button
                        type="submit"
                        class="w-full bg-blue-600 text-white py-3 sm:py-4 px-4 sm:px-6 rounded-lg hover:bg-blue-700 transition-colors font-semibold text-base sm:text-lg"
                    >
                        Register
                    </button>
                </form>
                <p id="registerStatus" class="text-sm mt-4 text-center"></p>
            </div>

            <!-- Registered Users List -->
            <div class="bg-white rounded-lg shadow-xl p-4 sm:p-6">
                <h2 class="text-lg sm:text-xl font-bold text-gray-800 mb-3 sm:mb-4">Registered Participants</h2>
                <div id="registeredList" class="space-y-2 max-h-96 overflow-y-auto">
                    <p class="text-gray-500 text-center py-4 text-sm sm:text-base">Loading...</p>
                </div>
            </div>
        </div>

        <!-- Submit Steps Form -->
        <div id="submitView">
            <div class="bg-white rounded-lg shadow-xl p-4 sm:p-6 mb-4 sm:mb-6">
                <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-3 sm:mb-4">Submit Your Steps</h2>
                
                <!-- Important Notice -->
                <div class="bg-blue-50 border-l-4 border-blue-500 p-3 sm:p-4 mb-4 rounded">
                    <p class="text-sm sm:text-base text-blue-800">
                        <strong>üí° Important:</strong> Submit only your <strong>FINAL step count</strong> for the day. 
                        You can only submit <strong>once per day</strong>.
                    </p>
                </div>
                
                <form id="submitForm" class="space-y-3 sm:space-y-4" onsubmit="handleSubmitSteps(event)">
                    <div class="grid grid-cols-1 gap-3 sm:gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                Date *
                            </label>
                            <input
                                type="date"
                                id="submitDate"
                                class="w-full px-3 sm:px-4 py-2 sm:py-3 text-sm sm:text-base border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                required
                                onchange="checkExistingEntry()"
                            />
                            <p class="text-xs text-gray-500 mt-1">üí° Select from Jan 1, 2026 onwards</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                Select Your Name & Flat *
                            </label>
                            <select
                                id="participantSelect"
                                class="w-full px-3 sm:px-4 py-2 sm:py-3 text-sm sm:text-base border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                required
                                onchange="checkExistingEntry()"
                            >
                                <option value="">-- Select from registered participants --</option>
                            </select>
                            <p class="text-xs text-gray-500 mt-1">üí° Don't see your name? <a href="#" onclick="showView('register'); return false;" class="text-blue-600 hover:underline font-medium">Register here</a></p>
                        </div>
                        
                        <!-- Existing Entry Warning (Hidden by default) -->
                        <div id="existingEntryWarning" class="hidden">
                            <div class="bg-yellow-50 border-l-4 border-yellow-500 p-3 sm:p-4 rounded">
                                <div class="flex items-start">
                                    <div class="flex-shrink-0">
                                        <span class="text-2xl">‚ö†Ô∏è</span>
                                    </div>
                                    <div class="ml-3 flex-1">
                                        <h3 class="text-sm sm:text-base font-bold text-yellow-800 mb-2">ALREADY SUBMITTED</h3>
                                        <div id="existingEntryDetails" class="text-xs sm:text-sm text-yellow-700 mb-2"></div>
                                        <p class="text-xs sm:text-sm text-yellow-800">
                                            ‚úÖ This entry is locked. Please select a different date or verify you selected the correct name.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                Steps *
                            </label>
                            <input
                                type="number"
                                id="submitSteps"
                                class="w-full px-3 sm:px-4 py-2 sm:py-3 text-sm sm:text-base border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                placeholder="e.g., 10000"
                                min="0"
                                required
                            />
                        </div>
                    </div>
                    <button
                        type="submit"
                        id="submitButton"
                        class="w-full bg-blue-600 text-white py-3 sm:py-4 px-4 sm:px-6 rounded-lg hover:bg-blue-700 transition-colors font-semibold text-base sm:text-lg"
                    >
                        Submit Steps
                    </button>
                </form>
                <p id="submitStatus" class="text-sm mt-4 text-center"></p>
            </div>

            <!-- Toggle Dashboard -->
            <button
                onclick="toggleDashboard()"
                id="toggleBtn"
                class="w-full bg-indigo-600 text-white py-3 sm:py-4 px-4 sm:px-6 rounded-lg hover:bg-indigo-700 transition-colors font-semibold mb-4 sm:mb-6 text-base sm:text-lg"
            >
                ‚ñº View Community Dashboard
            </button>

            <!-- Dashboard -->
            <div id="dashboard" class="hidden space-y-4 sm:space-y-6">
                <!-- Daily Steps Trend -->
                <div class="bg-white rounded-lg shadow-lg p-4 sm:p-6">
                    <h2 class="text-lg sm:text-xl md:text-2xl font-bold text-gray-800 mb-3 sm:mb-4">üìà Daily Community Steps</h2>
                    <div class="h-64 sm:h-80">
                        <canvas id="dailyStepsChart"></canvas>
                    </div>
                    
                    <!-- Daily Stats Summary -->
                    <div id="dailyStatsPanel" class="mt-4 p-3 sm:p-4 bg-gray-50 rounded-lg border border-gray-200">
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                            <div class="text-center">
                                <p class="text-xs text-gray-600">Today's Steps</p>
                                <p id="todaySteps" class="text-lg sm:text-xl font-bold text-blue-600">-</p>
                            </div>
                            <div class="text-center">
                                <p class="text-xs text-gray-600">Running Average</p>
                                <p id="runningAvg" class="text-lg sm:text-xl font-bold text-green-600">-</p>
                            </div>
                            <div class="text-center">
                                <p class="text-xs text-gray-600">Daily Target</p>
                                <p id="dailyTarget" class="text-lg sm:text-xl font-bold text-red-600">-</p>
                            </div>
                        </div>
                        <div id="dailyStatus" class="mt-3 text-center text-sm font-medium">
                            <!-- Status message will be inserted here -->
                        </div>
                    </div>
                </div>

                <!-- Participant Leaderboard with Tabs -->
                <div class="bg-white rounded-lg shadow-lg p-4 sm:p-6">
                    <h2 class="text-lg sm:text-xl md:text-2xl font-bold text-gray-800 mb-3 sm:mb-4">üèÜ Participant Leaderboard</h2>
                    
                    <!-- Tabs -->
                    <div class="flex border-b border-gray-200 mb-4">
                        <button
                            id="cumulativeTab"
                            onclick="switchLeaderboardTab('cumulative')"
                            class="px-4 sm:px-6 py-2 sm:py-3 text-sm sm:text-base font-medium border-b-2 border-blue-600 text-blue-600"
                        >
                            Cumulative
                        </button>
                        <button
                            id="daywiseTab"
                            onclick="switchLeaderboardTab('daywise')"
                            class="px-4 sm:px-6 py-2 sm:py-3 text-sm sm:text-base font-medium border-b-2 border-transparent text-gray-600 hover:text-gray-800"
                        >
                            Day-wise
                        </button>
                    </div>

                    <!-- Cumulative View -->
                    <div id="cumulativeView">
                        <!-- Sort and Filter Options -->
                        <div class="flex flex-col sm:flex-row gap-2 sm:gap-4 mb-4">
                            <div class="flex-1">
                                <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1">Sort by:</label>
                                <select
                                    id="sortBy"
                                    onchange="loadLeaderboard()"
                                    class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                >
                                    <option value="steps">Total Steps (High to Low)</option>
                                    <option value="avgDaily">Avg Daily Steps (High to Low)</option>
                                    <option value="name">Name (A-Z)</option>
                                    <option value="flat">Flat Number</option>
                                </select>
                            </div>
                            <div class="flex-1">
                                <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1">Search:</label>
                                <input
                                    type="text"
                                    id="searchParticipant"
                                    onkeyup="loadLeaderboard()"
                                    placeholder="Search by name or flat..."
                                    class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                />
                            </div>
                        </div>

                        <!-- All Participants List -->
                        <div id="allParticipants" class="space-y-2 max-h-96 overflow-y-auto">
                            <p class="text-gray-500 text-center py-4 text-sm sm:text-base">Loading...</p>
                        </div>
                        
                        <p id="participantCount" class="text-xs sm:text-sm text-gray-600 mt-3 text-center"></p>
                    </div>

                    <!-- Day-wise View -->
                    <div id="daywiseView" class="hidden">
                        <!-- Participant Selector -->
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Select Participant:</label>
                            <select
                                id="daywiseParticipantSelect"
                                onchange="loadDaywiseData()"
                                class="w-full px-3 sm:px-4 py-2 sm:py-3 text-sm sm:text-base border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            >
                                <option value="">-- Select a participant --</option>
                            </select>
                        </div>

                        <!-- Day-wise Data Display -->
                        <div id="daywiseData">
                            <p class="text-gray-500 text-center py-8 text-sm sm:text-base">Select a participant to see their daily breakdown</p>
                        </div>

                        <!-- Navigation -->
                        <div class="flex justify-between mt-4">
                            <button
                                id="prevParticipant"
                                onclick="navigateParticipant(-1)"
                                class="px-4 py-2 text-sm bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed"
                                disabled
                            >
                                ‚¨ÖÔ∏è Previous
                            </button>
                            <button
                                id="nextParticipant"
                                onclick="navigateParticipant(1)"
                                class="px-4 py-2 text-sm bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed"
                                disabled
                            >
                                Next ‚û°Ô∏è
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Building Chart (Full Width) -->
                <!-- Building Statistics Table with Infographics -->
                <div class="bg-white rounded-lg shadow-lg p-4 sm:p-6 mb-4 sm:mb-6">
                    <h2 class="text-base sm:text-lg md:text-xl font-bold text-gray-800 mb-3 sm:mb-4">üè¢ Building Statistics</h2>
                    <div id="buildingStatsTable" class="overflow-x-auto">
                        <!-- Table will be generated dynamically -->
                    </div>
                </div>

                <!-- Age and Gender Charts (Side by Side) -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6">
                    <div class="bg-white rounded-lg shadow-lg p-4 sm:p-6">
                        <h2 class="text-base sm:text-lg md:text-xl font-bold text-gray-800 mb-3 sm:mb-4">üìä Steps by Age Group & Gender</h2>
                        
                        <!-- Desktop: Grouped Bar Chart -->
                        <div class="hidden md:block h-64">
                            <canvas id="ageChart"></canvas>
                        </div>
                        
                        <!-- Mobile: Table with Progress Bars -->
                        <div id="ageGenderTable" class="block md:hidden">
                            <!-- Table will be generated dynamically -->
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow-lg p-4 sm:p-6">
                        <h2 class="text-base sm:text-lg md:text-xl font-bold text-gray-800 mb-3 sm:mb-4">Steps by Gender</h2>
                        <div class="h-64">
                            <canvas id="genderChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ‚ö†Ô∏è IMPORTANT: Replace this URL with your Google Apps Script Web App URL
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwdAp6QU0QXqnf2h3C6EikTf5NMOBBt73q9RJKmhLK9gHufKjevrzHHjkHvqy2Mtrvg/exec';

        let ageChart = null;
        let genderChart = null;
        let buildingChart = null;
        let dailyStepsChart = null;
        let cachedData = null;

        const GOAL_STEPS = 20000000; // 20 million steps goal

        // Helper function to create unique key from name and flat number
        function createUniqueKey(name, flatNo) {
            return (name.toUpperCase().trim() + '_' + flatNo).replace(/\s+/g, '_');
        }

        // Show/hide loading indicator
        function showLoading(show) {
            document.getElementById('loadingIndicator').classList.toggle('hidden', !show);
        }

        // Show view
        function showView(view) {
            if (view === 'register') {
                document.getElementById('registerView').classList.remove('hidden');
                document.getElementById('submitView').classList.add('hidden');
                document.getElementById('btnRegister').className = 'flex-1 px-4 sm:px-6 py-3 rounded-md font-medium transition-colors bg-blue-600 text-white text-sm sm:text-base';
                document.getElementById('btnSubmit').className = 'flex-1 px-4 sm:px-6 py-3 rounded-md font-medium transition-colors text-gray-600 hover:bg-gray-100 text-sm sm:text-base';
                loadRegisteredList();
            } else {
                document.getElementById('registerView').classList.add('hidden');
                document.getElementById('submitView').classList.remove('hidden');
                document.getElementById('btnSubmit').className = 'flex-1 px-4 sm:px-6 py-3 rounded-md font-medium transition-colors bg-blue-600 text-white text-sm sm:text-base';
                document.getElementById('btnRegister').className = 'flex-1 px-4 sm:px-6 py-3 rounded-md font-medium transition-colors text-gray-600 hover:bg-gray-100 text-sm sm:text-base';
            }
        }

        // Fetch data from Google Sheets
        async function fetchData() {
            try {
                const response = await fetch(SCRIPT_URL);
                const data = await response.json();
                
                if (data.success) {
                    cachedData = data;
                    return data;
                } else {
                    throw new Error(data.message || 'Failed to fetch data');
                }
            } catch (error) {
                console.error('Error fetching data:', error);
                showStatus('submitStatus', 'Error loading data. Please refresh the page.', 'error');
                return null;
            }
        }

        // Send data to Google Sheets
        async function sendData(action, payload) {
            try {
                showLoading(true);
                
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain',
                    },
                    body: JSON.stringify({
                        action: action,
                        ...payload
                    })
                });
                
                const data = await response.json();
                showLoading(false);
                
                return data;
            } catch (error) {
                showLoading(false);
                console.error('Error sending data:', error);
                return {
                    success: false,
                    message: 'Error connecting to server. Please try again.'
                };
            }
        }

        // Handle registration
        async function handleRegister(event) {
            event.preventDefault();
            
            const name = document.getElementById('regName').value.trim();
            const flatNo = document.getElementById('regFlatNo').value.trim().toUpperCase();
            const age = parseInt(document.getElementById('regAge').value);
            const gender = document.getElementById('regGender').value;
            
            const result = await sendData('register', {
                name: name,
                flatNo: flatNo,
                age: age,
                gender: gender
            });
            
            if (result.success) {
                showStatus('registerStatus', result.message + ' üéâ', 'success');
                document.getElementById('registerForm').reset();
                
                setTimeout(async () => {
                    await loadData();
                    showView('submit');
                    document.getElementById('registerStatus').textContent = '';
                }, 2000);
            } else {
                showStatus('registerStatus', result.message, 'error');
            }
        }

        // Check if user already has entry for selected date
        function checkExistingEntry() {
            const dateInput = document.getElementById('submitDate');
            const participantSelect = document.getElementById('participantSelect');
            const stepsInput = document.getElementById('submitSteps');
            const submitButton = document.getElementById('submitButton');
            const warningDiv = document.getElementById('existingEntryWarning');
            const detailsDiv = document.getElementById('existingEntryDetails');
            
            const selectedDate = dateInput.value;
            const selectedValue = participantSelect.value;
            
            // Reset if either is not selected
            if (!selectedDate || !selectedValue) {
                warningDiv.classList.add('hidden');
                stepsInput.disabled = false;
                stepsInput.classList.remove('bg-gray-100', 'cursor-not-allowed');
                submitButton.disabled = false;
                submitButton.classList.remove('bg-gray-400', 'cursor-not-allowed');
                submitButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
                return;
            }
            
            const [uniqueKey, name, flatNo] = selectedValue.split('|');
            
            // Check if this person has entry for this date
            if (!cachedData || !cachedData.steps) return;
            
            const existing = cachedData.steps.find(entry => {
                const entryKey = entry.uniqueKey || createUniqueKey(entry.name, entry.flatNo);
                const entryDate = typeof entry.date === 'string' ? entry.date.split('T')[0] : entry.date.toISOString().split('T')[0];
                return entryKey === uniqueKey && entryDate === selectedDate;
            });
            
            if (existing) {
                // Show warning and disable form
                const [year, month, day] = selectedDate.split('-');
                const d = new Date(year, month - 1, day);
                const formattedDate = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                
                detailsDiv.innerHTML = `
                    <p class="font-semibold">${name} already submitted ${existing.steps.toLocaleString()} steps for ${formattedDate}</p>
                `;
                
                warningDiv.classList.remove('hidden');
                
                // Disable steps input and submit button
                stepsInput.disabled = true;
                stepsInput.value = '';
                stepsInput.classList.add('bg-gray-100', 'cursor-not-allowed');
                
                submitButton.disabled = true;
                submitButton.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                submitButton.classList.add('bg-gray-400', 'cursor-not-allowed');
                submitButton.textContent = 'üîí Already Submitted';
            } else {
                // Hide warning and enable form
                warningDiv.classList.add('hidden');
                
                stepsInput.disabled = false;
                stepsInput.classList.remove('bg-gray-100', 'cursor-not-allowed');
                
                submitButton.disabled = false;
                submitButton.classList.remove('bg-gray-400', 'cursor-not-allowed');
                submitButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
                submitButton.textContent = 'Submit Steps';
            }
        }

        // Handle submit steps
        async function handleSubmitSteps(event) {
            event.preventDefault();
            
            const selectedDate = document.getElementById('submitDate').value;
            const selectedValue = document.getElementById('participantSelect').value;
            const steps = parseInt(document.getElementById('submitSteps').value);
            
            // Parse dates as local dates to avoid timezone issues
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Parse the selected date as local date (not UTC)
            const [year, month, day] = selectedDate.split('-').map(Number);
            const submitDate = new Date(year, month - 1, day);
            submitDate.setHours(0, 0, 0, 0);
            
            const minDate = new Date(2026, 0, 1); // Jan 1, 2026 in local time
            minDate.setHours(0, 0, 0, 0);
            
            if (submitDate > today) {
                showStatus('submitStatus', '‚ùå Cannot submit steps for future dates!', 'error');
                return;
            }
            
            if (submitDate < minDate) {
                showStatus('submitStatus', '‚ùå Date must be January 1, 2026 or later!', 'error');
                return;
            }
            
            if (!selectedValue) {
                showStatus('submitStatus', 'Please select your name from the dropdown', 'error');
                return;
            }
            
            // Parse the selected value (format: "uniqueKey|Name|FlatNo")
            const [uniqueKey, name, flatNo] = selectedValue.split('|');
            
            const result = await sendData('submitSteps', {
                date: selectedDate,
                name: name,
                flatNo: flatNo,
                steps: steps
            });
            
            if (result.success) {
                showStatus('submitStatus', result.message + ' üéâ', 'success');
                document.getElementById('submitForm').reset();
                setDefaultDate(); // Reset date to today
                
                setTimeout(async () => {
                    await loadData();
                    document.getElementById('submitStatus').textContent = '';
                }, 2000);
            } else {
                showStatus('submitStatus', result.message, 'error');
            }
        }

        // Show status message
        function showStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `text-sm mt-4 text-center ${type === 'success' ? 'text-green-600' : 'text-red-600'}`;
        }

        // Get age group
        function getAgeGroup(age) {
            if (age < 18) return 'Under 18';
            if (age <= 30) return '18-30';
            if (age <= 45) return '31-45';
            if (age <= 60) return '46-60';
            return 'Over 60';
        }

        // Set default date to today
        function setDefaultDate() {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            const todayStr = `${yyyy}-${mm}-${dd}`;
            
            const dateInput = document.getElementById('submitDate');
            if (dateInput) {
                dateInput.value = todayStr;
                dateInput.max = todayStr; // Prevent selecting future dates
                dateInput.min = '2026-01-01'; // Minimum date is Jan 1, 2026
            }
        }

        // Load all data
        async function loadData() {
            const data = await fetchData();
            if (data) {
                updateStats(data);
            }
        }

        // Update stats
        function updateStats(data) {
            const totalSteps = data.steps.reduce((sum, entry) => sum + entry.steps, 0);
            
            document.getElementById('totalSteps').textContent = totalSteps.toLocaleString();
            document.getElementById('totalParticipants').textContent = data.profiles.length;
            
            // Update goal progress - show actual percentage (not capped at 100%)
            const percentage = (totalSteps / GOAL_STEPS) * 100;
            const remaining = GOAL_STEPS - totalSteps;
            
            document.getElementById('goalPercentage').textContent = percentage.toFixed(1) + '%';
            // Progress bar visual is capped at 100% for display, but percentage shows actual
            document.getElementById('goalProgress').style.width = Math.min(100, percentage) + '%';
            document.getElementById('goalCurrent').textContent = totalSteps.toLocaleString() + ' steps';
            
            if (remaining > 0) {
                document.getElementById('goalRemaining').textContent = remaining.toLocaleString() + ' to go!';
                document.getElementById('goalRemaining').className = 'text-gray-600';
            } else {
                // Goal exceeded - show how much over
                const exceeded = totalSteps - GOAL_STEPS;
                const exceededPercent = ((exceeded / GOAL_STEPS) * 100).toFixed(1);
                document.getElementById('goalRemaining').textContent = `üéâ Goal Exceeded by ${exceeded.toLocaleString()} steps (+${exceededPercent}%)!`;
                document.getElementById('goalRemaining').className = 'text-green-600 font-bold';
            }
            
            // Update fun stats
            updateFunStats(totalSteps);
            
            // Check for milestone celebrations
            checkMilestones(totalSteps);
            
            // Update participant dropdown
            populateParticipantDropdown(data.profiles);
        }

        // Populate dropdown with registered participants
        function populateParticipantDropdown(profiles) {
            const select = document.getElementById('participantSelect');
            
            // Clear existing options except the first placeholder
            select.innerHTML = '<option value="">-- Select from registered participants --</option>';
            
            // Sort profiles alphabetically by name
            const sortedProfiles = [...profiles].sort((a, b) => a.name.localeCompare(b.name));
            
            // Add option for each registered participant
            sortedProfiles.forEach(profile => {
                const option = document.createElement('option');
                const uniqueKey = profile.uniqueKey || createUniqueKey(profile.name, profile.flatNo);
                
                // Value format: "uniqueKey|Name|FlatNo"
                option.value = `${uniqueKey}|${profile.name}|${profile.flatNo}`;
                
                // Display format: "Name (Flat No)"
                option.textContent = `${profile.name} (${profile.flatNo})`;
                
                select.appendChild(option);
            });
        }

        // Load leaderboard (all participants with sort and filter)
        function loadLeaderboard() {
            if (!window.dashboardData) return;
            
            const { participantSteps, profileMap, steps } = window.dashboardData;
            
            // Get all participants
            let allParticipants = Object.entries(participantSteps)
                .map(([uniqueKey, totalSteps]) => {
                    const completion = calculateCompletion(uniqueKey, steps);
                    return {
                        uniqueKey: uniqueKey,
                        flatNo: profileMap[uniqueKey]?.flatNo || 'Unknown',
                        name: profileMap[uniqueKey]?.name || 'Unknown',
                        steps: totalSteps,
                        ...completion
                    };
                });
            
            // Apply search filter
            const searchTerm = document.getElementById('searchParticipant')?.value.toLowerCase() || '';
            if (searchTerm) {
                allParticipants = allParticipants.filter(p => 
                    p.name.toLowerCase().includes(searchTerm) || 
                    p.flatNo.toLowerCase().includes(searchTerm)
                );
            }
            
            // Calculate average daily for each participant
            allParticipants = allParticipants.map(entry => ({
                ...entry,
                avgDaily: entry.daysSubmitted > 0 ? Math.round(entry.steps / entry.daysSubmitted) : 0
            }));
            
            // Apply sorting
            const sortBy = document.getElementById('sortBy')?.value || 'steps';
            if (sortBy === 'steps') {
                allParticipants.sort((a, b) => b.steps - a.steps);
            } else if (sortBy === 'avgDaily') {
                allParticipants.sort((a, b) => b.avgDaily - a.avgDaily);
            } else if (sortBy === 'name') {
                allParticipants.sort((a, b) => a.name.localeCompare(b.name));
            } else if (sortBy === 'flat') {
                allParticipants.sort((a, b) => a.flatNo.localeCompare(b.flatNo));
            }
            
            // Generate Desktop Table HTML
            const desktopTableHtml = allParticipants.length > 0
                ? `
                <div class="hidden md:block overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b-2 border-gray-300">
                                <th class="text-left py-3 px-2 text-sm font-bold text-gray-700">#</th>
                                <th class="text-left py-3 px-2 text-sm font-bold text-gray-700">Name</th>
                                <th class="text-left py-3 px-2 text-sm font-bold text-gray-700">Flat</th>
                                <th class="text-right py-3 px-2 text-sm font-bold text-gray-700">Total Steps</th>
                                <th class="text-center py-3 px-2 text-sm font-bold text-gray-700">Days</th>
                                <th class="text-right py-3 px-2 text-sm font-bold text-gray-700">Avg/Day</th>
                                <th class="text-left py-3 px-2 text-sm font-bold text-gray-700">Completion</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${allParticipants.map((entry, idx) => `
                                <tr class="border-b border-gray-200 hover:bg-gray-50 transition-colors">
                                    <td class="py-3 px-2 text-sm font-bold text-gray-400">${idx + 1}</td>
                                    <td class="py-3 px-2 text-sm font-semibold text-gray-800">${entry.name}</td>
                                    <td class="py-3 px-2 text-sm text-gray-600">${entry.flatNo}</td>
                                    <td class="py-3 px-2 text-sm font-bold text-blue-600 text-right">${entry.steps.toLocaleString()}</td>
                                    <td class="py-3 px-2 text-sm text-gray-700 text-center">${entry.daysSubmitted}</td>
                                    <td class="py-3 px-2 text-sm font-semibold text-gray-700 text-right">${entry.avgDaily.toLocaleString()}</td>
                                    <td class="py-3 px-2 text-xs">
                                        <span class="inline-flex items-center gap-1">
                                            <span>${entry.statusIcon}</span>
                                            <span class="${entry.statusColor} font-medium">${entry.daysSubmitted}/${entry.totalDays}</span>
                                            <span class="text-gray-500">(${entry.percentage}%)</span>
                                        </span>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                `
                : '<div class="hidden md:block"><p class="text-gray-500 text-center py-4 text-sm sm:text-base">No participants found</p></div>';
            
            // Generate Mobile Cards HTML
            const mobileCardsHtml = allParticipants.length > 0
                ? `
                <div class="block md:hidden space-y-2">
                    ${allParticipants.map((entry, idx) => `
                        <div class="bg-gray-50 rounded-lg p-3 hover:bg-gray-100 transition-colors">
                            <div class="flex items-start justify-between mb-2">
                                <div class="flex items-center gap-2">
                                    <span class="text-sm font-bold text-gray-400">#${idx + 1}</span>
                                    <div>
                                        <p class="font-semibold text-gray-800 text-sm">${entry.name}</p>
                                        <p class="text-xs text-gray-600">Flat ${entry.flatNo}</p>
                                    </div>
                                </div>
                                <p class="text-base font-bold text-blue-600">${entry.steps.toLocaleString()}</p>
                            </div>
                            <div class="flex items-center justify-between text-xs">
                                <div class="flex items-center gap-1 text-gray-700">
                                    <span class="font-medium">${entry.daysSubmitted} days</span>
                                    <span class="text-gray-400">‚Ä¢</span>
                                    <span class="font-semibold">${entry.avgDaily.toLocaleString()} avg/day</span>
                                </div>
                            </div>
                            <div class="mt-1 flex items-center gap-1">
                                <span class="text-base">${entry.statusIcon}</span>
                                <span class="text-xs ${entry.statusColor} font-medium">
                                    ${entry.daysSubmitted}/${entry.totalDays} days
                                </span>
                                <span class="text-xs text-gray-500">(${entry.percentage}%)</span>
                            </div>
                        </div>
                    `).join('')}
                </div>
                `
                : '<div class="block md:hidden"><p class="text-gray-500 text-center py-4 text-sm">No participants found</p></div>';
            
            document.getElementById('allParticipants').innerHTML = desktopTableHtml + mobileCardsHtml;
            document.getElementById('participantCount').textContent = 
                `Showing ${allParticipants.length} participant${allParticipants.length !== 1 ? 's' : ''}`;
            
            // Populate day-wise dropdown
            populateDaywiseDropdown(allParticipants);
        }

        // Calculate completion percentage and missing days
        function calculateCompletion(uniqueKey, allSteps) {
            // Get date range (Jan 1 to today)
            const startDate = new Date('2026-01-01');
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Generate all dates from start to today
            const allDates = [];
            let currentDate = new Date(startDate);
            while (currentDate <= today) {
                allDates.push(currentDate.toISOString().split('T')[0]);
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            // Get dates when user submitted steps
            const userSteps = allSteps.filter(s => {
                const stepKey = s.uniqueKey || createUniqueKey(s.name, s.flatNo);
                return stepKey === uniqueKey;
            });
            
            const submittedDates = new Set(
                userSteps.map(s => {
                    // Handle both Date objects and string dates
                    const dateStr = s.date instanceof Date 
                        ? s.date.toISOString().split('T')[0]
                        : (typeof s.date === 'string' ? s.date.split('T')[0] : s.date);
                    return dateStr;
                })
            );
            
            const totalDays = allDates.length;
            const daysSubmitted = submittedDates.size;
            const daysMissing = totalDays - daysSubmitted;
            const percentage = totalDays > 0 ? Math.round((daysSubmitted / totalDays) * 100) : 0;
            
            // Determine status
            let statusIcon, statusColor, statusText;
            if (percentage >= 90) {
                statusIcon = '‚úÖ';
                statusColor = 'text-green-600';
                statusText = 'Perfect!';
            } else if (percentage >= 70) {
                statusIcon = '‚úÖ';
                statusColor = 'text-green-600';
                statusText = 'Great!';
            } else if (percentage >= 50) {
                statusIcon = '‚ö†Ô∏è';
                statusColor = 'text-yellow-600';
                statusText = 'Good';
            } else if (percentage >= 30) {
                statusIcon = '‚ö†Ô∏è';
                statusColor = 'text-orange-600';
                statusText = 'Need push!';
            } else {
                statusIcon = '‚ùå';
                statusColor = 'text-red-600';
                statusText = 'Come back!';
            }
            
            return {
                totalDays,
                daysSubmitted,
                daysMissing,
                percentage,
                statusIcon,
                statusColor,
                statusText
            };
        }

        // Switch between cumulative and day-wise tabs
        function switchLeaderboardTab(tab) {
            const cumulativeTab = document.getElementById('cumulativeTab');
            const daywiseTab = document.getElementById('daywiseTab');
            const cumulativeView = document.getElementById('cumulativeView');
            const daywiseView = document.getElementById('daywiseView');
            
            if (tab === 'cumulative') {
                cumulativeTab.className = 'px-4 sm:px-6 py-2 sm:py-3 text-sm sm:text-base font-medium border-b-2 border-blue-600 text-blue-600';
                daywiseTab.className = 'px-4 sm:px-6 py-2 sm:py-3 text-sm sm:text-base font-medium border-b-2 border-transparent text-gray-600 hover:text-gray-800';
                cumulativeView.classList.remove('hidden');
                daywiseView.classList.add('hidden');
            } else {
                cumulativeTab.className = 'px-4 sm:px-6 py-2 sm:py-3 text-sm sm:text-base font-medium border-b-2 border-transparent text-gray-600 hover:text-gray-800';
                daywiseTab.className = 'px-4 sm:px-6 py-2 sm:py-3 text-sm sm:text-base font-medium border-b-2 border-blue-600 text-blue-600';
                cumulativeView.classList.add('hidden');
                daywiseView.classList.remove('hidden');
            }
        }

        // Populate day-wise participant dropdown
        function populateDaywiseDropdown(allParticipants) {
            const select = document.getElementById('daywiseParticipantSelect');
            if (!select) return;
            
            // Sort by name for dropdown
            const sorted = [...allParticipants].sort((a, b) => a.name.localeCompare(b.name));
            
            select.innerHTML = '<option value="">-- Select a participant --</option>' +
                sorted.map(p => 
                    `<option value="${p.uniqueKey}">${p.name} (${p.flatNo})</option>`
                ).join('');
        }

        // Load day-wise data for selected participant
        function loadDaywiseData() {
            const select = document.getElementById('daywiseParticipantSelect');
            const uniqueKey = select.value;
            
            if (!uniqueKey || !window.dashboardData) {
                document.getElementById('daywiseData').innerHTML = 
                    '<p class="text-gray-500 text-center py-8 text-sm sm:text-base">Select a participant to see their daily breakdown</p>';
                document.getElementById('prevParticipant').disabled = true;
                document.getElementById('nextParticipant').disabled = true;
                return;
            }
            
            const { profileMap, steps } = window.dashboardData;
            const profile = profileMap[uniqueKey];
            
            // Get all steps for this participant
            const participantSteps = steps.filter(entry => {
                const entryKey = entry.uniqueKey || createUniqueKey(entry.name, entry.flatNo);
                return entryKey === uniqueKey;
            });
            
            if (participantSteps.length === 0) {
                document.getElementById('daywiseData').innerHTML = 
                    '<p class="text-gray-500 text-center py-8 text-sm sm:text-base">No steps recorded yet</p>';
                return;
            }
            
            // Sort by date
            participantSteps.sort((a, b) => {
                const dateA = typeof a.date === 'string' ? a.date : a.date.toISOString();
                const dateB = typeof b.date === 'string' ? b.date : b.date.toISOString();
                return dateA.localeCompare(dateB);
            });
            
            // Calculate total and average
            const totalSteps = participantSteps.reduce((sum, entry) => sum + entry.steps, 0);
            const avgSteps = Math.round(totalSteps / participantSteps.length);
            
            // Generate table HTML
            const tableHtml = `
                <div class="mb-4">
                    <h3 class="text-base sm:text-lg font-bold text-gray-800 mb-2">
                        üìÖ Daily Steps for ${profile.name}
                    </h3>
                    <p class="text-xs sm:text-sm text-gray-600">Flat ${profile.flatNo}</p>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-100 border-b-2 border-gray-200">
                            <tr>
                                <th class="px-2 sm:px-4 py-2 text-left font-semibold text-gray-700">Date</th>
                                <th class="px-2 sm:px-4 py-2 text-right font-semibold text-gray-700">Steps</th>
                                <th class="px-2 sm:px-4 py-2 text-left font-semibold text-gray-700">vs Average</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            ${participantSteps.map(entry => {
                                // Parse date string properly
                                let formattedDate = '';
                                try {
                                    const dateStr = typeof entry.date === 'string' ? entry.date : entry.date.toISOString().split('T')[0];
                                    const parts = dateStr.split('-');
                                    
                                    if (parts.length === 3) {
                                        const year = parseInt(parts[0], 10);
                                        const month = parseInt(parts[1], 10);
                                        const day = parseInt(parts[2], 10);
                                        
                                        // Create date object with explicit numbers
                                        const d = new Date(year, month - 1, day);
                                        
                                        // Verify the date is valid
                                        if (!isNaN(d.getTime())) {
                                            formattedDate = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                                        } else {
                                            formattedDate = dateStr; // Fallback to original string
                                        }
                                    } else {
                                        formattedDate = dateStr; // Fallback to original string
                                    }
                                } catch (e) {
                                    formattedDate = 'Date Error';
                                }
                                
                                const percentage = Math.round((entry.steps / avgSteps) * 100);
                                const barWidth = Math.min(percentage, 100);
                                const barColor = percentage >= 100 ? 'bg-green-500' : percentage >= 75 ? 'bg-blue-500' : 'bg-yellow-500';
                                
                                return `
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-2 sm:px-4 py-2 text-gray-800">${formattedDate}</td>
                                        <td class="px-2 sm:px-4 py-2 text-right font-semibold text-gray-800">${entry.steps.toLocaleString()}</td>
                                        <td class="px-2 sm:px-4 py-2">
                                            <div class="flex items-center gap-2">
                                                <div class="flex-1 bg-gray-200 rounded-full h-2 max-w-[100px]">
                                                    <div class="${barColor} h-2 rounded-full" style="width: ${barWidth}%"></div>
                                                </div>
                                                <span class="text-xs text-gray-600">${percentage}%</span>
                                            </div>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                        <tfoot class="bg-gray-50 border-t-2 border-gray-200">
                            <tr>
                                <td class="px-2 sm:px-4 py-3 font-bold text-gray-800">Total</td>
                                <td class="px-2 sm:px-4 py-3 text-right font-bold text-blue-600">${totalSteps.toLocaleString()}</td>
                                <td class="px-2 sm:px-4 py-3 text-xs sm:text-sm text-gray-600">Avg: ${avgSteps.toLocaleString()}/day</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            `;
            
            document.getElementById('daywiseData').innerHTML = tableHtml;
            
            // Enable/disable navigation buttons
            updateNavigationButtons();
        }

        // Navigate to previous/next participant
        function navigateParticipant(direction) {
            const select = document.getElementById('daywiseParticipantSelect');
            const currentIndex = select.selectedIndex;
            const newIndex = currentIndex + direction;
            
            if (newIndex >= 0 && newIndex < select.options.length) {
                select.selectedIndex = newIndex;
                loadDaywiseData();
            }
        }

        // Update navigation button states
        function updateNavigationButtons() {
            const select = document.getElementById('daywiseParticipantSelect');
            const prevBtn = document.getElementById('prevParticipant');
            const nextBtn = document.getElementById('nextParticipant');
            
            if (!select.value) {
                prevBtn.disabled = true;
                nextBtn.disabled = true;
                return;
            }
            
            prevBtn.disabled = select.selectedIndex <= 1; // 0 is "Select a participant"
            nextBtn.disabled = select.selectedIndex >= select.options.length - 1;
        }

        // Load registered list
        function loadRegisteredList() {
            if (!cachedData) return;
            
            const profiles = cachedData.profiles;
            
            const listHtml = profiles.length > 0
                ? profiles.map(profile => `
                    <div class="flex items-center justify-between p-2 sm:p-3 bg-gray-50 rounded-lg">
                        <div>
                            <p class="font-semibold text-gray-800 text-sm sm:text-base">${profile.name}</p>
                            <p class="text-xs sm:text-sm text-gray-600">Flat ${profile.flatNo} ‚Ä¢ ${profile.age} years ‚Ä¢ ${profile.gender}</p>
                        </div>
                    </div>
                `).join('')
                : '<p class="text-gray-500 text-center py-4 text-sm sm:text-base">No participants registered yet</p>';
            
            document.getElementById('registeredList').innerHTML = listHtml;
        }

        // Load dashboard
        function loadDashboard() {
            if (!cachedData) return;
            
            const profiles = cachedData.profiles;
            const steps = cachedData.steps;

            let byAge = { 'Under 18': 0, '18-30': 0, '31-45': 0, '46-60': 0, 'Over 60': 0 };
            let byGender = { 'Male': 0, 'Female': 0, 'Other': 0 };
            let byAgeGender = {
                'Under 18': { 'Male': 0, 'Female': 0, 'Other': 0 },
                '18-30': { 'Male': 0, 'Female': 0, 'Other': 0 },
                '31-45': { 'Male': 0, 'Female': 0, 'Other': 0 },
                '46-60': { 'Male': 0, 'Female': 0, 'Other': 0 },
                'Over 60': { 'Male': 0, 'Female': 0, 'Other': 0 }
            };
            let byBuilding = {}; // Track by building
            let buildingParticipants = {}; // Track unique participants per building
            let participantSteps = {}; // Track by unique key (name + flat)
            let dailySteps = {}; // Track daily aggregate

            // Create a map of profiles by unique key
            const profileMap = {};
            profiles.forEach(profile => {
                const uniqueKey = profile.uniqueKey || createUniqueKey(profile.name, profile.flatNo);
                profileMap[uniqueKey] = profile;
            });

            // Calculate stats
            steps.forEach(entry => {
                const uniqueKey = entry.uniqueKey || createUniqueKey(entry.name, entry.flatNo);
                const profile = profileMap[uniqueKey];
                
                if (profile) {
                    participantSteps[uniqueKey] = (participantSteps[uniqueKey] || 0) + entry.steps;

                    const ageGroup = getAgeGroup(profile.age);
                    byAge[ageGroup] += entry.steps;
                    byGender[profile.gender] += entry.steps;
                    byAgeGender[ageGroup][profile.gender] += entry.steps;
                    
                    // Extract building from flat number (first character)
                    const building = profile.flatNo.charAt(0).toUpperCase();
                    byBuilding[building] = (byBuilding[building] || 0) + entry.steps;
                    
                    // Track unique participants per building
                    if (!buildingParticipants[building]) {
                        buildingParticipants[building] = new Set();
                    }
                    buildingParticipants[building].add(uniqueKey);
                    
                    // Aggregate by date
                    const dateKey = entry.date instanceof Date 
                        ? entry.date.toISOString().split('T')[0]
                        : (typeof entry.date === 'string' ? entry.date.split('T')[0] : entry.date);
                    
                    // DEBUG: Log first date processing
                    if (Object.keys(dailySteps).length === 0) {
                        console.log('DEBUG LoadDashboard - First entry date:', entry.date);
                        console.log('DEBUG LoadDashboard - Date type:', typeof entry.date);
                        console.log('DEBUG LoadDashboard - Date key:', dateKey);
                    }
                    
                    dailySteps[dateKey] = (dailySteps[dateKey] || 0) + entry.steps;
                }
            });

            // Store for use in leaderboard
            window.dashboardData = {
                participantSteps,
                profileMap,
                steps
            };

            // Load leaderboard (all participants)
            loadLeaderboard();

            // Update charts
            updateCharts(byAge, byGender, byAgeGender, byBuilding, buildingParticipants, dailySteps);
            
            // Update fun stats
            const totalSteps = Object.values(participantSteps).reduce((sum, steps) => sum + steps, 0);
            updateFunStats(totalSteps);
        }

        // Update charts
        function updateCharts(byAge, byGender, byAgeGender, byBuilding, buildingParticipants, dailySteps) {
            console.log('=== UPDATE CHARTS CALLED ===');
            console.log('Screen width:', window.innerWidth);
            console.log('Is mobile:', window.innerWidth < 768);
            
            // On mobile, add small delay to ensure DOM is ready
            const isMobile = window.innerWidth < 768;
            const renderDelay = isMobile ? 300 : 0;
            
            setTimeout(() => {
                console.log('Starting chart rendering (after', renderDelay, 'ms delay)');
                
                const ageData = Object.entries(byAge).filter(([_, steps]) => steps > 0);
                const genderData = Object.entries(byGender).filter(([_, steps]) => steps > 0);
                const buildingData = Object.entries(byBuilding).filter(([_, steps]) => steps > 0);
                
                console.log('Chart data:', {
                    ageData: ageData.length,
                    genderData: genderData.length,
                    buildingData: buildingData.length
                });

            // Sort building data alphabetically for consistent display
            buildingData.sort((a, b) => a[0].localeCompare(b[0]));
            
            // Calculate total days from start to today
            const startDate = new Date('2026-01-01');
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const totalDays = Math.ceil((today - startDate) / (1000 * 60 * 60 * 24)) + 1; // +1 to include start day
            
            console.log(`Total days in challenge: ${totalDays} (Jan 1 to ${today.toISOString().split('T')[0]})`);
            
            // Calculate building stats - all 5 metrics
            const buildingStats = {};
            buildingData.forEach(([building, totalSteps]) => {
                const participantCount = buildingParticipants[building] ? buildingParticipants[building].size : 0;
                
                // Metric 3: Daily Average Steps (building total per day)
                const dailyAvgSteps = totalDays > 0 ? Math.round(totalSteps / totalDays) : 0;
                
                // Metric 4: Participant Average Steps (total per person)
                const participantAvgSteps = participantCount > 0 ? Math.round(totalSteps / participantCount) : 0;
                
                // Metric 5: Daily Per Participant Average
                const dailyPerParticipantAvg = (participantCount > 0 && totalDays > 0) 
                    ? Math.round(totalSteps / (participantCount * totalDays)) 
                    : 0;
                
                buildingStats[building] = {
                    totalSteps: totalSteps,                       // Metric 1
                    participants: participantCount,                // Metric 2
                    dailyAvgSteps: dailyAvgSteps,                 // Metric 3
                    participantAvgSteps: participantAvgSteps,     // Metric 4
                    dailyPerParticipantAvg: dailyPerParticipantAvg // Metric 5
                };
                
                console.log(`Building ${building}: Total: ${totalSteps}, Participants: ${participantCount}, Daily avg: ${dailyAvgSteps}, Per participant: ${participantAvgSteps}, Daily per participant: ${dailyPerParticipantAvg}`);
            });

            // Daily steps chart with average and target
            const dailyCtx = document.getElementById('dailyStepsChart').getContext('2d');
            if (dailyStepsChart) dailyStepsChart.destroy();
            
            if (dailySteps && Object.keys(dailySteps).length > 0) {
                // Sort by date
                const sortedDaily = Object.entries(dailySteps).sort((a, b) => {
                    return new Date(a[0]) - new Date(b[0]);
                });
                
                // Get last 30 days or all available data
                const recentDaily = sortedDaily.slice(-30);
                
                // Calculate running average for each day
                const runningAverages = [];
                let cumulativeSteps = 0;
                recentDaily.forEach(([date, steps], index) => {
                    cumulativeSteps += steps;
                    const avg = Math.round(cumulativeSteps / (index + 1));
                    runningAverages.push(avg);
                });
                
                // Calculate DYNAMIC daily target based on remaining steps and days
                // Challenge runs from Jan 1 to Jan 26, 2026 (26 days)
                const CHALLENGE_START = new Date('2026-01-01');
                const CHALLENGE_END = new Date('2026-01-26');
                const TOTAL_CHALLENGE_DAYS = 26;
                
                const dynamicTargets = [];
                let cumulativeForTarget = 0;
                
                recentDaily.forEach(([dateStr, steps], index) => {
                    // Calculate cumulative steps up to (but not including) this day
                    // This represents what we had accomplished before this day started
                    
                    // Calculate which day of challenge this is (1-26)
                    const currentDate = new Date(dateStr);
                    const dayNumber = Math.floor((currentDate - CHALLENGE_START) / (1000 * 60 * 60 * 24)) + 1;
                    
                    // Calculate remaining steps and days BEFORE this day's steps were logged
                    const remainingSteps = GOAL_STEPS - cumulativeForTarget;
                    const remainingDays = TOTAL_CHALLENGE_DAYS - dayNumber + 1; // +1 because this day is included
                    
                    // Calculate what the target should be for this day
                    const targetForDay = remainingDays > 0 ? Math.round(remainingSteps / remainingDays) : 0;
                    dynamicTargets.push(targetForDay);
                    
                    // Add this day's steps to cumulative for next iteration
                    cumulativeForTarget += steps;
                });
                
                // Get the CURRENT daily target (today's target)
                const currentDailyTarget = dynamicTargets[dynamicTargets.length - 1];
                
                // Update stats panel
                const todaySteps = recentDaily[recentDaily.length - 1][1];
                const currentAvg = runningAverages[runningAverages.length - 1];
                
                document.getElementById('todaySteps').textContent = todaySteps.toLocaleString();
                document.getElementById('runningAvg').textContent = currentAvg.toLocaleString() + '/day';
                document.getElementById('dailyTarget').textContent = currentDailyTarget.toLocaleString() + '/day';
                
                // Calculate status message
                const vsAvg = todaySteps - currentAvg;
                const vsTarget = todaySteps - currentDailyTarget;
                let statusMsg = '';
                let statusClass = '';
                
                if (vsTarget >= 0 && vsAvg >= 0) {
                    statusMsg = `üü¢ Excellent! Today is +${vsAvg.toLocaleString()} vs average and +${vsTarget.toLocaleString()} vs target`;
                    statusClass = 'text-green-600';
                } else if (vsTarget >= 0) {
                    statusMsg = `‚úÖ Good! Above target by ${vsTarget.toLocaleString()} steps`;
                    statusClass = 'text-green-600';
                } else if (vsAvg >= 0) {
                    statusMsg = `üìä Above average by ${vsAvg.toLocaleString()}, but ${Math.abs(vsTarget).toLocaleString()} below target`;
                    statusClass = 'text-yellow-600';
                } else {
                    statusMsg = `‚ö†Ô∏è Below both average (${Math.abs(vsAvg).toLocaleString()}) and target (${Math.abs(vsTarget).toLocaleString()})`;
                    statusClass = 'text-red-600';
                }
                
                document.getElementById('dailyStatus').innerHTML = `<span class="${statusClass}">${statusMsg}</span>`;
                
                dailyStepsChart = new Chart(dailyCtx, {
                    type: 'bar',
                    data: {
                        labels: recentDaily.map(([date]) => {
                            // Parse date as local date to avoid timezone issues
                            const [year, month, day] = date.split('-').map(Number);
                            const d = new Date(year, month - 1, day);
                            const label = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                            
                            // DEBUG: Log first date to console
                            if (date === recentDaily[0][0]) {
                                console.log('DEBUG Chart - Raw date:', date);
                                console.log('DEBUG Chart - Parsed:', year, month, day);
                                console.log('DEBUG Chart - Date object:', d);
                                console.log('DEBUG Chart - Label:', label);
                            }
                            
                            return label;
                        }),
                        datasets: [
                            {
                                label: 'Daily Steps',
                                data: recentDaily.map(([_, steps]) => steps),
                                type: 'bar',
                                backgroundColor: 'rgba(59, 130, 246, 0.7)',
                                borderColor: 'rgb(59, 130, 246)',
                                borderWidth: 1,
                                order: 3
                            },
                            {
                                label: 'Running Average',
                                data: runningAverages,
                                type: 'line',
                                borderColor: 'rgb(34, 197, 94)',
                                backgroundColor: 'transparent',
                                borderWidth: 2,
                                pointRadius: 3,
                                pointBackgroundColor: 'rgb(34, 197, 94)',
                                tension: 0.4,
                                order: 2
                            },
                            {
                                label: 'Daily Target',
                                data: dynamicTargets,
                                type: 'line',
                                borderColor: 'rgb(239, 68, 68)',
                                backgroundColor: 'transparent',
                                borderWidth: 2,
                                borderDash: [5, 5],
                                pointRadius: 0,
                                tension: 0.2,  // Slight curve since target changes over time
                                order: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'bottom',
                                labels: {
                                    usePointStyle: true,
                                    padding: 15,
                                    font: {
                                        size: 11
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.dataset.label || '';
                                        const value = context.parsed.y.toLocaleString();
                                        
                                        if (label === 'Daily Steps') {
                                            const avg = runningAverages[context.dataIndex];
                                            const target = dynamicTargets[context.dataIndex];
                                            const vsAvg = context.parsed.y - avg;
                                            const vsTarget = context.parsed.y - target;
                                            return [
                                                `${label}: ${value}`,
                                                `vs Average: ${vsAvg >= 0 ? '+' : ''}${vsAvg.toLocaleString()}`,
                                                `vs Target: ${vsTarget >= 0 ? '+' : ''}${vsTarget.toLocaleString()}`
                                            ];
                                        }
                                        
                                        return `${label}: ${value}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return value >= 1000 ? (value / 1000) + 'K' : value;
                                    }
                                }
                            },
                            x: {
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 45
                                }
                            }
                        }
                    }
                });
            }

            // Building Statistics Table with Infographics
            
            // Generate distinct colors for each building
            const buildingColors = [
                '#3b82f6', // Blue
                '#ef4444', // Red
                '#10b981', // Green
                '#f59e0b', // Amber
                '#8b5cf6', // Violet
                '#ec4899', // Pink
                '#14b8a6', // Teal
                '#f97316', // Orange
            ];
            
            const buildingStatsTableDiv = document.getElementById('buildingStatsTable');
            
            if (!buildingStatsTableDiv) {
                console.error('ERROR: buildingStatsTable element not found!');
            } else if (buildingData.length > 0) {
                console.log('Creating building statistics table...');
                console.log('Building data:', buildingData);
                console.log('Building stats:', buildingStats);
                
                // Calculate max values for progress bars
                const maxSteps = Math.max(...buildingData.map(([_, steps]) => steps));
                const maxParticipants = Math.max(...buildingData.map(([building]) => buildingStats[building].participants));
                const maxDailyAvg = Math.max(...buildingData.map(([building]) => buildingStats[building].dailyPerParticipantAvg));
                
                // Find winners
                const stepsWinner = buildingData.reduce((max, curr) => curr[1] > max[1] ? curr : max, buildingData[0])[0];
                const participantsWinner = buildingData.reduce((max, curr) => 
                    buildingStats[curr[0]].participants > buildingStats[max[0]].participants ? curr : max, buildingData[0])[0];
                const dailyAvgWinner = buildingData.reduce((max, curr) => 
                    buildingStats[curr[0]].dailyPerParticipantAvg > buildingStats[max[0]].dailyPerParticipantAvg ? curr : max, buildingData[0])[0];
                
                // Create mobile card view
                let mobileCardsHTML = '<div class="block md:hidden space-y-3">';
                
                buildingData.forEach(([building, totalSteps], idx) => {
                    const stats = buildingStats[building];
                    const color = buildingColors[idx % buildingColors.length];
                    const stepsPercent = (totalSteps / maxSteps) * 100;
                    const participantsPercent = (stats.participants / maxParticipants) * 100;
                    const dailyAvgPercent = (stats.dailyPerParticipantAvg / maxDailyAvg) * 100;
                    
                    // Badges for winners
                    const stepsWinnerBadge = building === stepsWinner ? '<span class="ml-1 inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-yellow-100 text-yellow-800">üèÜ</span>' : '';
                    const participantsWinnerBadge = building === participantsWinner ? '<span class="ml-1 inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800">üë•</span>' : '';
                    const dailyAvgWinnerBadge = building === dailyAvgWinner ? '<span class="ml-1 inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800">‚≠ê</span>' : '';
                    
                    mobileCardsHTML += `
                        <div class="bg-white border rounded-lg p-3 shadow-sm" style="border-left-color: ${color}; border-left-width: 3px;">
                            <!-- Header -->
                            <div class="flex items-center justify-between mb-2">
                                <div class="flex items-center">
                                    <div class="w-3 h-3 rounded-full mr-1.5" style="background-color: ${color}"></div>
                                    <h3 class="text-base font-bold text-gray-900">Building ${building}</h3>
                                </div>
                            </div>
                            
                            <!-- All metrics in compact rows -->
                            <div class="space-y-2 text-sm">
                                <!-- Total Steps -->
                                <div>
                                    <div class="flex items-center justify-between mb-0.5">
                                        <span class="text-xs font-medium text-gray-500">Steps</span>
                                        <div class="flex items-center">
                                            <span class="font-bold text-gray-900">${totalSteps.toLocaleString()}</span>
                                            ${stepsWinnerBadge}
                                        </div>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-1.5">
                                        <div class="h-1.5 rounded-full transition-all duration-500" style="width: ${stepsPercent}%; background-color: ${color}"></div>
                                    </div>
                                </div>
                                
                                <!-- Participants -->
                                <div>
                                    <div class="flex items-center justify-between mb-0.5">
                                        <span class="text-xs font-medium text-gray-500">Participants</span>
                                        <div class="flex items-center">
                                            <span class="font-bold text-gray-900">üë• ${stats.participants}</span>
                                            ${participantsWinnerBadge}
                                        </div>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-1.5">
                                        <div class="h-1.5 rounded-full transition-all duration-500" style="width: ${participantsPercent}%; background-color: ${color}"></div>
                                    </div>
                                </div>
                                
                                <!-- Daily Avg -->
                                <div>
                                    <div class="flex items-center justify-between mb-0.5">
                                        <span class="text-xs font-medium text-gray-500">Daily Avg</span>
                                        <div class="flex items-center">
                                            <span class="font-bold text-gray-900">${stats.dailyPerParticipantAvg.toLocaleString()}</span>
                                            ${dailyAvgWinnerBadge}
                                        </div>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-1.5">
                                        <div class="h-1.5 rounded-full transition-all duration-500" style="width: ${dailyAvgPercent}%; background-color: ${color}"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                mobileCardsHTML += '</div>';
                
                // Create desktop table view
                let tableHTML = `
                    <div class="hidden md:block">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Building
                                    </th>
                                    <th scope="col" class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Total Steps
                                    </th>
                                    <th scope="col" class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Participants
                                    </th>
                                    <th scope="col" class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Daily Avg/Person
                                    </th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                `;
                
                // Add rows for each building
                buildingData.forEach(([building, totalSteps], idx) => {
                    const stats = buildingStats[building];
                    const color = buildingColors[idx % buildingColors.length];
                    const stepsPercent = (totalSteps / maxSteps) * 100;
                    const participantsPercent = (stats.participants / maxParticipants) * 100;
                    const dailyAvgPercent = (stats.dailyPerParticipantAvg / maxDailyAvg) * 100;
                    
                    // Badges for winners
                    const stepsWinnerBadge = building === stepsWinner ? ' <span class="ml-2 inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-yellow-100 text-yellow-800">üèÜ Highest</span>' : '';
                    const participantsWinnerBadge = building === participantsWinner ? ' <span class="ml-1 sm:ml-2 inline-flex items-center px-1.5 sm:px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800">üë• Most</span>' : '';
                    const dailyAvgWinnerBadge = building === dailyAvgWinner ? ' <span class="ml-1 sm:ml-2 inline-flex items-center px-1.5 sm:px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800">‚≠ê Most Active</span>' : '';
                    
                    tableHTML += `
                        <tr class="hover:bg-gray-50 transition-colors">
                            <td class="px-3 sm:px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center">
                                    <div class="w-3 h-10 sm:w-4 sm:h-12 rounded-full mr-3" style="background-color: ${color}"></div>
                                    <div class="text-sm font-medium text-gray-900">Building ${building}</div>
                                </div>
                            </td>
                            <td class="px-3 sm:px-6 py-4">
                                <div class="flex flex-col">
                                    <div class="flex items-center justify-between mb-1">
                                        <span class="text-sm font-semibold text-gray-900">${totalSteps.toLocaleString()}</span>
                                        ${stepsWinnerBadge}
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-2">
                                        <div class="h-2 rounded-full transition-all duration-500" style="width: ${stepsPercent}%; background-color: ${color}"></div>
                                    </div>
                                </div>
                            </td>
                            <td class="px-3 sm:px-6 py-4">
                                <div class="flex flex-col">
                                    <div class="flex items-center justify-between mb-1">
                                        <span class="text-sm font-semibold text-gray-900">
                                            <span class="text-base sm:text-lg">üë•</span> ${stats.participants}
                                        </span>
                                        ${participantsWinnerBadge}
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-2">
                                        <div class="h-2 rounded-full transition-all duration-500" style="width: ${participantsPercent}%; background-color: ${color}"></div>
                                    </div>
                                </div>
                            </td>
                            <td class="px-3 sm:px-6 py-4">
                                <div class="flex flex-col">
                                    <div class="flex items-center justify-between mb-1">
                                        <span class="text-sm font-semibold text-gray-900">${stats.dailyPerParticipantAvg.toLocaleString()} <span class="text-xs text-gray-500">steps/day</span></span>
                                        ${dailyAvgWinnerBadge}
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-2">
                                        <div class="h-2 rounded-full transition-all duration-500" style="width: ${dailyAvgPercent}%; background-color: ${color}"></div>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                tableHTML += `
                            </tbody>
                        </table>
                    </div>
                `;
                
                // Combine mobile cards and desktop table with shared legend
                const combinedHTML = `
                    ${mobileCardsHTML}
                    ${tableHTML}
                    
                    <!-- Legend (shared between mobile and desktop) -->
                    <div class="mt-4 flex flex-wrap gap-3 sm:gap-4 text-xs sm:text-sm text-gray-600 justify-center sm:justify-start">
                        <div class="flex items-center">
                            <span class="w-3 h-3 rounded-full mr-2" style="background-color: #fef3c7"></span>
                            <span>üèÜ = Highest Total Steps</span>
                        </div>
                        <div class="flex items-center">
                            <span class="w-3 h-3 rounded-full mr-2" style="background-color: #dbeafe"></span>
                            <span>üë• = Most Participants</span>
                        </div>
                        <div class="flex items-center">
                            <span class="w-3 h-3 rounded-full mr-2" style="background-color: #d1fae5"></span>
                            <span>‚≠ê = Most Active per Person</span>
                        </div>
                    </div>
                `;
                
                buildingStatsTableDiv.innerHTML = combinedHTML;
                
                console.log('Building statistics created successfully (cards for mobile, table for desktop)');
                console.log('Winners: Steps:', stepsWinner, 'Participants:', participantsWinner, 'Daily Avg:', dailyAvgWinner);
            } else {
                buildingStatsTableDiv.innerHTML = '<p class="text-gray-500 text-center py-8">No building data to display</p>';
                console.log('No building data to display');
            }


            // Age chart with gender split
            const ageCtxElement = document.getElementById('ageChart');
            const ageGenderTableDiv = document.getElementById('ageGenderTable');
            console.log('Age chart element:', ageCtxElement);
            console.log('Age gender table element:', ageGenderTableDiv);
            
            if (ageData.length > 0) {
                // Prepare datasets for grouped bar chart (Male/Female side-by-side)
                const ageGroups = ageData.map(([age]) => age);
                const maleData = ageGroups.map(ageGroup => byAgeGender[ageGroup]['Male'] || 0);
                const femaleData = ageGroups.map(ageGroup => byAgeGender[ageGroup]['Female'] || 0);
                const otherData = ageGroups.map(ageGroup => byAgeGender[ageGroup]['Other'] || 0);
                
                console.log('Age groups:', ageGroups);
                console.log('Male data:', maleData);
                console.log('Female data:', femaleData);
                
                // Desktop: Create grouped bar chart
                if (ageCtxElement) {
                    const ageCtx = ageCtxElement.getContext('2d');
                    if (ageChart) ageChart.destroy();
                    
                    const datasets = [
                        {
                            label: '‚ôÇ Male',
                            data: maleData,
                            backgroundColor: '#3b82f6',
                            borderWidth: 0
                        },
                        {
                            label: '‚ôÄ Female',
                            data: femaleData,
                            backgroundColor: '#ec4899',
                            borderWidth: 0
                        }
                    ];
                    
                    // Only add Other if there's data
                    if (otherData.some(val => val > 0)) {
                        datasets.push({
                            label: 'Other',
                            data: otherData,
                            backgroundColor: '#8b5cf6',
                            borderWidth: 0
                        });
                    }
                    
                    ageChart = new Chart(ageCtx, {
                        type: 'bar',
                        data: {
                            labels: ageGroups,
                            datasets: datasets
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'bottom'
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const label = context.dataset.label;
                                            const value = context.parsed.y.toLocaleString();
                                            const ageGroup = context.label;
                                            const total = maleData[context.dataIndex] + femaleData[context.dataIndex] + otherData[context.dataIndex];
                                            const percentage = total > 0 ? ((context.parsed.y / total) * 100).toFixed(0) : 0;
                                            return `${label}: ${value} steps (${percentage}%)`;
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: function(value) {
                                            return value >= 1000 ? (value / 1000) + 'K' : value;
                                        }
                                    }
                                },
                                x: {
                                    ticks: {
                                        maxRotation: 45,
                                        minRotation: 45
                                    }
                                }
                            }
                        }
                    });
                    console.log('Age chart with gender created successfully (grouped bars)');
                }
                
                // Mobile: Create table with progress bars
                if (ageGenderTableDiv) {
                    let tableHTML = '<div class="space-y-3">';
                    
                    ageGroups.forEach((ageGroup, idx) => {
                        const male = maleData[idx];
                        const female = femaleData[idx];
                        const other = otherData[idx];
                        const total = male + female + other;
                        
                        if (total === 0) return; // Skip empty age groups
                        
                        const malePercent = total > 0 ? Math.round((male / total) * 100) : 0;
                        const femalePercent = total > 0 ? Math.round((female / total) * 100) : 0;
                        const otherPercent = total > 0 ? Math.round((other / total) * 100) : 0;
                        
                        tableHTML += `
                            <div class="bg-white border rounded-lg p-3 shadow-sm">
                                <div class="flex items-center justify-between mb-2">
                                    <h3 class="text-sm font-bold text-gray-900">${ageGroup}</h3>
                                    <span class="text-xs text-gray-500">${total.toLocaleString()}</span>
                                </div>
                                
                                <!-- Male -->
                                <div class="mb-2">
                                    <div class="flex justify-between text-xs mb-1">
                                        <span class="text-gray-600">‚ôÇ Male</span>
                                        <span class="font-bold text-gray-900">${male.toLocaleString()} (${malePercent}%)</span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-1.5">
                                        <div class="h-1.5 rounded-full bg-blue-500 transition-all duration-500" style="width: ${malePercent}%"></div>
                                    </div>
                                </div>
                                
                                <!-- Female -->
                                <div${other > 0 ? ' class="mb-2"' : ''}>
                                    <div class="flex justify-between text-xs mb-1">
                                        <span class="text-gray-600">‚ôÄ Female</span>
                                        <span class="font-bold text-gray-900">${female.toLocaleString()} (${femalePercent}%)</span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-1.5">
                                        <div class="h-1.5 rounded-full bg-pink-500 transition-all duration-500" style="width: ${femalePercent}%"></div>
                                    </div>
                                </div>
                                ${other > 0 ? `
                                <!-- Other -->
                                <div>
                                    <div class="flex justify-between text-xs mb-1">
                                        <span class="text-gray-600">Other</span>
                                        <span class="font-bold text-gray-900">${other.toLocaleString()} (${otherPercent}%)</span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-1.5">
                                        <div class="h-1.5 rounded-full bg-purple-500 transition-all duration-500" style="width: ${otherPercent}%"></div>
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                        `;
                    });
                    
                    tableHTML += '</div>';
                    ageGenderTableDiv.innerHTML = tableHTML;
                    console.log('Age gender table created successfully (mobile)');
                }
            } else {
                if (ageCtxElement) {
                    console.log('No age data to display');
                }
                if (ageGenderTableDiv) {
                    ageGenderTableDiv.innerHTML = '<p class="text-gray-500 text-center py-8 text-sm">No age data to display</p>';
                }
            }

            // Gender chart
            const genderCtxElement = document.getElementById('genderChart');
            console.log('Gender chart element:', genderCtxElement);
            
            if (!genderCtxElement) {
                console.error('ERROR: genderChart canvas element not found!');
            } else {
                const genderCtx = genderCtxElement.getContext('2d');
                if (genderChart) genderChart.destroy();
                
                if (genderData.length > 0) {
                    console.log('Creating gender chart with data:', genderData);
                    genderChart = new Chart(genderCtx, {
                    type: 'pie',
                    data: {
                        labels: genderData.map(([gender]) => gender),
                        datasets: [{
                            data: genderData.map(([_, steps]) => steps),
                            backgroundColor: ['#3b82f6', '#ef4444', '#10b981']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
                console.log('Gender chart created successfully');
            } else {
                console.log('No gender data to display');
            }
        }
        
        console.log('=== ALL CHARTS RENDERED ===');
        }, renderDelay);
    }

        // Update fun stats
        function updateFunStats(totalSteps) {
            // Constants
            const AVG_STRIDE_M = 0.762;  // Average stride length in meters
            const SOCIETY_PERIMETER_M = 440;  // Apostrophe society perimeter
            const MUMBAI_DELHI_KM = 1411;  // Mumbai to Delhi distance
            const SPACE_BOUNDARY_KM = 100;  // K√°rm√°n line (space boundary)
            const CALORIES_PER_STEP = 0.05;  // Average calories per step
            const CO2_PER_KM = 0.2;  // CO2 saved per km (vs driving) in kg
            const TREE_CO2_PER_YEAR = 21.8;  // CO2 absorbed by one tree per year in kg
            
            // Calculate distance
            const totalDistanceM = totalSteps * AVG_STRIDE_M;
            const totalDistanceKm = totalDistanceM / 1000;
            
            // Calculate each stat
            const distanceKm = totalDistanceKm.toFixed(0);
            const societyLoops = Math.floor(totalDistanceM / SOCIETY_PERIMETER_M).toLocaleString();
            const mumbaiDelhiPercent = (totalDistanceKm / MUMBAI_DELHI_KM * 100).toFixed(1);
            const calories = Math.floor(totalSteps * CALORIES_PER_STEP).toLocaleString();
            const co2Saved = totalDistanceKm * CO2_PER_KM;
            const treesEquivalent = Math.floor(co2Saved / TREE_CO2_PER_YEAR);
            const spaceTrips = (totalDistanceKm / SPACE_BOUNDARY_KM).toFixed(1);
            
            // Update DOM
            document.getElementById('statDistance').textContent = distanceKm + ' km';
            document.getElementById('statLoops').textContent = societyLoops;
            document.getElementById('statIndia').textContent = mumbaiDelhiPercent + '%';
            document.getElementById('statCalories').textContent = calories;
            document.getElementById('statTrees').textContent = treesEquivalent;
            document.getElementById('statSpace').textContent = spaceTrips + '√ó';
        }

        // Toggle dashboard
        async function toggleDashboard() {
            const dashboard = document.getElementById('dashboard');
            const button = document.getElementById('toggleBtn');
            
            if (dashboard.classList.contains('hidden')) {
                dashboard.classList.remove('hidden');
                button.textContent = '‚ñ≤ Hide Community Dashboard';
                await loadData();
                loadDashboard();
            } else {
                dashboard.classList.add('hidden');
                button.textContent = '‚ñº View Community Dashboard';
            }
        }

        // Milestone celebrations
        const MILESTONES = [
            {
                steps: 500000,
                icon: 'üéØ',
                title: '500K Steps Reached!',
                message: 'Half a million steps! We\'re just getting started!',
                stats: ['381 km covered', '866 loops of Apostrophe', '27% to Mumbai']
            },
            {
                steps: 1000000,
                icon: 'üéä',
                title: '1 MILLION STEPS!',
                message: 'One million steps achieved! We\'ve walked to Mumbai!',
                stats: ['762 km covered', '1,732 loops of Apostrophe', '54% to Mumbai', '50,000 calories burned']
            },
            {
                steps: 2500000,
                icon: 'üèÜ',
                title: '2.5 Million Steps!',
                message: 'Quarter way to our goal! We\'ve crossed Mumbai-Delhi!',
                stats: ['1,905 km covered', '4,330 loops of Apostrophe', '135% to Mumbai', '125,000 calories burned']
            },
            {
                steps: 5000000,
                icon: 'ü•á',
                title: 'HALFWAY THERE!',
                message: '5 MILLION STEPS! We\'ve walked from Mumbai to Delhi and back!',
                stats: ['3,810 km covered', '8,659 loops of Apostrophe', '270% to Mumbai', '250,000 calories burned', '349 trees equivalent']
            },
            {
                steps: 7500000,
                icon: 'üåü',
                title: '7.5 Million Steps!',
                message: 'Three-quarters complete! The finish line is in sight!',
                stats: ['5,715 km covered', '12,989 loops of Apostrophe', '405% to Mumbai', '375,000 calories burned', '524 trees equivalent']
            },
            {
                steps: 10000000,
                icon: 'üåü',
                title: '10 Million Steps!',
                message: 'Halfway to our goal! Momentum is building! üöÄ',
                stats: ['7,620 km covered', '17,318 loops of Apostrophe', '540% to Mumbai', '500,000 calories burned', '698 trees equivalent']
            },
            {
                steps: 12500000,
                icon: 'üí™',
                title: '12.5 Million Steps!',
                message: '62.5% complete! Keep the energy high!',
                stats: ['9,525 km covered', '21,648 loops of Apostrophe', '675% to Mumbai', '625,000 calories burned', '873 trees equivalent']
            },
            {
                steps: 15000000,
                icon: 'üî•',
                title: '15 Million Steps!',
                message: 'Three-quarters done! The finish line is approaching! üéØ',
                stats: ['11,430 km covered', '25,977 loops of Apostrophe', '810% to Mumbai', '750,000 calories burned', '1,047 trees equivalent']
            },
            {
                steps: 17500000,
                icon: '‚≠ê',
                title: '17.5 Million Steps!',
                message: '87.5% complete! Final push to the goal!',
                stats: ['13,335 km covered', '30,307 loops of Apostrophe', '945% to Mumbai', '875,000 calories burned', '1,222 trees equivalent']
            },
            {
                steps: 20000000,
                icon: 'ü•≥',
                title: 'GOAL ACHIEVED!!!',
                message: '20 MILLION STEPS! WE DID IT TOGETHER! üéâüéâüéâ',
                stats: ['15,240 km covered', '34,636 loops of Apostrophe', '1,080% to Mumbai', '1,000,000 calories burned', '1,396 trees equivalent', '152 trips to space!']
            }
        ];

        function checkMilestones(totalSteps) {
            // Get previously shown milestones from localStorage
            const shownMilestones = JSON.parse(localStorage.getItem('shownMilestones') || '[]');
            
            // Find the highest milestone we've reached but haven't shown yet
            let milestoneToShow = null;
            for (let i = MILESTONES.length - 1; i >= 0; i--) {
                const milestone = MILESTONES[i];
                if (totalSteps >= milestone.steps && !shownMilestones.includes(milestone.steps)) {
                    milestoneToShow = milestone;
                    break;
                }
            }
            
            // Show milestone if found
            if (milestoneToShow) {
                showMilestone(milestoneToShow);
                // Mark as shown
                shownMilestones.push(milestoneToShow.steps);
                localStorage.setItem('shownMilestones', JSON.stringify(shownMilestones));
            }
        }

        function showMilestone(milestone) {
            // Update modal content
            document.getElementById('milestoneIcon').textContent = milestone.icon;
            document.getElementById('milestoneTitle').textContent = milestone.title;
            document.getElementById('milestoneMessage').textContent = milestone.message;
            
            // Build stats HTML
            const statsHTML = milestone.stats.map(stat => 
                `<div class="flex items-center gap-2 mb-2">
                    <span class="text-blue-600 text-xl">‚úì</span>
                    <span class="text-gray-700">${stat}</span>
                </div>`
            ).join('');
            document.getElementById('milestoneStats').innerHTML = statsHTML;
            
            // Show modal
            document.getElementById('milestoneModal').classList.remove('hidden');
            
            // Apply bounce animation to card
            const card = document.getElementById('milestoneCard');
            card.classList.add('bounce-once');
            
            // Remove animation class after it completes (0.6s)
            setTimeout(() => {
                card.classList.remove('bounce-once');
            }, 600);
            
            // Play celebration sound (optional - browser support varies)
            try {
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBTGH0fPTgjMGHm7A7+OZSA8PVKXi8bVjHQU2jdXzzn0pBSt+zPLaizsIGGS57OihUBELTqPh8bllHgU0itTz0H8rBSx+zPLajTsIF2W57OmgUREKTqPh8bllHgU0idTz0H8rBSx+zPLajTsIF2W57OmgURIJTqPh8bllHgU0idTz0H8rBSx+zPLajTsIF2W57OmgURIJTqPh8bllHgU0idTz0H8rBSx+zPLajTsIF2W57OmgURIJTqPh8bllHgU0idTz0H8rBSx+zPLajTsIF2W57OmgURIJTqPh8bllHgU0idTz0H8rBSx+zPLajTsIF2W57OmgURIJTqPh8bllHgU0idTz0H8rBSx+zPLajTsIF2W57OmgURIJTqPh8bllHgU0idTz0H8rBSx+zPLajTsIF2W57OmgURIJTqPh8bllHgU0idTz0H8rBSx+zPLajTsIF2W57OmgURIJTqPh8bllHgU0idTz0H8rBSx+zPLajTsIF2W57OmgURIJTqPh8bllHgU0idTz0H8rBSx+zPLajTsIF2W57OmgURIJTqPh8bllHgU0idTz0H8rBSx+zPLajTsIF2W57OmgURIJTqPh8bllHgU0idTz0H8rBSx+zPLajTsIF2W57OmgURIJTqPh8bllHgU0idTz0H8rBSx+zPLajTsIF2W57OmgURIJTqPh8bllHgU0idTz0H8rBSx+zPLajTsIF2W57OmgURIJTqPh8bllHgU0idTz0H8rBSx+zPLajTsIF2W57OmgURIJTqPh8bllHgU0idTz0H8rBSx+zPLajTsIF2W57OmgURIJTqPh8bllHgU0idTz0H8rBSx+zPLajTsIF2W57OmgURIJTqPh8bllHgU0idTz0H8rBSx+zPLajTsIF2W57OmgURIJTqPh8bllHgU0idTz0H8rBSx+zPLajTsIF2W57OmgURIJTqPh8bllHgU0idTz0H8rBSx+zPLajTsIF2W57OmgURIJTqPh8bllHgU0idTz0H8rBSx+zPLajTsIF2W57OmgURIJTqPh8bllHgU0idTz0H8rBSx+zPLajTsIF2W57OmgURIJTqPh8bllHgU0idTz0H8rBSx+zPLajTsIF2W57OmgURIJTqPh8bllHgU0idTz0H8rBQ==');
                audio.play().catch(() => {}); // Ignore if audio fails
            } catch (e) {
                // Audio not supported, ignore
            }
        }

        function closeMilestone() {
            document.getElementById('milestoneModal').classList.add('hidden');
        }

        // Initialize on page load
        window.onload = async function() {
            // Check if SCRIPT_URL is set
            if (SCRIPT_URL === 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE') {
                document.getElementById('setupNotice').classList.remove('hidden');
            } else {
                document.getElementById('setupNotice').classList.add('hidden');
            }
            
            setDefaultDate(); // Set date input to today
            await loadData();
            showView('submit');
        };
    </script>
</body>
</html>
